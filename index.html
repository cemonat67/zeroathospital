<!DOCTYPE html>
<html lang="tr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Zero@Hospital — Health Sustainability Passport</title>
  
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/jspdf@2.5.1/dist/jspdf.umd.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
  <style>
    :root{
      --green:#005530;
      --red:#D51635;
      --navy:#02154e;
      --orange:#f9ba00;
      --ink:#0A1D3D;
      --bg:#ffffff;
      --card:#121a31;
      --muted:#6b7280;
      --text:#e5e7eb;
      --soft:#e5e7eb;
      --zero-navy:#02154e;
      --zero-orange:#f9ba00;
      --zero-green:#005530;
      --zero-red:#D51635;
      --zero-white:#ffffff;
      --zero-black:#000000;
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0; font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Helvetica Neue', Arial, sans-serif;
      background: var(--bg);
      color:var(--ink);
      line-height: 1.6;
    }
    a{color:inherit; text-decoration:none}
    .wrap{max-width:1280px; margin:0 auto; padding:24px}

    /* ===== HERO (big header) ===== */
    .hero{padding:18px 0 8px; border-bottom:1px solid #d8dee9}
    .hero .t1{font-size:30px; font-weight:200; letter-spacing:-1px; margin:0 0 6px}
    .hero .row{display:flex; align-items:center; gap:10px; flex-wrap:wrap}
    .hero .badge{font-size:11px; padding:4px 10px; border-radius:999px; background:linear-gradient(90deg,var(--green),#0c8a53); color:white; font-weight:400; letter-spacing:0.5px; text-transform:uppercase}
    .hero .tag{color:#475569; font-size:13px; font-weight:300}

    header{
      display:flex; align-items:center; gap:16px; justify-content:space-between; padding:12px 0 8px;
    }
    .actions{display:flex; gap:8px; align-items:center; flex-wrap:wrap}
    .btn{background:var(--green); border:1px solid #0b7b49; color:#fff; padding:10px 16px; border-radius:8px; font-weight:500; cursor:pointer; font-size:14px; letter-spacing:0.3px; transition:all 0.3s ease}
    .btn:hover{background:#0b7b49; border-color:#0b7b49; transform:translateY(-1px)}
    .btn.orange{background:var(--green); color:#fff; border-color:#0b7b49}
    .btn.green{background:var(--green); color:#fff; border-color:#0b7b49}

    .select{background:#f8fafc; border:1px solid #e2e8f0; color:#111; padding:8px 10px; border-radius:8px; min-width:140px; font-weight:400; font-size:13px}
    .number,.input{background:#f8fafc; border:1px solid #e2e8f0; color:#111; padding:8px 10px; border-radius:8px; font-weight:400; font-size:13px}

    main{display:grid; grid-template-columns: 1.1fr .9fr; gap:16px; margin-top:16px; grid-auto-rows: 1fr; align-items:stretch}
    @media (max-width:1060px){ main{grid-template-columns:1fr} }

    .grid{display:grid; grid-template-columns: repeat(12, 1fr); gap:16px; margin-top:16px; grid-auto-rows: 1fr; align-items:stretch}

    .card{background:var(--card); border:1px solid #101827; border-radius:16px; padding:16px; box-shadow:0 4px 18px rgba(0,0,0,.08); overflow:hidden; display:flex; flex-direction:column}
    .card .fill{flex:1 1 auto}
    .card h3{margin:0 0 10px; font-size:13px; font-weight:300; color:#dbe2f1; letter-spacing:1.5px; text-transform:uppercase}
    .card h3{color:#ffffff}
    .kpis{display:grid; grid-template-columns:repeat(6,1fr); gap:12px}
    @media (max-width:1060px){ .kpis{grid-template-columns: repeat(2,1fr)} }
    .kpi{background:linear-gradient(180deg,#0f1730,#0c1429); border:1px solid rgba(255,255,255,.06); border-radius:14px; padding:14px; transition: box-shadow .2s ease}
    .kpi .label{font-size:12px; color:#cbd5e1; font-weight:300}
    .kpi .tr{font-size:11px; color:#94a3b8; font-weight:300}
    .kpi .value{font-size:22px; font-weight:200; margin-top:6px; color:#fff; letter-spacing:-1px}
    .kpi .delta{font-size:12px; margin-top:4px; color:#cbd5e1; font-weight:300}
    /* Alerts for KPI (CO2 threshold) */
    .kpi.alert{ background:linear-gradient(180deg,#3d0b16,#2a0a12); border-color:#7f1d1d; box-shadow:0 0 0 2px rgba(213,22,53,.35) inset }
    .kpi.alert .label, .kpi.alert .delta{ color:#fecaca }
    .kpi.alert .value{ color:#fff5f5 }

    .two-col{display:grid; grid-template-columns:1fr 1fr; gap:16px}
    @media (max-width:840px){ .two-col{grid-template-columns:1fr} }

    table{width:100%; border-collapse:separate; border-spacing:0 10px}
    .card table{margin:0}
    thead th{font-size:12px; text-align:left; color:#1f2937; font-weight:500; padding:0 10px; letter-spacing:1px; text-transform:uppercase}
    .card thead th{color:#ffffff}
    tbody tr{background:#f1f5f9; border:1px solid #e2e8f0}
    tbody td{padding:10px; font-size:13px; color:#0f172a}
    tbody tr{border-radius:10px}
    tbody tr td:first-child{border-top-left-radius:10px; border-bottom-left-radius:10px}
    tbody tr td:last-child{border-top-right-radius:10px; border-bottom-right-radius:10px}

    .pill{display:inline-flex; align-items:center; gap:6px; padding:4px 8px; border-radius:999px; font-size:11px; font-weight:500}
    .pill.ok{background:rgba(0,180,80,.12); color:#166534; border:1px solid rgba(22,101,52,.35)}
    .pill.warn{background:rgba(255,180,0,.12); color:#a16207; border:1px solid rgba(161,98,7,.35)}
    .pill.bad{background:rgba(213,22,53,.12); color:#9f1239; border:1px solid rgba(159,18,57,.35)}

    .muted{color:var(--muted)}
    .head-row{display:flex; align-items:center; justify-content:space-between; gap:12px}

    .quick{display:flex; gap:8px; flex-wrap:wrap}
    .quick .btn{background:var(--green); color:#fff; font-size:13px; padding:8px 14px}

    .calc{display:grid; grid-template-columns: 1.2fr .8fr; gap:12px}
    @media (max-width:840px){ .calc{grid-template-columns:1fr} }
    .form-row{display:grid; grid-template-columns:1fr 1fr; gap:8px}

    .footer{margin:28px 0 12px; text-align:center; color:#6b7280; font-size:12px}
    .link{color:#0369a1}

    /* Views */
    .views{margin-top:16px}
    .view{display:none}
    .view.active{display:block}

    /* Light view card */
    .light-card{background:#ffffff; border:1px solid #e2e8f0; color:#0f172a}
    .light-card h3{color:#0f172a}

    /* Big tabs above KPIs */
    .tabs-large{display:flex; gap:10px; align-items:center; flex-wrap:wrap; margin-top:16px; margin-bottom:8px}
    .tabs-large .tab{font-size:16px; padding:12px 18px; border-radius:999px; background:#eef2ff; border:2px solid #c7d2fe; cursor:pointer}
    .tabs-large .tab.active{background:#dbeafe; border-color:#93c5fd; box-shadow: inset 0 -2px 0 #93c5fd}
      /* ===== Tab bar v3 (segmented control) — OVERRIDE ===== */
    .tabs-large{ display:flex; align-items:center; gap:8px; padding:6px; margin-top:16px; margin-bottom:8px; flex-wrap: nowrap; overflow-x: auto }
    .tabs-large .segments{ display:flex; gap:8px; flex-wrap: nowrap; white-space: nowrap }
    .tabs-large .title{ color:var(--ink); font-weight:200; margin:0 8px 0 6px; letter-spacing:-1px }
    .tabs-large .tab{ appearance:none; background:var(--green); color:#fff; border:1px solid #0b7b49; padding:10px 16px; font-weight:500; cursor:pointer; margin:0; border-radius:8px; position:relative; display:flex; align-items:center; gap:8px; font-size:14px; letter-spacing:0.3px; transition:all 0.3s ease }
    .tabs-large .tab:first-of-type{ border-top-left-radius:8px; border-bottom-left-radius:8px }
    .tabs-large .tab:last-of-type{ border-top-right-radius:8px; border-bottom-right-radius:8px }
    .tabs-large .tab + .tab{ }
    .tabs-large .tab:hover{ background:#0b7b49; transform:translateY(-1px) }
    .tabs-large .tab.active{ background:#0b7b49; color:#fff; border-color:#0b7b49 }
    .tab-icon{ width:16px; height:16px; display:inline-block; }
    .zero-color-bar{height:4px; width:100%; background:linear-gradient(90deg, var(--zero-green) 0%, var(--zero-green) 25%, var(--zero-red) 25%, var(--zero-red) 50%, var(--zero-navy) 50%, var(--zero-navy) 75%, var(--zero-orange) 75%, var(--zero-orange) 100%); position:fixed; top:0; left:0; z-index:1000}
    .app-header{background:var(--zero-navy); color:var(--zero-white); padding:12px 0; box-shadow:0 2px 10px rgba(0,0,0,0.1)}
    .header-content{width:100%; margin:0; padding:0 24px; display:flex; align-items:center; justify-content:flex-start; gap:12px}
    .zero-production-logo{height:28px}
    .title{font-weight:300; font-size:16px; color:var(--zero-white); letter-spacing:0.5px}
    .brand-word{font-weight:200; letter-spacing:-0.5px}
    .title-at{color:var(--zero-orange)}
    .chat-toggle{position:fixed; bottom:12px; left:12px; background:var(--green); color:#fff; border:none; border-radius:24px; padding:12px 18px; font-weight:500; box-shadow:0 6px 16px rgba(0,0,0,0.25); z-index:1001; font-size:14px; letter-spacing:0.3px; transition:all 0.3s ease}
    .chat-toggle:hover{background:#0b7b49; color:#fff; transform:translateY(-2px); box-shadow:0 8px 20px rgba(0,0,0,0.3)}
    .chat-drawer{position:fixed; bottom:60px; left:12px; width:360px; max-height:70vh; background:var(--zero-white); border:1px solid #e2e8f0; border-radius:12px; box-shadow:0 12px 40px rgba(0,0,0,0.2); display:none; flex-direction:column; z-index:1001}
    .chat-drawer.active{display:flex}
    .chat-header{padding:10px; background:var(--zero-navy); color:var(--zero-white); display:flex; gap:8px; align-items:center}
    .chat-body{padding:10px; overflow-y:auto; flex:1}
    .chat-msg{margin-bottom:8px; font-size:13px}
    .chat-msg .role{display:inline-block; min-width:72px; font-weight:500; color:var(--zero-orange)}
    .chat-controls{padding:10px; border-top:1px solid #e2e8f0; display:flex; gap:8px; align-items:center; flex-wrap:wrap}
    .chat-input{flex:1}
  </style>
</head>
<body>
  <div class="zero-color-bar"></div>
  <header class="app-header">
    <div class="header-content">
      <img id="appLogo" src="images/zah_logo.PNG" alt="Zero@Hospital Logo" class="zero-production-logo">
      <div class="title"><span class="brand-word">Zero<span class="title-at">@</span>Hospital</span> — Health Sustainability Passport</div>
    </div>
  </header>
  <div class="wrap">
    <!-- ===== HERO ===== -->
    <div class="hero">
      <h1 id="heroTitle" class="t1">Zero@Hospital — Health Sustainability Passport</h1>
      <div class="row">
        <span id="badgeDemo" class="badge">Demo</span>
        <span id="heroTag" class="tag">Emissions and carbon footprint tracking for hospitals</span>
      </div>
    </div>

    <header>
      <div class="actions">
        <button id="backBtn" class="btn">← Back</button>
        <button id="resetBtn" class="btn">Reset Filters</button>
        <button id="loadPilotBtn" class="btn">İzmir Pilot</button>
        <button id="loadHspDemoBtn" class="btn">HSP Demo</button>
        <button id="importCsvBtn" class="btn">Import HSP CSV</button>
        <span id="pilotMsg" class="muted"></span>
        <button id="exportCsvBtn" class="btn">Export CSV</button>
        <button id="exportPdfBtn" class="btn">Export PDF</button>
        <button id="exportXlsxBtn" class="btn">Export Excel</button>
        <button id="zoomBtn" class="btn">%100 Zoom</button>
        <span id="envBadge" class="pill ok" style="margin-left:8px">ENV</span>
        <span id="apiMsg" class="pill bad" style="margin-left:8px; display:none">Local API required</span>
        <a href="#taxonomy-section" class="btn">EU Taxonomy & Green Deal</a>
      </div>
      <div class="actions">
        <select id="yearSel" class="select"></select>
        <select id="hospSel" class="select"></select>
        <select id="deptSel" class="select"></select>
        <select id="langSel" class="select">
          <option value="en">English</option>
          <option value="tr">Türkçe</option>
        </select>
        <input id="loginUser" class="input" placeholder="User" style="width:120px" />
        <input id="loginPass" class="input" type="password" placeholder="Password" style="width:120px" />
        <button id="loginBtn" class="btn green">Login</button>
        <button id="logoutBtn" class="btn">Logout</button>
      </div>
    </header>

    <!-- ===== Big tabs placed above KPIs ===== -->
    <div class="tabs-large">
      <div class="segments">
        <button id="tabMainBtn" class="tab active"><span class="tab-icon"><svg viewBox="0 0 24 24" width="16" height="16"><path fill="currentColor" d="M12 3l9 8v10h-6v-6H9v6H3V11z"/></svg></span> Main</button>
        <button id="tabLiveBtn" class="tab"><span class="tab-icon"><svg viewBox="0 0 24 24" width="16" height="16"><path fill="currentColor" d="M3 19h18v2H3zM5 17l4-6 4 4 6-8v8H5z"/></svg></span> Live</button>
        <button id="tabScopesBtn" class="tab"><span class="tab-icon"><svg viewBox="0 0 24 24" width="16" height="16"><path fill="currentColor" d="M12 2a10 10 0 100 20 10 10 0 000-20zm0 3l2 5 5 2-5 2-2 5-2-5-5-2 5-2z"/></svg></span> Scopes</button>
        <button id="tabAlertsBtn" class="tab"><span class="tab-icon"><svg viewBox="0 0 24 24" width="16" height="16"><path fill="currentColor" d="M12 22a2 2 0 002-2H10a2 2 0 002 2zm6-6V9a6 6 0 10-12 0v7l-2 2v1h16v-1z"/></svg></span> Alerts</button>
        <button id="tabActionsBtn" class="tab"><span class="tab-icon"><svg viewBox="0 0 24 24" width="16" height="16"><path fill="currentColor" d="M9 16.2l-3.5-3.5L4 14.2l5 5 11-11-1.4-1.4z"/></svg></span> Actions</button>
        <button id="tabDeptsBtn" class="tab"><span class="tab-icon"><svg viewBox="0 0 24 24" width="16" height="16"><path fill="currentColor" d="M12 2l7 4v6c0 3.9-3.1 7-7 7s-7-3.1-7-7V6l7-4zm0 7a3 3 0 110 6 3 3 0 010-6z"/></svg></span> Departments</button>
        <button id="tabComplianceBtn" class="tab"><span class="tab-icon"><svg viewBox="0 0 24 24" width="16" height="16"><path fill="currentColor" d="M6 2h9l5 5v15H6zM15 2v5h5"/></svg></span> Compliance</button>
        <button id="tabDataBtn" class="tab"><span class="tab-icon"><svg viewBox="0 0 24 24" width="16" height="16"><path fill="currentColor" d="M10 4l-2 2H4v14h16V6h-6l-2-2z"/></svg></span> Data</button>
        <button id="tabSessionsBtn" class="tab"><span class="tab-icon"><svg viewBox="0 0 24 24" width="16" height="16"><path fill="currentColor" d="M4 6h16v3H4zM4 11h16v3H4zM4 16h16v3H4z"/></svg></span> Sessions</button>
        <button id="tabDeptDashBtn" class="tab"><span class="tab-icon"><svg viewBox="0 0 24 24" width="16" height="16"><path fill="currentColor" d="M3 3h18v4H3zM3 9h12v4H3zM3 15h8v4H3z"/></svg></span> Dept Dashboard</button>
        <button id="tabSettingsBtn" class="tab"><span class="tab-icon"><svg viewBox="0 0 24 24" width="16" height="16"><path fill="currentColor" d="M12 8a4 4 0 100 8 4 4 0 000-8zm8.94 4a8.94 8.94 0 01-.21 2l2.11 1.65-2 3.46-2.55-.5a9.06 9.06 0 01-1.73 1l-.4 2.56H10.84l-.4-2.56a9.06 9.06 0 01-1.73-1l-2.55.5-2-3.46L6.27 14a8.94 8.94 0 01-.21-2 8.94 8.94 0 01.21-2L4.16 8.35l2-3.46 2.55.5a9.06 9.06 0 011.73-1l.4-2.56h3.9l.4 2.56a9.06 9.06 0 011.73 1l2.55-.5 2 3.46-2.11 1.65c.14.66.21 1.34.21 2z"/></svg></span> Settings</button>
        <button id="tabOpsBtn" class="tab"><span class="tab-icon"><svg viewBox="0 0 24 24" width="16" height="16"><path fill="currentColor" d="M4 4h16v4H4zm0 6h16v10H4z"/></svg></span> Ops</button>
        <button id="tabClinicalBtn" class="tab"><span class="tab-icon"><svg viewBox="0 0 24 24" width="16" height="16"><path fill="currentColor" d="M12 2a5 5 0 015 5v2h3a2 2 0 012 2v9a2 2 0 01-2 2H4a2 2 0 01-2-2v-9a2 2 0 012-2h3V7a5 5 0 015-5zm-3 7h6V7a3 3 0 10-6 0v2z"/></svg></span> Clinical</button>
        <button id="tabJourneyBtn" class="tab"><span class="tab-icon"><svg viewBox="0 0 24 24" width="16" height="16"><path fill="currentColor" d="M4 4h16v2H4zm0 7h16v2H4zm0 7h16v2H4z"/></svg></span> Journey</button>
        <button id="tabBenchmarkBtn" class="tab"><span class="tab-icon"><svg viewBox="0 0 24 24" width="16" height="16"><path fill="currentColor" d="M3 3h6v18H3zm6 12h6v6H9zm6-6h6v12h-6z"/></svg></span> Benchmark</button>
        <button id="tabProcBtn" class="tab"><span class="tab-icon"><svg viewBox="0 0 24 24" width="16" height="16"><path fill="currentColor" d="M4 6h16v3H4zM4 11h16v3H4zM4 16h16v3H4z"/></svg></span> Procurement</button>
        <button id="tabDrugsBtn" class="tab"><span class="tab-icon"><svg viewBox="0 0 24 24" width="16" height="16"><path fill="currentColor" d="M12 2a7 7 0 017 7v7a7 7 0 11-14 0V9a7 7 0 017-7zm0 4a3 3 0 00-3 3v7a3 3 0 106 0V9a3 3 0 00-3-3z"/></svg></span> Drugs</button>
        <button id="tabCarbonBtn" class="tab"><span class="tab-icon"><svg viewBox="0 0 24 24" width="16" height="16"><path fill="currentColor" d="M12 2a10 10 0 100 20 10 10 0 000-20zm-3 11h6v2H9v-2zm0-4h8v2H9V9z"/></svg></span> Carbon Market</button>
        <button id="tabInsuranceBtn" class="tab"><span class="tab-icon"><svg viewBox="0 0 24 24" width="16" height="16"><path fill="currentColor" d="M4 4h16v4H4zm0 6h16v10H4z"/></svg></span> Insurance</button>
        <button id="tabWasteBtn" class="tab"><span class="tab-icon"><svg viewBox="0 0 24 24" width="16" height="16"><path fill="currentColor" d="M3 3h18v4H3zm0 6h18v4H3zm0 6h18v4H3z"/></svg></span> Waste AI</button>
        <button id="tabPandemicBtn" class="tab"><span class="tab-icon"><svg viewBox="0 0 24 24" width="16" height="16"><path fill="currentColor" d="M12 2a10 10 0 100 20 10 10 0 000-20zm-5 9h10v2H7z"/></svg></span> Pandemic</button>
        <button id="tabTwinBtn" class="tab"><span class="tab-icon"><svg viewBox="0 0 24 24" width="16" height="16"><path fill="currentColor" d="M4 4h8v8H4zM12 12h8v8h-8z"/></svg></span> Twin</button>
        <button id="tabCampusBtn" class="tab"><span class="tab-icon"><svg viewBox="0 0 24 24" width="16" height="16"><path fill="currentColor" d="M3 11l9-8 9 8v10H3z"/></svg></span> Campus</button>
        <button id="tabFinanceBtn" class="tab"><span class="tab-icon"><svg viewBox="0 0 24 24" width="16" height="16"><path fill="currentColor" d="M3 3h18v6H3zm0 8h18v10H3z"/></svg></span> Finance</button>
        <button id="tabTaxonomyBtn" class="tab"><span class="tab-icon"><svg viewBox="0 0 24 24" width="16" height="16"><path fill="currentColor" d="M12 2l9 4-9 4-9-4 9-4zm0 10l9 4-9 4-9-4 9-4z"/></svg></span> Taxonomy</button>
        <button id="tabConnectorsBtn" class="tab"><span class="tab-icon"><svg viewBox="0 0 24 24" width="16" height="16"><path fill="currentColor" d="M5 4h4v6H5zm10 0h4v6h-4zM5 14h4v6H5zm10 0h4v6h-4z"/></svg></span> Connectors</button>
        <button id="tabRadarBtn" class="tab"><span class="tab-icon"><svg viewBox="0 0 24 24" width="16" height="16"><path fill="currentColor" d="M12 2a10 10 0 100 20 10 10 0 000-20zm1 5h4v2h-4V7zM7 11h10v2H7v-2zm2 4h6v2H9v-2z"/></svg></span> Radar</button>
        <button id="tabCfoSaveBtn" class="tab">CFO Savings</button>
        <button id="tabRiskMatrixBtn" class="tab">CEO Risk</button>
        <button id="tabProjectsBtn" class="tab">Projects</button>
      </div>
    </div>

    <div class="views">
      <!-- ======== MAIN VIEW ======== -->
      <div id="mainView" class="view active">
        <section class="card" style="margin-top:8px">
          <div class="head-row">
            <h3 id="lblKpiTitle">Key Performance Indicators</h3>
            <div class="quick">
              <button id="addSampleBtn" class="btn orange">Add Sample Record</button>
              <button id="openAddModalBtn" class="btn green">+ New Entry</button>
            </div>
          </div>
          <div class="kpis" id="kpis"></div>
        </section>

        <main>
          <section class="card">
            <div class="two-col">
              <div>
                <h3 id="lblEnergyByDept">Energy by Department (kWh)</h3>
                <canvas id="energyChart" height="180"></canvas>
              </div>
              <div>
                <h3 id="lblWasteComp">Waste Composition (kg)</h3>
                <canvas id="wasteChart" height="180"></canvas>
              </div>
            </div>
            <div style="margin-top:16px">
              <h3 id="lblMonthlyCO2">Monthly CO₂e Trend (tCO₂e)</h3>
              <canvas id="co2Chart" height="160"></canvas>
            </div>
          </section>

          <section class="card">
            <div class="head-row">
              <h3 id="lblRecordsFiltered">Records (Filtered)</h3>
              <div class="muted" id="countLabel"></div>
            </div>
            <div style="overflow:auto; max-height:480px; margin-top:8px">
              <table>
                <thead>
                  <tr>
                    <th>Year</th>
                    <th>Hospital</th>
                    <th>Department</th>
                    <th>Energy (kWh)</th>
                    <th>Water (m³)</th>
                    <th>Waste (kg)</th>
                    <th>Med. Waste (kg)</th>
                    <th>CO₂e (t)</th>
                    <th>Renewables %</th>
                    <th>Recycling %</th>
                    <th>Status</th>
                  </tr>
                </thead>
                <tbody id="tbody"></tbody>
              </table>
            </div>
          </section>
        </main>

        <section class="grid">
          <div class="card" style="grid-column: span 7">
            <div class="head-row">
              <h3 id="lblEstimator">International Patient Travel — CO₂ Estimator</h3>
              <span class="muted" id="lblEstimatorNote">Demo only · Economy factor ≈ 0.115 kg CO₂ / pax·km</span>
            </div>
            <div class="calc" style="margin-top:8px">
              <div>
                <div class="form-row">
                  <select class="select" id="routeSel"></select>
                  <input id="patientsInput" class="number" type="number" min="1" value="1" placeholder="# Patients" />
                </div>
                <div class="form-row" style="margin-top:8px">
                  <select class="select" id="tripTypeSel">
                    <option value="oneway">One-way</option>
                    <option value="return" selected>Return</option>
                  </select>
                  <select class="select" id="radiusFactorSel">
                    <option value="1">No RF (×1.0)</option>
                    <option value="1.9" selected>With RF (×1.9)</option>
                  </select>
                </div>
                <div style="margin-top:12px; display:flex; gap:8px; flex-wrap:wrap">
                  <button id="calcBtn" class="btn green">Calculate</button>
                  <button id="clearCalcBtn" class="btn">Clear</button>
                </div>
                <div class="muted" id="calcNote" style="margin-top:10px"></div>
              </div>
              <div>
                <div class="kpi" id="calcKpi">
                  <div class="label"><span id="lblEstCo2">Estimated CO₂e (t)</span><div class="tr" id="lblEstCo2Tr">Tahmini CO₂e (ton)</div></div>
                  <div id="calcValue" class="value">0.000</div>
                  <div class="delta muted" id="calcDetails">—</div>
                </div>
              </div>
            </div>
          </div>
          <div class="card" style="grid-column: span 5">
            <h3>Compliance Snapshot</h3>
            <div style="display:grid; grid-template-columns:1fr 1fr; gap:10px; margin-top:8px">
              <div class="kpi">
                <div class="label">GDPR Readiness<div class="tr">GDPR Hazırlığı</div></div>
                <div class="value">On Track</div>
                <div class="delta"><span class="pill ok">DPO Assigned</span></div>
              </div>
              <div class="kpi">
                <div class="label">Cross-Border Care (2011/24/EU)<div class="tr">Sınır Ötesi Sağlık</div></div>
                <div class="value">Compliant</div>
                <div class="delta"><span class="pill ok">Pricing & Epikrisis</span></div>
              </div>
              <div class="kpi">
                <div class="label">Accreditation<div class="tr">Akreditasyon</div></div>
                <div class="value">JCI / TEMOS</div>
                <div class="delta"><span class="pill warn">Renewal due in 6 mo</span></div>
              </div>
              <div class="kpi">
                <div class="label">CSRD Applicability<div class="tr">CSRD Kapsamı</div></div>
                <div class="value">Threshold Check</div>
                <div class="delta"><span class="pill warn">Size-based</span></div>
              </div>
            </div>
            <div class="muted" style="margin-top:8px">Configure these flags to match each hospital's reality. They are placeholders for the demo.</div>
          </div>
        </section>
      </div>

      <!-- ======== LIVE VIEW ======== -->
      <div id="liveView" class="view">
        <section class="light-card card">
          <div class="head-row">
            <h3 id="lblLiveMetrics">Live Metrics (Demo) — Anlık Göstergeler</h3>
            <div style="display:flex; gap:8px; align-items:center; flex-wrap:wrap">
              <label class="muted"><span id="lblInterval">Interval</span>
                <select id="liveIntervalSel" class="select">
                  <option value="5000">5s</option>
                  <option value="10000">10s</option>
                  <option value="60000">60s (1 dk)</option>
                </select>
              </label>
              <label class="muted"><span id="lblWindow">Window</span>
                <input id="liveWindowInput" class="number" type="number" min="5" max="120" value="15" style="width:80px" />
              </label>
              <button id="liveStartBtn" class="btn green">Start</button>
              <button id="liveStopBtn" class="btn">Stop</button>
            </div>
          </div>

          <div class="kpis" id="liveKpis" style="margin-top:8px">
            <div class="kpi"><div class="label">Total CO₂e (t)<div class="tr">Toplam CO₂e (ton)</div></div><div id="liveCo2" class="value">—</div><div class="delta">Δ/min</div></div>
            <div class="kpi"><div class="label">Energy (kWh)<div class="tr">Enerji (kWh)</div></div><div id="liveEnergy" class="value">—</div><div class="delta">Δ/min</div></div>
            <div class="kpi"><div class="label">Water (m³)<div class="tr">Su (m³)</div></div><div id="liveWater" class="value">—</div><div class="delta">Δ/min</div></div>
            <div class="kpi"><div class="label">15 records<div class="tr">15 kayıt</div></div><div id="liveRecords" class="value">15</div><div class="delta">window</div></div>
            <div class="kpi"><div class="label">Waste (kg)<div class="tr">Atık (kg)</div></div><div id="liveWaste" class="value">—</div><div class="delta">Δ/min</div></div>
            <div class="kpi"><div class="label">Medical Waste (kg)<div class="tr">Tıbbi Atık (kg)</div></div><div id="liveMedw" class="value">—</div><div class="delta">Δ/min</div></div>
            <div class="kpi"><div class="label">Renewables / Recycling<div class="tr">Yenilenebilir / Geri Dönüşüm</div></div><div id="liveRenRec" class="value">— / —</div><div class="delta">avg %</div></div>
          </div>

          <div style="margin-top:16px">
          <h3 id="lblMinuteTrend">Minute Trend — Dakikalık Trend</h3>
          <canvas id="liveChart" height="170"></canvas>
            <div class="muted" style="margin-top:6px">Legend is clickable. Axes: CO₂e (left y1), Energy & Water (right y2), Waste (right y3), MedWaste (right y4).</div>
          </div>
        </section>
      </div>

      <!-- ======== SCOPES VIEW ======== -->
      <div id="scopesView" class="view">
        <section class="card">
          <div class="head-row">
            <h3>Scope 1 / 2 / 3 Breakdown</h3>
            <div class="muted">Demo split for illustration</div>
          </div>
          <div class="two-col">
            <div>
              <canvas id="scopesChart" height="190"></canvas>
            </div>
            <div>
              <div class="kpis">
                <div class="kpi"><div class="label">Scope 1</div><div id="scope1Val" class="value">—</div><div class="delta">Direct</div></div>
                <div class="kpi"><div class="label">Scope 2</div><div id="scope2Val" class="value">—</div><div class="delta">Purchased Electricity</div></div>
                <div class="kpi"><div class="label">Scope 3</div><div id="scope3Val" class="value">—</div><div class="delta">Value Chain</div></div>
              </div>
            </div>
          </div>
        </section>
      </div>

      <!-- ======== ALERTS VIEW ======== -->
      <div id="alertsView" class="view">
        <section class="light-card card">
          <div class="head-row">
            <h3>Alert Rules</h3>
            <div style="display:flex;gap:8px;align-items:center">
              <input id="apiKeyInput" class="input" placeholder="API Key" style="min-width:180px" />
              <button id="loadAlertsBtn" class="btn green">Load</button>
              <button id="evaluateAlertsBtn" class="btn">Evaluate</button>
              <button id="alertsCreateTasksBtn" class="btn orange">Create Tasks</button>
            </div>
          </div>
          <div style="display:grid;grid-template-columns:1fr 1fr;gap:12px">
            <div>
              <div class="muted">Existing Rules</div>
              <div id="alertsList" style="margin-top:8px"></div>
              <div class="muted" style="margin-top:8px">Triggered</div>
              <div id="alertsTriggers" style="margin-top:8px"></div>
            </div>
            <div>
              <div class="muted">New Rule</div>
              <div class="form-row" style="margin-top:6px">
                <input id="newRuleName" class="input" placeholder="Name" />
                <input id="newRuleExpr" class="input" placeholder="Expression e.g. co2 > 500" />
              </div>
              <div style="margin-top:8px;display:flex;gap:8px">
                <button id="addRuleBtn" class="btn orange">Add Rule</button>
              </div>
              <div id="alertsMsg" class="muted" style="margin-top:8px"></div>
            </div>
          </div>
        </section>
      </div>

      <!-- ======== ACTIONS VIEW ======== -->
      <div id="actionsView" class="view">
        <section class="light-card card">
          <div class="head-row">
            <h3>Actions & Tasks</h3>
            <div class="muted">Log and review recent actions</div>
          </div>
          <div style="display:grid;grid-template-columns:1fr 1fr;gap:12px">
            <div>
              <div class="form-row">
                <input id="actionText" class="input" placeholder="Action description" />
                <input id="actionMeta" class="input" placeholder='Meta JSON e.g. {"dept":"OR"}' />
              </div>
              <div style="margin-top:8px;display:flex;gap:8px">
                <button id="logActionBtn" class="btn green">Log Action</button>
              </div>
              <div class="muted" style="margin-top:16px">New Task</div>
              <div class="form-row" style="margin-top:6px">
                <input id="taskTitle" class="input" placeholder="Title" />
                <input id="taskDept" class="input" placeholder="Dept" />
              </div>
              <div class="form-row" style="margin-top:6px">
                <input id="taskAssignee" class="input" placeholder="Assignee" />
                <input id="taskSla" class="input" placeholder="SLA Due ISO e.g. 2025-12-31" />
              </div>
              <div style="margin-top:8px;display:flex;gap:8px">
                <button id="createTaskBtn" class="btn orange">Create Task</button>
              </div>
            </div>
            <div>
              <div class="muted">Recent</div>
              <div id="actionsList" style="margin-top:8px"></div>
              <div class="muted" style="margin-top:16px">Tasks</div>
              <div id="tasksList" style="margin-top:8px"></div>
            </div>
          </div>
        </section>
      </div>

      <!-- ======== DEPARTMENTS VIEW ======== -->
      <div id="deptsView" class="view">
        <section class="light-card card">
          <div class="head-row">
            <h3>Department Targets</h3>
            <div style="display:flex;gap:8px;align-items:center">
              <button id="applyTargetsBtn" class="btn orange">Apply as Alert Rules</button>
              <button id="viewDeptTasksBtn" class="btn">View Dept Tasks</button>
              <div id="targetsMsg" class="muted"></div>
            </div>
          </div>
          <div style="overflow:auto; max-height:420px; margin-top:8px">
            <table>
              <thead>
                <tr>
                  <th>Department</th>
                  <th>CO₂e Target (t)</th>
                  <th>Energy Target (kWh)</th>
                  <th>Water Target (m³)</th>
                  <th>Renewables Target (%)</th>
                  <th>Recycling Target (%)</th>
                </tr>
              </thead>
              <tbody id="targetsBody"></tbody>
            </table>
          </div>
        </section>
      </div>

      <!-- ======== COMPLIANCE VIEW ======== -->
      <div id="complianceView" class="view">
        <section class="light-card card">
          <div class="head-row">
            <h3>Compliance Center</h3>
            <div style="display:flex;gap:8px;align-items:center">
              <button id="exportCompliancePdfBtn" class="btn green">Export PDF</button>
              <div class="muted">CSRD · ISO 14001 · JCI/TEMOS</div>
              <button id="exportCsrdPdfBtn" class="btn">Export CSRD</button>
              <button id="exportIsoPdfBtn" class="btn">Export ISO 14001</button>
              <button id="exportJciPdfBtn" class="btn">Export JCI/TEMOS</button>
            </div>
          </div>
          <div class="kpis" id="complianceKpis" style="margin-top:8px"></div>
          <div style="margin-top:12px; display:grid; grid-template-columns:1fr 1fr; gap:12px">
            <div>
              <div class="muted">Report Scheduler</div>
              <div class="form-row" style="margin-top:6px">
                <select id="schedTemplate" class="select"><option value="csrd">CSRD</option><option value="iso">ISO 14001</option><option value="jci">JCI/TEMOS</option></select>
                <select id="schedFreq" class="select"><option value="weekly">Weekly</option><option value="daily">Daily</option><option value="monthly">Monthly</option></select>
              </div>
              <div class="form-row" style="margin-top:6px">
                <input id="schedNext" class="input" placeholder="Next run ISO date e.g. 2025-12-31" />
              </div>
              <div style="margin-top:8px; display:flex; gap:8px">
                <button id="createScheduleBtn" class="btn green">Create Schedule</button>
                <button id="listSchedulesBtn" class="btn">Refresh</button>
                <button id="runReportNowBtn" class="btn">Run Now</button>
              </div>
              <div id="schedulesMsg" class="muted" style="margin-top:8px"></div>
            </div>
            <div>
              <div class="muted">Reports</div>
              <div id="reportsList" style="margin-top:8px"></div>
          <div style="margin-top:12px">
            <div class="muted">ESRS Gap Analysis</div>
            <div style="margin-top:6px;display:flex;gap:8px">
              <button id="exportEsrsGapPdfBtn" class="btn">Export ESRS Gap PDF</button>
              <select id="esrsGrpSel" class="select" style="max-width:160px"></select>
              <button id="emailEsrsGapBtn" class="btn">Email ESRS Gap</button>
              <button id="serverEsrsPdfBtn" class="btn">Server ESRS PDF</button>
              <button id="serverDnshPdfBtn" class="btn">Server DNSH PDF</button>
              <button id="serverCeoPdfBtn" class="btn">CEO View PDF</button>
              <button id="serverCfoPdfBtn" class="btn">CFO View PDF</button>
            </div>
          </div>
          <div style="margin-top:12px">
            <div class="muted">SBTi Trajectory</div>
            <div class="form-row" style="margin-top:6px">
              <input id="sbtiBase" class="input" placeholder="Base CO₂e (t)" />
              <input id="sbtiStart" class="input" placeholder="Start Year" />
            </div>
            <div class="form-row" style="margin-top:6px">
              <input id="sbtiTargetYear" class="input" placeholder="Target Year" />
              <input id="sbtiTargetPct" class="input" placeholder="Target Reduction %" />
            </div>
            <div style="margin-top:6px;display:flex;gap:8px">
              <button id="calcSbtiBtn" class="btn">Calculate SBTi</button>
            </div>
            <div id="sbtiMsg" class="muted" style="margin-top:8px"></div>
          </div>
          <div style="margin-top:12px">
            <div class="muted">Finance Simulation (ROI)</div>
            <div class="form-row" style="margin-top:6px">
              <input id="roiCost" class="input" placeholder="Investment cost (€)" />
              <input id="roiSavedKwh" class="input" placeholder="Energy saved (kWh/year)" />
            </div>
            <div class="form-row" style="margin-top:6px">
              <input id="roiPriceKwh" class="input" placeholder="Energy price (€/kWh)" />
            </div>
            <div style="margin-top:6px;display:flex;gap:8px">
              <button id="calcRoiBtn" class="btn">Calculate ROI</button>
            </div>
            <div id="roiMsg" class="muted" style="margin-top:8px"></div>
          </div>
              <div style="margin-top:12px">
                <div class="muted">DNSH Checklist</div>
                <div class="form-row" style="margin-top:6px">
                  <input id="dnshArea" class="input" placeholder="Area (Water/Biodiversity/Pollution/Circular)" />
                  <input id="dnshName" class="input" placeholder="Requirement" />
                </div>
                <div class="form-row" style="margin-top:6px">
                  <select id="dnshStatus" class="select"><option value="pending">Pending</option><option value="in_progress">In Progress</option><option value="done">Done</option></select>
                  <input id="dnshOwner" class="input" placeholder="Owner" />
                </div>
                <div class="form-row" style="margin-top:6px">
                  <input id="dnshDue" class="input" placeholder="Due ISO date" />
                </div>
                <div style="margin-top:6px;display:flex;gap:8px">
                  <button id="saveDnshBtn" class="btn">Save DNSH</button>
                  <button id="listDnshBtn" class="btn">Refresh DNSH</button>
                </div>
                <div id="dnshList" style="margin-top:8px"></div>
              </div>
            </div>
          </div>
        </section>
      </div>

      <!-- ======== DATA VIEW ======== -->
      <div id="dataView" class="view">
        <section class="light-card card">
          <div class="head-row">
            <h3>Data Provenance</h3>
            <div style="display:flex;gap:8px;align-items:center">
              <input id="fileInputData" type="file" />
              <button id="uploadFileBtn" class="btn green">Upload</button>
              <button id="listFilesBtn" class="btn">Refresh</button>
              <button id="syncDatasetBtn" class="btn">Sync Dataset</button>
              <button id="startStreamBtn" class="btn">Start Stream</button>
              <button id="stopStreamBtn" class="btn">Stop Stream</button>
            </div>
          </div>
          <div id="filesList" style="margin-top:8px"></div>
          <div id="filesMsg" class="muted" style="margin-top:8px"></div>
          <div id="streamBox" style="margin-top:8px"></div>
          <div style="margin-top:12px">
            <div class="muted">Predictive Failure</div>
            <div style="margin-top:6px;display:flex;gap:8px">
              <button id="runPredictBtn" class="btn">Run Prediction</button>
            </div>
            <div id="predictList" style="margin-top:8px"></div>
          </div>
          <div style="margin-top:12px">
            <div class="muted">Travel Emissions</div>
            <div class="form-row" style="margin-top:6px">
              <select id="travelMode" class="select"><option value="air">Air</option><option value="train">Train</option><option value="bus">Bus</option><option value="car">Car</option></select>
              <input id="travelKm" class="input" placeholder="Distance (km)" />
            </div>
            <div class="form-row" style="margin-top:6px">
              <input id="travelPassengers" class="input" placeholder="Passengers" />
              <input id="travelDept" class="input" placeholder="Dept (optional)" />
            </div>
            <div style="margin-top:6px;display:flex;gap:8px">
              <button id="calcTravelBtn" class="btn">Calculate</button>
              <button id="addTravelBtn" class="btn green">Add to Dataset</button>
            </div>
            <div id="travelMsg" class="muted" style="margin-top:8px"></div>
          </div>
          <div style="margin-top:12px">
            <div class="muted">Meter Readings</div>
            <div class="form-row" style="margin-top:6px">
              <input id="mrMeter" class="input" placeholder="Meter id" />
              <input id="mrValue" class="input" placeholder="Value" />
            </div>
            <div class="form-row" style="margin-top:6px">
              <input id="mrUnit" class="input" placeholder="Unit e.g. kWh" />
              <input id="mrHospital" class="input" placeholder="Hospital" />
            </div>
            <div class="form-row" style="margin-top:6px">
              <input id="mrDept" class="input" placeholder="Dept" />
            </div>
            <div style="margin-top:6px;display:flex;gap:8px">
              <button id="saveReadingBtn" class="btn">Save Reading</button>
              <button id="listReadingsBtn" class="btn">Refresh Readings</button>
            </div>
            <div id="readingsList" style="margin-top:8px"></div>
          </div>
        </section>
      </div>

      <!-- ======== SESSIONS VIEW ======== -->
      <div id="sessionsView" class="view">
        <section class="light-card card">
          <div class="head-row">
            <h3>Sessions</h3>
            <div style="display:flex;gap:8px;align-items:center">
              <button id="listSessionsBtn" class="btn">Refresh</button>
              <button id="saveDemoSessionBtn" class="btn green">Save Demo Session</button>
            </div>
          </div>
          <div id="sessionsList" style="margin-top:8px"></div>
          <div id="sessionsMsg" class="muted" style="margin-top:8px"></div>
        </section>
      </div>

      <!-- ======== DEPT DASH VIEW ======== -->
      <div id="deptdashView" class="view">
        <section class="light-card card">
          <div class="head-row">
            <h3>Department Dashboard</h3>
            <div class="muted">Uses current Hospital/Dept filters</div>
          </div>
          <div class="two-col">
            <div>
              <h3>KPIs</h3>
              <div id="deptKpis" class="kpis" style="margin-top:8px"></div>
            </div>
            <div>
              <h3>Monthly CO₂e</h3>
              <canvas id="deptCo2Chart" height="170"></canvas>
            </div>
          </div>
        </section>
      </div>

      <!-- ======== CLINICAL VIEW ======== -->
      <div id="clinicalView" class="view">
        <section class="light-card card">
          <div class="head-row">
            <h3>Clinical Pathway CO₂e</h3>
            <div class="muted">Procedure profiles, calculation and benchmarks</div>
          </div>
          <div style="display:grid;grid-template-columns:1fr 1fr;gap:12px">
            <div>
              <div class="muted">Procedure Profile</div>
              <div class="form-row" style="margin-top:6px">
                <input id="procName" class="input" placeholder="Name e.g. Appendectomy" />
                <input id="procDept" class="input" placeholder="Dept" />
              </div>
              <div class="form-row" style="margin-top:6px">
                <input id="procEnergy" class="input" placeholder="Baseline energy (kWh)" />
                <input id="procSterilFactor" class="input" placeholder="Sterilization kgCO₂e/cycle" />
              </div>
              <div class="form-row" style="margin-top:6px">
                <input id="procStaffFactor" class="input" placeholder="Staff kgCO₂e/hour" />
              </div>
              <div style="margin-top:6px">
                <textarea id="procConsumables" class="input" style="width:100%;min-height:80px" placeholder="Consumables CSV: item:kgCO₂e per unit"></textarea>
              </div>
              <div style="margin-top:8px;display:flex;gap:8px">
                <button id="saveProcProfileBtn" class="btn green">Save Profile</button>
                <button id="listProcProfilesBtn" class="btn">Refresh Profiles</button>
              </div>
              <div id="procMsg" class="muted" style="margin-top:8px"></div>
            </div>
            <div>
              <div class="muted">Calculate CO₂e</div>
              <div class="form-row" style="margin-top:6px">
                <input id="calcName" class="input" placeholder="Procedure name" />
                <input id="calcEnergy" class="input" placeholder="Energy (kWh)" />
              </div>
              <div class="form-row" style="margin-top:6px">
                <input id="calcSterilCycles" class="input" placeholder="Sterilization cycles" />
                <input id="calcStaffHours" class="input" placeholder="Staff hours" />
              </div>
              <div style="margin-top:6px">
                <textarea id="calcConsumables" class="input" style="width:100%;min-height:80px" placeholder="Usage CSV: item:qty"></textarea>
              </div>
              <div style="margin-top:8px;display:flex;gap:8px">
                <button id="calcProcBtn" class="btn">Calculate</button>
              </div>
              <div id="calcProcMsg" class="muted" style="margin-top:8px"></div>
              <div class="muted" style="margin-top:12px">Benchmarks</div>
              <div id="procBenchList" style="margin-top:8px"></div>
            </div>
          </div>
          <div class="muted" style="margin-top:16px">Profiles</div>
          <div id="procProfilesList" style="margin-top:8px"></div>
          <div class="muted" style="margin-top:16px">Risk Heatmap</div>
          <div style="margin-top:6px;display:flex;gap:8px"><button id="loadRiskHeatmapBtn" class="btn">Load Heatmap</button></div>
          <div id="riskHeatmapGrid" style="margin-top:8px;display:grid;grid-template-columns:repeat(auto-fill,minmax(140px,1fr));gap:8px"></div>
          <div id="normDeptBox" style="margin-top:8px"></div>
          <div class="muted" style="margin-top:16px">Doctor Performance</div>
          <div class="form-row" style="margin-top:6px">
            <input id="dpCampus" class="input" placeholder="Campus (optional)" />
            <input id="dpDept" class="input" placeholder="Dept (optional)" />
          </div>
          <div style="margin-top:6px;display:flex;gap:8px"><button id="loadDoctorPerfBtn" class="btn">Load Doctor Performance</button></div>
          <canvas id="doctorPerfChart" height="170" style="margin-top:8px"></canvas>
        </section>
      </div>

      <!-- ======== JOURNEY VIEW ======== -->
      <div id="journeyView" class="view">
        <section class="light-card card">
          <div class="head-row">
            <h3>Patient Journey Footprint</h3>
            <div class="muted">Appointment → Imaging → Admission → Surgery → Discharge</div>
          </div>
          <div style="display:grid;grid-template-columns:1fr 1fr;gap:12px">
            <div>
              <div class="muted">Journey Builder</div>
              <div class="form-row" style="margin-top:6px">
                <input id="jPatient" class="input" placeholder="Patient" />
                <input id="jHospital" class="input" placeholder="Hospital" />
              </div>
              <div class="form-row" style="margin-top:6px">
                <input id="jDept" class="input" placeholder="Dept" />
              </div>
              <div class="muted" style="margin-top:8px">Add Step</div>
              <div class="form-row" style="margin-top:6px">
                <select id="jStepType" class="select"><option value="energy_kwh">Energy kWh</option><option value="water_m3">Water m³</option><option value="waste_kg">Waste kg</option><option value="medw_kg">MedWaste kg</option><option value="travel">Travel</option></select>
                <input id="jStepValue" class="input" placeholder="Value" />
              </div>
              <div class="form-row" style="margin-top:6px">
                <select id="jTravelMode" class="select"><option value="air">Air</option><option value="train">Train</option><option value="bus">Bus</option><option value="car">Car</option></select>
                <select id="jTravelHaul" class="select"><option value="short">Short</option><option value="long">Long</option></select>
                <select id="jTravelClass" class="select"><option value="economy">Economy</option><option value="business">Business</option></select>
              </div>
              <div style="margin-top:8px;display:flex;gap:8px">
                <button id="addJourneyStepBtn" class="btn">Add Step</button>
                <button id="calcJourneyBtn" class="btn">Calculate</button>
                <button id="saveJourneyBtn" class="btn green">Save Journey</button>
              </div>
              <div id="journeyMsg" class="muted" style="margin-top:8px"></div>
            </div>
            <div>
              <div class="muted">Steps</div>
              <div id="journeyStepsList" style="margin-top:8px"></div>
              <div class="muted" style="margin-top:12px">Saved Journeys</div>
              <div id="journeysList" style="margin-top:8px"></div>
            </div>
          </div>
        </section>
      </div>

      <!-- ======== BENCHMARK VIEW ======== -->
      <div id="benchmarkView" class="view">
        <section class="light-card card">
          <div class="head-row">
            <h3>AI Benchmarking</h3>
            <div class="muted">Peer comparison by department and metric</div>
          </div>
          <div class="form-row" style="margin-top:6px">
            <select id="bmMetric" class="select"><option value="co2">CO₂e</option><option value="energy">Energy</option><option value="water">Water</option><option value="waste">Waste</option><option value="medw">MedWaste</option><option value="ren">Renewables %</option><option value="rec">Recycling %</option></select>
            <button id="runBenchmarkBtn" class="btn">Run Benchmark</button>
            <button id="getBmTipsBtn" class="btn">Get Suggestions</button>
          </div>
          <div id="bmMsg" class="muted" style="margin-top:8px"></div>
          <div class="muted" style="margin-top:12px">Peers</div>
          <div id="bmPeersList" style="margin-top:8px"></div>
        </section>
      </div>

      <!-- ======== PROCUREMENT VIEW ======== -->
      <div id="procView" class="view">
        <section class="light-card card">
          <div class="head-row">
            <h3>Green Procurement Scorecard</h3>
            <div class="muted">Suppliers, certificates and item footprints</div>
          </div>
          <div style="display:grid;grid-template-columns:1fr 1fr;gap:12px">
            <div>
              <div class="muted">Supplier</div>
              <div class="form-row" style="margin-top:6px">
                <input id="supName" class="input" placeholder="Supplier name" />
                <input id="supCo2e" class="input" placeholder="Base CO₂e score" />
              </div>
              <div class="form-row" style="margin-top:6px">
                <input id="supCerts" class="input" placeholder="Certificates CSV (ISO,EPD,FSC)" />
              </div>
              <div class="muted" style="margin-top:8px">Item</div>
              <div class="form-row" style="margin-top:6px">
                <input id="itemName" class="input" placeholder="Item name" />
                <input id="itemCategory" class="input" placeholder="Category" />
              </div>
              <div class="form-row" style="margin-top:6px">
                <input id="itemKgCo2e" class="input" placeholder="kgCO₂e per unit" />
              </div>
              <div style="margin-top:8px;display:flex;gap:8px">
                <button id="saveSupplierBtn" class="btn green">Save Supplier</button>
                <button id="listSuppliersBtn" class="btn">Refresh Suppliers</button>
              </div>
              <div id="procSupMsg" class="muted" style="margin-top:8px"></div>
            </div>
            <div>
              <div class="muted">Scores</div>
              <div id="procScoresList" style="margin-top:8px"></div>
              <div class="muted" style="margin-top:12px">Suggestions</div>
              <div class="form-row" style="margin-top:6px">
                <input id="recCategory" class="input" placeholder="Category" />
                <button id="getProcRecBtn" class="btn">Get Tips</button>
              </div>
              <div id="procTipsList" style="margin-top:8px"></div>
            </div>
          </div>
        </section>
      </div>

      <!-- ======== DRUGS VIEW ======== -->
      <div id="drugsView" class="view">
        <section class="light-card card">
          <div class="head-row">
            <h3>Drug & Consumables Carbon Footprint</h3>
            <div class="muted">İlaç kütüphanesi, alternatifler ve kullanım ayak izi</div>
          </div>
          <div style="display:grid;grid-template-columns:1fr 1fr;gap:12px">
            <div>
              <div class="muted">Drug Library</div>
              <div class="form-row" style="margin-top:6px">
                <input id="drugName" class="input" placeholder="Drug name" />
                <input id="drugAtc" class="input" placeholder="ATC code" />
              </div>
              <div class="form-row" style="margin-top:6px">
                <input id="drugSupplier" class="input" placeholder="Supplier" />
                <input id="drugKgUnit" class="input" placeholder="kgCO₂e per unit" />
              </div>
              <div style="margin-top:6px">
                <input id="drugAlts" class="input" placeholder="Alternatives CSV (names)" />
              </div>
              <div style="margin-top:6px;display:flex;gap:8px">
                <button id="saveDrugBtn" class="btn">Save Drug</button>
                <button id="listDrugsBtn" class="btn">Refresh Drugs</button>
              </div>
              <div id="drugsList" style="margin-top:8px"></div>
            </div>
            <div>
              <div class="muted">Usage Footprint</div>
              <div style="margin-top:6px">
                <textarea id="drugUsageCsv" class="input" style="width:100%;min-height:100px" placeholder="Usage CSV: name:qty"></textarea>
              </div>
              <div style="margin-top:6px;display:flex;gap:8px">
                <button id="calcUsageBtn" class="btn green">Calculate Footprint</button>
                <button id="suggestAltBtn" class="btn">Suggest Alternatives</button>
              </div>
              <div id="drugUsageBox" style="margin-top:8px"></div>
              <div id="drugAltBox" style="margin-top:8px"></div>
            </div>
          </div>
        </section>
      </div>

      <!-- ======== CARBON MARKET VIEW ======== -->
      <div id="carbonView" class="view">
        <section class="light-card card">
          <div class="head-row">
            <h3>Group-Level Internal Carbon Market</h3>
            <div class="muted">Quotas, credits and trades across hospitals</div>
          </div>
          <div style="display:grid;grid-template-columns:1fr 1fr;gap:12px">
            <div>
              <div class="muted">Groups</div>
              <div class="form-row" style="margin-top:6px">
                <input id="cmGroupName" class="input" placeholder="Group name" />
                <input id="cmGroupHospitals" class="input" placeholder="Hospitals CSV" />
              </div>
              <div style="margin-top:6px;display:flex;gap:8px">
                <button id="saveCarbonGroupBtn" class="btn green">Save Group</button>
                <button id="listCarbonGroupsBtn" class="btn">Refresh Groups</button>
              </div>
              <div id="carbonGroupsList" style="margin-top:8px"></div>
              <div class="muted" style="margin-top:12px">Quotas</div>
              <div class="form-row" style="margin-top:6px">
                <input id="cmQuotaHospital" class="input" placeholder="Hospital" />
                <input id="cmQuotaYear" class="input" placeholder="Year" />
              </div>
              <div class="form-row" style="margin-top:6px">
                <input id="cmQuotaT" class="input" placeholder="Quota (tCO₂e)" />
              </div>
              <div style="margin-top:6px;display:flex;gap:8px">
                <button id="saveQuotaBtn" class="btn green">Save Quota</button>
                <button id="listQuotasBtn" class="btn">Refresh Quotas</button>
              </div>
              <div id="carbonQuotasList" style="margin-top:8px"></div>
            </div>
            <div>
              <div class="muted">Credits</div>
              <div class="form-row" style="margin-top:6px">
                <input id="cmCreditHospital" class="input" placeholder="Hospital" />
                <input id="cmCreditAmount" class="input" placeholder="Amount (tCO₂e)" />
              </div>
              <div class="form-row" style="margin-top:6px">
                <input id="cmCreditNote" class="input" placeholder="Note" />
              </div>
              <div style="margin-top:6px;display:flex;gap:8px">
                <button id="saveCreditBtn" class="btn green">Save Credit</button>
                <button id="listCreditsBtn" class="btn">Refresh Credits</button>
              </div>
              <div id="carbonCreditsList" style="margin-top:8px"></div>
              <div class="muted" style="margin-top:12px">Trades</div>
              <div class="form-row" style="margin-top:6px">
                <input id="cmTradeFrom" class="input" placeholder="From hospital" />
                <input id="cmTradeTo" class="input" placeholder="To hospital" />
              </div>
              <div class="form-row" style="margin-top:6px">
                <input id="cmTradeAmount" class="input" placeholder="Amount (tCO₂e)" />
                <input id="cmTradePrice" class="input" placeholder="Price (€/t)" />
              </div>
              <div style="margin-top:6px;display:flex;gap:8px">
                <button id="proposeTradeBtn" class="btn">Propose Trade</button>
                <button id="listTradesBtn" class="btn">Refresh Trades</button>
              </div>
              <div id="carbonTradesList" style="margin-top:8px"></div>
              <div class="muted" style="margin-top:12px">Balance</div>
              <div style="margin-top:6px;display:flex;gap:8px;align-items:center">
                <select id="cmBalanceHospital" class="select"></select>
                <button id="loadBalanceBtn" class="btn">Load Balance</button>
              </div>
              <div id="carbonBalanceBox" style="margin-top:8px"></div>
            </div>
          </div>
        </section>
      </div>

      <!-- ======== INSURANCE VIEW ======== -->
      <div id="insuranceView" class="view">
        <section class="light-card card">
          <div class="head-row">
            <h3>Insurance & Reimbursement Impact</h3>
            <div class="muted">CO₂e performansına bağlı geri ödeme etkisi</div>
          </div>
          <div style="display:grid;grid-template-columns:1fr 1fr;gap:12px">
            <div>
              <div class="muted">Config</div>
              <div class="form-row" style="margin-top:6px">
                <input id="insBaseRate" class="input" placeholder="Base rate (€)" />
                <input id="insThreshold" class="input" placeholder="CO₂ threshold (t)" />
              </div>
              <div class="form-row" style="margin-top:6px">
                <input id="insBonusPct" class="input" placeholder="Bonus % per 10% reduction" />
                <input id="insPenaltyPct" class="input" placeholder="Penalty % per 10% excess" />
              </div>
              <div style="margin-top:6px;display:flex;gap:8px">
                <button id="saveInsuranceCfgBtn" class="btn">Save Config</button>
                <button id="loadInsuranceCfgBtn" class="btn">Load Config</button>
              </div>
              <div id="insuranceCfgMsg" class="muted" style="margin-top:8px"></div>
            </div>
            <div>
              <div class="muted">Impact Calculator</div>
              <div class="form-row" style="margin-top:6px">
                <input id="insBaseReimb" class="input" placeholder="Base reimbursement (€)" />
                <input id="insBaselineCo2" class="input" placeholder="Baseline CO₂e (t, optional)" />
              </div>
              <div class="form-row" style="margin-top:6px">
                <input id="insCurrentCo2" class="input" placeholder="Current CO₂e (t, optional)" />
              </div>
              <div style="margin-top:6px;display:flex;gap:8px">
                <button id="calcInsuranceBtn" class="btn green">Calculate Impact</button>
              </div>
              <div id="insuranceImpactBox" style="margin-top:8px"></div>
            </div>
          </div>
        </section>
      </div>

      <!-- ======== WASTE AI VIEW ======== -->
      <div id="wasteView" class="view">
        <section class="light-card card">
          <div class="head-row">
            <h3>Waste Segregation AI</h3>
            <div class="muted">Tıbbi vs genel atık oranı ve öneriler</div>
          </div>
          <div style="display:grid;grid-template-columns:1fr 1fr;gap:12px">
            <div>
              <div class="muted">Baseline</div>
              <div class="form-row" style="margin-top:6px">
                <input id="wBaselineDept" class="input" placeholder="Dept" />
                <input id="wBaselineShare" class="input" placeholder="Medical share % (0–100)" />
              </div>
              <div style="margin-top:6px;display:flex;gap:8px">
                <button id="saveWasteBaselineBtn" class="btn">Save Baseline</button>
                <button id="loadWasteBaselinesBtn" class="btn">Refresh</button>
              </div>
              <div id="wBaselinesList" style="margin-top:8px"></div>
            </div>
            <div>
              <div class="muted">Analyze</div>
          <div style="margin-top:6px;display:flex;gap:8px">
            <button id="runWasteAIBtn" class="btn green">Run Waste AI</button>
            <button id="wasteCreateTasksBtn" class="btn">Create Tasks</button>
          </div>
              <div id="wasteAiMsg" class="muted" style="margin-top:8px"></div>
              <div class="muted" style="margin-top:12px">Quick Analyze</div>
              <div class="form-row" style="margin-top:6px">
                <input id="wWasteKg" class="input" placeholder="Waste kg" />
                <input id="wMedwKg" class="input" placeholder="Medical waste kg" />
              </div>
              <div style="margin-top:6px;display:flex;gap:8px">
                <button id="quickWasteAnalyzeBtn" class="btn">Analyze</button>
              </div>
              <div id="quickWasteBox" style="margin-top:8px"></div>
            </div>
          </div>
        </section>
      </div>

      <!-- ======== PANDEMIC VIEW ======== -->
      <div id="pandemicView" class="view">
        <section class="light-card card">
          <div class="head-row">
            <h3>Pandemic Mode & Stress Test</h3>
            <div class="muted">24–48h surge senaryosu için kaynak yükü</div>
          </div>
          <div style="display:grid;grid-template-columns:1fr 1fr;gap:12px">
            <div>
              <div class="muted">Baseline</div>
              <div class="form-row" style="margin-top:6px">
                <input id="pandEnergy" class="input" placeholder="Energy kWh/day" />
                <input id="pandWater" class="input" placeholder="Water m³/day" />
              </div>
              <div class="form-row" style="margin-top:6px">
                <input id="pandOxygen" class="input" placeholder="Oxygen L/day" />
                <input id="pandWaste" class="input" placeholder="Waste kg/day" />
              </div>
              <div class="form-row" style="margin-top:6px">
                <input id="pandPpe" class="input" placeholder="PPE units/day" />
              </div>
              <div class="muted" style="margin-top:12px">Thresholds</div>
              <div class="form-row" style="margin-top:6px">
                <input id="pandEnergyThr" class="input" placeholder="Energy threshold kWh" />
                <input id="pandOxygenThr" class="input" placeholder="Oxygen threshold L" />
              </div>
              <div style="margin-top:6px;display:flex;gap:8px">
                <button id="savePandCfgBtn" class="btn">Save Baseline</button>
                <button id="loadPandCfgBtn" class="btn">Load Baseline</button>
              </div>
              <div id="pandCfgMsg" class="muted" style="margin-top:8px"></div>
            </div>
            <div>
              <div class="muted">Surge Simulation</div>
              <div class="form-row" style="margin-top:6px">
                <input id="pandSurge" class="input" placeholder="Surge factor ×" />
                <input id="pandHours" class="input" placeholder="Duration (hours)" />
              </div>
              <div style="margin-top:6px;display:flex;gap:8px">
                <button id="runPandSimBtn" class="btn green">Run Simulation</button>
                <button id="pandCreateTasksBtn" class="btn">Create Tasks</button>
              </div>
              <div id="pandSimBox" style="margin-top:8px"></div>
            </div>
          </div>
        </section>
      </div>

      <!-- ======== TWIN VIEW ======== -->
      <div id="twinView" class="view">
        <section class="light-card card">
          <div class="head-row">
            <h3>Sustainability Twin</h3>
            <div class="muted">HVAC setpoint azaltımı → enerji/CO₂e etkisi</div>
          </div>
          <div style="display:grid;grid-template-columns:1fr 1fr;gap:12px">
            <div>
              <div class="muted">Baseline</div>
              <div class="form-row" style="margin-top:6px">
                <input id="twinHvacKwh" class="input" placeholder="HVAC kWh/day" />
                <input id="twinAirflow" class="input" placeholder="Airflow m³/h" />
              </div>
              <div class="form-row" style="margin-top:6px">
                <input id="twinOrRooms" class="input" placeholder="OR rooms" />
                <input id="twinRiskThr" class="input" placeholder="Comfort risk threshold (0–1)" />
              </div>
              <div style="margin-top:6px;display:flex;gap:8px">
                <button id="saveTwinCfgBtn" class="btn">Save Baseline</button>
                <button id="loadTwinCfgBtn" class="btn">Load Baseline</button>
              </div>
              <div id="twinCfgMsg" class="muted" style="margin-top:8px"></div>
            </div>
            <div>
              <div class="muted">HVAC Reduction Simulation</div>
              <div class="form-row" style="margin-top:6px">
                <input id="twinReductionPct" class="input" placeholder="HVAC reduction % (0–50)" />
              </div>
              <div style="margin-top:6px;display:flex;gap:8px">
                <button id="runTwinSimBtn" class="btn green">Run Simulation</button>
                <button id="twinCreateTasksBtn" class="btn">Create Task</button>
              </div>
              <div id="twinSimBox" style="margin-top:8px"></div>
            </div>
          </div>
        </section>
      </div>

      <!-- ======== CAMPUS VIEW ======== -->
      <div id="campusView" class="view">
        <section class="light-card card">
          <div class="head-row">
            <h3>Multi‑Campus / University Hospital</h3>
            <div class="muted">Kampüs tanımları, günlük metrikler ve toplu CO₂e</div>
          </div>
          <div style="display:grid;grid-template-columns:1fr 1fr;gap:12px">
            <div>
              <div class="muted">Campus Definition</div>
              <div class="form-row" style="margin-top:6px">
                <input id="campusName" class="input" placeholder="Campus name" />
                <input id="campusType" class="input" placeholder="Type (research/clinic/lab)" />
              </div>
              <div style="margin-top:6px">
                <input id="campusNotes" class="input" placeholder="Notes" />
              </div>
              <div style="margin-top:6px;display:flex;gap:8px">
                <button id="saveCampusBtn" class="btn">Save Campus</button>
                <button id="listCampusesBtn" class="btn">Refresh</button>
              </div>
              <div id="campusDefsList" style="margin-top:8px"></div>
            </div>
            <div>
              <div class="muted">Daily Metrics</div>
              <div class="form-row" style="margin-top:6px">
                <input id="metricCampus" class="input" placeholder="Campus" />
                <input id="metricDate" class="input" placeholder="ISO date" />
              </div>
              <div class="form-row" style="margin-top:6px">
                <input id="metricEnergy" class="input" placeholder="Energy kWh" />
                <input id="metricWater" class="input" placeholder="Water m³" />
              </div>
              <div class="form-row" style="margin-top:6px">
                <input id="metricWaste" class="input" placeholder="Waste kg" />
                <input id="metricMedw" class="input" placeholder="MedWaste kg" />
              </div>
              <div class="form-row" style="margin-top:6px">
                <input id="metricCyto" class="input" placeholder="Cytotoxic kg" />
              </div>
              <div style="margin-top:6px;display:flex;gap:8px">
                <button id="saveCampusMetricBtn" class="btn">Save Metric</button>
                <button id="listCampusMetricsBtn" class="btn">Refresh Metrics</button>
                <button id="aggCampusBtn" class="btn green">Aggregate Campus</button>
              </div>
              <div id="campusMetricsList" style="margin-top:8px"></div>
              <div id="campusAggBox" style="margin-top:8px"></div>
            </div>
          </div>
        </section>
      </div>

      <!-- ======== FINANCE VIEW ======== -->
      <div id="financeView" class="view">
        <section class="light-card card">
          <div class="head-row">
            <h3>Financial Leakage Map</h3>
            <div class="muted">Energy/Water/Waste/MedWaste yıllık finansal etkiler</div>
          </div>
          <div style="display:grid;grid-template-columns:1fr 1fr;gap:12px">
            <div>
              <div class="muted">Campus Leakage</div>
              <div style="margin-top:6px;display:flex;gap:8px">
                <input id="flmCampus" class="input" placeholder="Campus (optional)" />
                <button id="loadLeakageBtn" class="btn green">Load Leakage</button>
              </div>
              <div id="leakageBox" style="margin-top:8px"></div>
              <div class="muted" style="margin-top:12px">Dept Breakdown</div>
              <div style="margin-top:6px;display:flex;gap:8px"><button id="drawFlmDeptBtn" class="btn">Draw Dept Chart</button></div>
              <canvas id="flmDeptChart" height="170" style="margin-top:8px"></canvas>
            </div>
            <div>
              <div class="muted">Top Depts</div>
              <div style="margin-top:6px;display:flex;gap:8px"><button id="loadTopLeakageBtn" class="btn">Top 3</button></div>
              <div id="topLeakageList" style="margin-top:8px"></div>
              <div class="muted" style="margin-top:12px">Dept Breakdown Controls</div>
              <div class="form-row" style="margin-top:6px">
                <input id="flmTopN" class="input" placeholder="Top N (e.g. 10)" />
                <select id="flmSortDir" class="select"><option value="desc">Desc</option><option value="asc">Asc</option></select>
              </div>
            </div>
          </div>
        </section>
      </div>

      <!-- ======== TAXONOMY VIEW ======== -->
      <div id="taxonomyView" class="view">
        <section class="light-card card">
          <div class="head-row">
            <h3>EU Taxonomy Alignment</h3>
            <div class="muted">Aligned % (ren, rec, medw share)</div>
          </div>
          <div class="form-row" style="margin-top:6px">
            <input id="taxCampus" class="input" placeholder="Campus (optional)" />
            <input id="taxDept" class="input" placeholder="Dept (optional)" />
          </div>
          <div style="display:flex;gap:8px;margin-top:6px"><button id="loadTaxonomyBtn" class="btn">Load Taxonomy</button></div>
          <div id="taxonomyBox" style="margin-top:8px"></div>
          <div style="display:grid;grid-template-columns:1fr 1fr;gap:12px;margin-top:8px">
            <div>
              <canvas id="taxRenRecChart" height="140"></canvas>
            </div>
            <div>
              <canvas id="taxMedwChart" height="140"></canvas>
            </div>
          </div>
        </section>
      </div>

      <!-- ======== PROJECTS VIEW ======== -->
      <div id="projectsView" class="view">
        <section class="light-card card">
          <div class="head-row">
            <h3>Green Deal Projects</h3>
            <div class="muted">Taxonomy-eligible investments and expected CO₂e reduction</div>
          </div>
          <div style="display:grid;grid-template-columns:1fr 1fr;gap:12px">
            <div>
              <div class="muted">EU Taxonomy Alignments</div>
              <div style="margin-top:6px;display:flex;gap:8px"><button id="loadAlignmentsBtn" class="btn">Load Alignments</button></div>
              <div id="alignmentsList" style="margin-top:8px"></div>
            </div>
            <div>
              <div class="muted">Projects</div>
              <div style="margin-top:6px;display:flex;gap:8px"><button id="loadProjectsBtn" class="btn">Load Projects</button></div>
              <div id="projectsList" style="margin-top:8px"></div>
            </div>
          </div>
        </section>
      </div>

      <!-- ======== CONNECTORS VIEW ======== -->
      <div id="connectorsView" class="view">
        <section class="light-card card">
          <div class="head-row">
            <h3>Streaming Connectors Marketplace</h3>
            <div class="muted">HL7/FHIR · HIS/EHR · PACS · Pharmacy · BMS</div>
          </div>
          <div style="margin-top:6px;display:flex;gap:8px"><button id="loadConnectorsBtn" class="btn">Load Connectors</button></div>
          <div id="connectorsList" style="margin-top:8px"></div>
        </section>
      </div>

      <!-- ======== RADAR VIEW ======== -->
      <div id="radarView" class="view">
        <section class="light-card card">
          <div class="head-row">
            <h3>EU Accreditation Radar</h3>
            <div class="muted">ESRS · DNSH · CSRD · ISO 14001/50001 · WHO</div>
          </div>
          <div style="margin-top:6px;display:flex;gap:8px">
            <button id="loadRadarBtn" class="btn">Load Scores</button>
            <button id="getRadarTipsBtn" class="btn">Get Recommendations</button>
            <select id="radarCampusSel" class="select" style="max-width:160px"></select>
          </div>
          <div id="radarMsg" class="muted" style="margin-top:8px"></div>
          <div class="muted" style="margin-top:12px">Frameworks</div>
          <div id="radarScoresList" style="margin-top:8px"></div>
          <div class="muted" style="margin-top:12px">Actions</div>
          <div class="form-row" style="margin-top:6px">
            <input id="radarFramework" class="input" placeholder="Framework e.g. ESRS" />
            <input id="radarAction" class="input" placeholder="Action" />
          </div>
          <div class="form-row" style="margin-top:6px">
            <input id="radarOwner" class="input" placeholder="Owner" />
            <input id="radarDue" class="input" placeholder="Due ISO date" />
          </div>
          <div style="margin-top:6px;display:flex;gap:8px">
            <button id="saveRadarActionBtn" class="btn green">Save Action</button>
            <button id="listRadarActionsBtn" class="btn">Refresh Actions</button>
          </div>
          <div id="radarActionsList" style="margin-top:8px"></div>
        </section>
      </div>

      <!-- ======== SETTINGS VIEW ======== -->
      <div id="settingsView" class="view">
        <section class="light-card card">
          <div class="head-row">
            <h3>Settings</h3>
            <div class="muted">Emission factors, thresholds and scope weights</div>
          </div>
          <div style="display:grid;grid-template-columns:1fr 1fr;gap:12px">
            <div>
              <div class="muted">Factors</div>
              <div class="form-row" style="margin-top:6px">
                <input id="fEnergyFactor" class="input" placeholder="Energy: kWh→tCO₂e" />
                <input id="fWaterFactor" class="input" placeholder="Water: m³→tCO₂e" />
              </div>
              <div class="form-row" style="margin-top:6px">
                <select id="efActiveSel" class="select"></select>
                <button id="saveEfActiveBtn" class="btn">Save Active Factors</button>
              </div>
              <div class="form-row" style="margin-top:6px">
                <input id="efCsvFile" type="file" />
                <button id="importEfCsvBtn" class="btn">Import Factors CSV</button>
                <button id="validateEfCsvBtn" class="btn">Validate Factors CSV</button>
                <button id="downloadDefraCsvBtn" class="btn">Download DEFRA CSV</button>
                <button id="downloadEeaCsvBtn" class="btn">Download EEA CSV</button>
              </div>
              <div id="efValidateList" style="margin-top:8px"></div>
              <div class="muted" style="margin-top:12px">Hospital Factor Mapping</div>
              <div class="form-row" style="margin-top:6px">
                <input id="mapHospital" class="input" placeholder="Hospital" />
                <select id="mapProfile" class="select"></select>
              </div>
              <div style="margin-top:6px;display:flex;gap:8px">
                <button id="saveMapBtn" class="btn">Save Mapping</button>
                <button id="listMapsBtn" class="btn">Refresh Maps</button>
              </div>
              <div id="mapsList" style="margin-top:8px"></div>
              <div class="muted" style="margin-top:12px">Country Factor Mapping</div>
              <div class="form-row" style="margin-top:6px">
                <input id="mapCountry" class="input" placeholder="Country" />
                <select id="mapCountryProfile" class="select"></select>
              </div>
              <div style="margin-top:6px;display:flex;gap:8px">
                <button id="saveCountryMapBtn" class="btn">Save Country Mapping</button>
                <button id="listCountryMapsBtn" class="btn">Refresh Country Maps</button>
              </div>
              <div id="countryMapsList" style="margin-top:8px"></div>
              <div class="form-row" style="margin-top:6px">
                <input id="fWasteFactor" class="input" placeholder="Waste: kg→tCO₂e" />
                <input id="fMedwFactor" class="input" placeholder="MedWaste: kg→tCO₂e" />
              </div>
              <div class="muted" style="margin-top:12px">Thresholds</div>
              <div class="form-row" style="margin-top:6px">
                <input id="fCo2Threshold" class="input" placeholder="CO₂e Alert Threshold (t)" />
              </div>
              <div class="muted" style="margin-top:12px">Per-Dept/Hospital Factor Profiles</div>
              <div class="form-row" style="margin-top:6px">
                <input id="fpHospital" class="input" placeholder="Hospital" />
                <input id="fpDept" class="input" placeholder="Dept" />
              </div>
              <div class="form-row" style="margin-top:6px">
                <input id="fpEnergy" class="input" placeholder="Energy kWh→tCO₂e" />
                <input id="fpWater" class="input" placeholder="Water m³→tCO₂e" />
              </div>
              <div class="form-row" style="margin-top:6px">
                <input id="fpWaste" class="input" placeholder="Waste kg→tCO₂e" />
                <input id="fpMedw" class="input" placeholder="MedWaste kg→tCO₂e" />
              </div>
              <div class="form-row" style="margin-top:6px">
                <input id="fpScope1W" class="input" placeholder="Scope1 weight (0–1)" />
                <input id="fpScope2W" class="input" placeholder="Scope2 weight (0–1)" />
              </div>
              <div style="margin-top:6px;display:flex;gap:8px">
                <button id="saveFactorProfileBtn" class="btn">Save Profile</button>
                <button id="listFactorProfilesBtn" class="btn">Refresh Profiles</button>
              </div>
            </div>
            <div>
              <div class="muted">Scope Weights</div>
              <div class="form-row" style="margin-top:6px">
                <input id="fScope1" class="input" placeholder="Scope 1 weight (0–1)" />
                <input id="fScope2" class="input" placeholder="Scope 2 weight (0–1)" />
              </div>
              <div class="muted" style="margin-top:12px">Actions</div>
              <div style="margin-top:6px;display:flex;gap:8px">
                <button id="loadSettingsBtn" class="btn">Load</button>
                <button id="saveSettingsBtn" class="btn green">Save</button>
              </div>
              <div id="settingsMsg" class="muted" style="margin-top:8px"></div>
              <div class="muted" style="margin-top:16px">Profiles</div>
              <div id="factorProfilesList" style="margin-top:8px"></div>
              <div class="muted" style="margin-top:16px">Notification Groups</div>
              <div class="form-row" style="margin-top:6px">
                <input id="grpName" class="input" placeholder="Group name e.g. admins" />
                <input id="grpEmails" class="input" placeholder="Emails comma-separated" />
              </div>
              <div style="margin-top:6px;display:flex;gap:8px">
                <button id="saveGroupBtn" class="btn">Save Group</button>
                <button id="listGroupsBtn" class="btn">Refresh Groups</button>
              </div>
              <div id="groupsList" style="margin-top:8px"></div>
              <div class="muted" style="margin-top:16px">Notification Templates</div>
              <div class="form-row" style="margin-top:6px">
                <input id="tmplName" class="input" placeholder="Template name" />
                <input id="tmplSubject" class="input" placeholder="Subject (use {{dept}} {{title}} {{sla_due}})" />
              </div>
              <div style="margin-top:6px">
                <textarea id="tmplBody" class="input" style="width:100%; min-height:120px" placeholder="Body with placeholders e.g. Task {{title}} in {{dept}} overdue. SLA {{sla_due}}."></textarea>
              </div>
              <div style="margin-top:6px;display:flex;gap:8px">
                <button id="saveTemplateBtn" class="btn">Save Template</button>
                <button id="listTemplatesBtn" class="btn">Refresh Templates</button>
              </div>
              <div id="templatesList" style="margin-top:8px"></div>
              <div class="muted" style="margin-top:16px">Report Email Schedule</div>
              <div class="form-row" style="margin-top:6px">
                <select id="schedEmailGroup" class="select"></select>
                <select id="schedEmailTemplate" class="select"></select>
              </div>
              <div class="muted" style="margin-top:16px">Escalation Rules</div>
              <div class="form-row" style="margin-top:6px">
                <input id="escName" class="input" placeholder="Rule name" />
                <input id="escDept" class="input" placeholder="Dept (optional)" />
              </div>
              <div class="form-row" style="margin-top:6px">
                <input id="escOverdue" class="input" placeholder="Overdue days" />
                <input id="escGroup" class="input" placeholder="Notify group" />
              </div>
              <div class="form-row" style="margin-top:6px">
                <input id="escTemplate" class="input" placeholder="Template name" />
                <input id="escAssignee" class="input" placeholder="Assignee" />
              </div>
              <div style="margin-top:6px;display:flex;gap:8px">
                <button id="saveEscRuleBtn" class="btn">Save Escalation Rule</button>
                <button id="listEscRulesBtn" class="btn">Refresh Rules</button>
                <button id="runEscNowBtn" class="btn green">Run Now</button>
              </div>
              <div id="escRulesList" style="margin-top:8px"></div>
              <div class="muted" style="margin-top:16px">Security Config</div>
              <div class="form-row" style="margin-top:6px">
                <input id="secWindowMs" class="input" placeholder="Rate limit window ms" />
                <input id="secMax" class="input" placeholder="Rate limit max" />
              </div>
              <div class="form-row" style="margin-top:6px">
                <input id="secTtlH" class="input" placeholder="Session TTL hours" />
                <input id="secPwMin" class="input" placeholder="Password min length" />
              </div>
              <div style="margin-top:6px;display:flex;gap:8px">
                <button id="saveSecBtn" class="btn">Save Security</button>
                <button id="loadSecBtn" class="btn">Load Security</button>
              </div>
              <div class="muted" style="margin-top:16px">Email Outbox</div>
              <div style="margin-top:6px;display:flex;gap:8px">
                <button id="listOutboxBtn" class="btn">Refresh Outbox</button>
                <button id="sendOutboxBtn" class="btn green">Send All</button>
                <button id="listSentBtn" class="btn">Refresh Sent</button>
              </div>
              <div id="outboxList" style="margin-top:8px"></div>
              <div id="sentList" style="margin-top:8px"></div>
              <div class="muted" style="margin-top:16px">SMTP Config</div>
              <div class="form-row" style="margin-top:6px">
                <input id="smtpHost" class="input" placeholder="SMTP Host" />
                <input id="smtpPort" class="input" placeholder="Port" />
              </div>
              <div class="form-row" style="margin-top:6px">
                <input id="smtpUser" class="input" placeholder="User" />
                <input id="smtpPass" class="input" type="password" placeholder="Pass" />
              </div>
              <div style="margin-top:6px;display:flex;gap:8px">
                <button id="saveSmtpBtn" class="btn">Save SMTP</button>
                <button id="loadSmtpBtn" class="btn">Load SMTP</button>
              </div>
            </div>
          </div>
        </section>
      </div>

      <!-- ======== OPS VIEW ======== -->
      <div id="opsView" class="view">
        <section class="light-card card">
          <div class="head-row">
            <h3>Ops Dashboard</h3>
            <div class="muted">Healthcheck · Metrics · Alerts · Tickets · Backups</div>
          </div>
          <div style="display:grid;grid-template-columns:1fr 1fr;gap:12px">
            <div>
              <div class="muted">Healthcheck</div>
              <div style="margin-top:6px;display:flex;gap:8px">
                <button id="loadHealthBtn" class="btn">Load Health</button>
              </div>
              <div id="healthBox" style="margin-top:8px"></div>
              <div class="muted" style="margin-top:12px">Ops Summary</div>
              <div style="margin-top:6px;display:flex;gap:8px">
                <button id="loadOpsSummaryBtn" class="btn">Load Summary</button>
              </div>
              <div id="opsSummaryBox" style="margin-top:8px"></div>
              <div class="muted" style="margin-top:12px">Advisor</div>
              <div class="form-row" style="margin-top:6px">
                <input id="advisorEndpoint" class="input" placeholder="Endpoint path e.g. /api/reports/generate" />
              </div>
              <div class="form-row" style="margin-top:6px">
                <input id="advisorPrefix" class="input" placeholder="Endpoint prefix e.g. /api/reports" />
                <select id="advisorPrefixPreset" class="select" style="max-width:240px">
                  <option value="">Select prefix…</option>
                  <option value="/api/reports">/api/reports</option>
                  <option value="/api/eflib">/api/eflib</option>
                  <option value="/api/procurement">/api/procurement</option>
                  <option value="/api/carbon">/api/carbon</option>
                  <option value="/api/insurance">/api/insurance</option>
                  <option value="/api/waste">/api/waste</option>
                  <option value="/api/pandemic">/api/pandemic</option>
                  <option value="/api/twin">/api/twin</option>
                  <option value="/api/campus">/api/campus</option>
                  <option value="/api/radar">/api/radar</option>
                  <option value="/api/benchmark">/api/benchmark</option>
                </select>
              </div>
              <div style="margin-top:6px;display:flex;gap:8px"><button id="runAdvisorBtn" class="btn">Run Advisory</button></div>
              <div id="advisorBox" style="margin-top:8px"></div>
              <div style="margin-top:6px;display:flex;gap:8px"><button id="runLLMAdvisorBtn" class="btn">LLM Advisory</button></div>
              <div id="llmAdvisorBox" style="margin-top:8px"></div>
              <div class="muted" style="margin-top:12px">Trends</div>
              <div style="margin-top:6px;display:flex;gap:8px"><button id="loadOpsChartsBtn" class="btn">Load Charts</button></div>
              <div class="form-row" style="margin-top:6px">
                <input id="opsOutlierThr" class="input" placeholder="Outlier threshold ms (e.g. 2000)" />
              </div>
              <div id="opsChartLabel" class="muted" style="margin-top:6px"></div>
              <div style="margin-top:8px">
                <canvas id="opsP95Chart" height="140"></canvas>
              </div>
              <div style="margin-top:8px">
                <canvas id="opsErrChart" height="140"></canvas>
              </div>
            </div>
            <div>
              <div class="muted">Alerts</div>
              <div style="margin-top:6px;display:flex;gap:8px">
                <button id="listOpsAlertsBtn" class="btn">Refresh Alerts</button>
              </div>
              <div id="opsAlertsList" style="margin-top:8px"></div>
              <div class="muted" style="margin-top:12px">Tickets</div>
              <div style="margin-top:6px;display:flex;gap:8px">
                <button id="listOpsTicketsBtn" class="btn">Refresh Tickets</button>
                <button id="genOpsTicketsBtn" class="btn">Generate Tickets</button>
              </div>
              <div id="opsTicketsList" style="margin-top:8px"></div>
              <div class="muted" style="margin-top:12px">Backups</div>
              <div style="margin-top:6px;display:flex;gap:8px">
                <button id="listBackupsBtn" class="btn">List Backups</button>
                <button id="listBackupLogsBtn" class="btn">Backup Logs</button>
                <select id="rollbackEnvSel" class="select"><option value="prod">prod</option><option value="staging">staging</option></select>
                <button id="genRollbackCmdBtn" class="btn">Show Rollback Cmd</button>
              </div>
              <div id="backupsList" style="margin-top:8px"></div>
              <div id="backupLogsList" style="margin-top:8px"></div>
              <div class="muted" style="margin-top:12px">Rollback Command</div>
              <div id="rollbackCmdBox" style="margin-top:8px"></div>
            </div>
          </div>
        </section>
      </div>
    </div>

    <section id="taxonomy-section" class="card" style="margin:16px">
      <div class="head-row">
        <h3>EU Taxonomy & Green Deal – İzmir Kampüsleri</h3>
        <span id="taxonomy-env-tag" class="pill ok">ENV: ?</span>
      </div>
      <div style="margin-top:8px">
        <div class="form-row" style="gap:8px">
          <div>
            <label class="muted">Campus / Hospital</label>
            <select id="taxonomy-campus-select" class="select"></select>
          </div>
          <div style="display:flex; align-items:flex-end">
            <button id="taxonomyRefreshBtn" class="btn">↻ Refresh Taxonomy Data</button>
          </div>
        </div>
        <div class="kpis" id="taxonomy-kpis" style="margin-top:12px">
          <div class="kpi"><div class="label">Eligible Revenue</div><div class="value" id="kpi-eligible-revenue">–</div><div class="delta">Taxonomy scope</div></div>
          <div class="kpi"><div class="label">Aligned Revenue</div><div class="value" id="kpi-aligned-revenue">–</div><div class="delta">After DNSH & safeguards</div></div>
          <div class="kpi"><div class="label">Aligned Capex</div><div class="value" id="kpi-aligned-capex">–</div><div class="delta">Green Deal projects</div></div>
          <div class="kpi"><div class="label">ESRS Gap Score</div><div class="value" id="kpi-esrs-gap">–</div><div class="delta">0 = strong, 100 = weak</div></div>
        </div>
        <div class="two-col" style="margin-top:12px">
          <div>
            <div class="muted">DNSH & ESRS Notes</div>
            <span id="taxonomy-dnsh-pill" class="pill">DNSH: –</span>
            <ul id="taxonomy-dnsh-notes" style="margin-top:8px"></ul>
          </div>
          <div>
            <div class="muted">CBAM Exposure (Indirect)</div>
            <div style="margin-top:6px"><strong>Exposed Share:</strong> <span id="taxonomy-cbam-share">–</span></div>
            <ul id="taxonomy-cbam-channels" style="margin-top:8px"></ul>
          </div>
        </div>
        <div style="margin-top:12px">
          <div class="muted">Next 12 Months – Priority Actions</div>
          <ol id="taxonomy-priority-actions" style="margin-top:8px"></ol>
        </div>
      </div>
    </section>
    <div class="footer">© 2025 HSP Demo · Built on a DPP-inspired layout · <a class="link" href="#" id="downloadDemoJson">Download Sample Data (JSON)</a> · <a class="link" href="#" id="downloadHspCsvPack">Download HSP CSV Pack</a> · <a class="link" href="#" id="downloadHspSql">Download Supabase SQL</a></div>
  </div>
  <button class="chat-toggle" id="chatToggle">Chat</button>
  <div class="chat-drawer" id="chatDrawer">
    <div class="chat-header">
      <div style="font-weight:800">Zero@Hospital Chat</div>
      <select id="providerSelect" class="select" style="margin-left:auto; min-width:120px">
        <option value="claude">Claude</option>
        <option value="openai">OpenAI</option>
      </select>
      <select id="modelSelect" class="select" style="min-width:160px"></select>
    </div>
    <div class="chat-body">
      <div id="chatMessages"></div>
      <div class="muted" id="chatInfo" style="margin-top:6px"></div>
      <div style="margin-top:8px">
        <div class="muted">Attached Files</div>
        <div id="chatFiles" style="margin-top:4px"></div>
      </div>
    </div>
    <div class="chat-controls">
      <input id="chatFileInput" type="file" />
      <button id="attachFileBtn" class="btn">Attach</button>
      <input id="chatText" class="input chat-input" placeholder="Type a message" />
      <button id="sendChatBtn" class="btn green">Send</button>
      <button id="saveChatBtn" class="btn">Save Session</button>
    </div>
  </div>

  <!-- Lightweight Modal for New Entry -->
  <div id="modal" style="position:fixed; inset:0; display:none; align-items:center; justify-content:center; background:rgba(0,0,0,.45); z-index:50">
    <div class="card" style="width:min(720px, 92vw); max-height:85vh; overflow:auto">
      <div class="head-row">
        <h3>+ New Sustainability Record</h3>
        <button class="btn" onclick="closeModal()">✕</button>
      </div>
      <div class="muted" style="margin:6px 0 10px">All fields required for the demo. Values are simple numbers; CO₂e here is direct-entry (your real calc can be automated).</div>
      <div class="form-row">
        <input id="fYear" class="input" placeholder="Year e.g. 2025" />
        <input id="fHospital" class="input" placeholder="Hospital Name" />
      </div>
      <div class="form-row" style="margin-top:8px">
        <input id="fCountry" class="input" placeholder="Country (name or ISO code)" />
      </div>
      <div class="form-row" style="margin-top:8px">
        <input id="fDept" class="input" placeholder="Department (e.g. OR, ICU, Imaging)" />
        <input id="fEnergy" class="input" placeholder="Energy (kWh)" />
      </div>
      <div class="form-row" style="margin-top:8px">
        <input id="fWater" class="input" placeholder="Water (m³)" />
        <input id="fWaste" class="input" placeholder="Waste (kg)" />
      </div>
      <div class="form-row" style="margin-top:8px">
        <input id="fMedWaste" class="input" placeholder="Medical Waste (kg)" />
        <input id="fCO2" class="input" placeholder="CO₂e (t)" />
      </div>
      <div style="margin-top:8px; display:flex; align-items:center; gap:8px">
        <label style="display:flex; align-items:center; gap:6px"><input id="autoCalcCo2" type="checkbox" /> CO₂e'yi otomatik hesapla</label>
      </div>
      <div class="form-row" style="margin-top:8px">
        <input id="fRen" class="input" placeholder="Renewables %" />
        <input id="fRec" class="input" placeholder="Recycling %" />
      </div>
      <div style="margin-top:12px; display:flex; gap:8px; justify-content:flex-end">
        <button class="btn" onclick="closeModal()">Cancel</button>
        <button class="btn green" onclick="saveNew()">Save</button>
      </div>
    </div>
  </div>

  <script>
  (function(){
    'use strict';

    // ---------- I18N ----------
    const I18N = {
      tr: {
        hero_title: 'Zero@Hospital — Health Sustainability Passport',
        badge_demo: 'Demo v1',
        tagline: 'Hastaneler için emisyon ve karbon ayak izi takibi',
        btn_back: '← Geri',
        btn_reset: 'Filtreleri Sıfırla',
        btn_export_csv: 'CSV Dışa Aktar',
        btn_export_pdf: 'PDF Dışa Aktar',
        btn_export_xlsx: 'Excel Dışa Aktar',
        btn_zoom: '%100 Büyüt',
        btn_load_pilot: 'İzmir Pilot Verisi',
        tab_main: '🏠 Ana',
        tab_live: '📈 Canlı',
        kpi_title: 'Temel Performans Göstergeleri',
        kpi_total_co2: 'Toplam CO₂e (ton)',
        kpi_energy: 'Enerji (kWh)',
        kpi_water: 'Su (m³)',
        kpi_waste: 'Atık (kg)',
        kpi_medwaste: 'Tıbbi Atık (kg)',
        kpi_renrec: 'Yenilenebilir / Geri Dönüşüm',
        records_filtered: 'Kayıtlar (Filtreli)',
        energy_by_dept: 'Departmana Göre Enerji (kWh)',
        waste_composition: 'Atık Dağılımı (kg)',
        monthly_co2_trend: 'Aylık CO₂e Eğilimi (tCO₂e)',
        estimator: 'Uluslararası Hasta Yolculuğu — CO₂ Hesaplayıcı',
        estimator_note: 'Sadece demo · Ekonomi katsayısı ≈ 0.115 kg CO₂ / yolcu·km',
        est_co2: 'Tahmini CO₂e (ton)',
        live_metrics: 'Canlı Göstergeler (Demo)',
        minute_trend: 'Dakikalık Trend',
        interval: 'Aralık',
        window: 'Pencere',
        start: 'Başlat',
        stop: 'Durdur',
        add_sample: 'Örnek Kayıt Ekle',
        new_entry: '+ Yeni Giriş',
      },
      en: {
        hero_title: 'Zero@Hospital — Health Sustainability Passport',
        badge_demo: 'Demo v1',
        tagline: 'Emissions and carbon footprint tracking for hospitals',
        btn_back: '← Back',
        btn_reset: 'Reset Filters',
        btn_export_csv: 'Export CSV',
        btn_export_pdf: 'Export PDF',
        btn_export_xlsx: 'Export Excel',
        btn_zoom: '%100 Zoom',
        btn_load_pilot: 'Load Izmir Pilot',
        tab_main: '🏠 Main',
        tab_live: '📈 Live',
        kpi_title: 'Key Performance Indicators',
        kpi_total_co2: 'Total CO₂e (t)',
        kpi_energy: 'Energy (kWh)',
        kpi_water: 'Water (m³)',
        kpi_waste: 'Waste (kg)',
        kpi_medwaste: 'Medical Waste (kg)',
        kpi_renrec: 'Renewables / Recycling',
        records_filtered: 'Records (Filtered)',
        energy_by_dept: 'Energy by Department (kWh)',
        waste_composition: 'Waste Composition (kg)',
        monthly_co2_trend: 'Monthly CO₂e Trend (tCO₂e)',
        estimator: 'International Patient Travel — CO₂ Estimator',
        estimator_note: 'Demo only · Economy factor ≈ 0.115 kg CO₂ / pax·km',
        est_co2: 'Estimated CO₂e (t)',
        live_metrics: 'Live Metrics (Demo)',
        minute_trend: 'Minute Trend',
        interval: 'Interval',
        window: 'Window',
        start: 'Start',
        stop: 'Stop',
        add_sample: 'Add Sample Record',
        new_entry: '+ New Entry',
      }
    };

    const LS_KEY = 'hsp_demo_data_v1';
    const LS_LANG = 'hsp_lang_v1';

    const settings = { co2Threshold: 1000, factors: { energy_kwh_to_tco2e: 0.00042, water_m3_to_tco2e: 0.000344, waste_kg_to_tco2e: 0.0019, medw_kg_to_tco2e: 0.0045 } };

    const state = { data: [], charts: { energy:null, waste:null, co2:null }, liveChart:null, lang: 'en' };
    const API_BASE = window.location.origin;
    const LS_TARGETS = 'hsp_dept_targets_v1';
    const chat = { open:false, provider:'claude', model:'', messages:[], fileIds:[], fileTexts:[] }

    // ---------- Demo Dataset ----------
    const SAMPLE = [
      {year:2024, hospital:"Alveo Medical Center", dept:"ICU", energy:310000, water:7200, waste:5400, medw:1600, co2:420, ren:28, rec:37},
      {year:2024, hospital:"Alveo Medical Center", dept:"OR", energy:260000, water:5100, waste:4200, medw:2100, co2:380, ren:28, rec:33},
      {year:2024, hospital:"Alveo Medical Center", dept:"Imaging", energy:180000, water:1600, waste:900,  medw:120,  co2:210, ren:28, rec:45},
      {year:2025, hospital:"Alveo Medical Center", dept:"ICU", energy:295000, water:6800, waste:5200, medw:1500, co2:400, ren:34, rec:41},
      {year:2025, hospital:"Alveo Medical Center", dept:"OR", energy:245000, water:4900, waste:4000, medw:2050, co2:360, ren:34, rec:38},
      {year:2025, hospital:"Alveo Medical Center", dept:"Imaging", energy:165000, water:1500, waste:800,  medw:110,  co2:190, ren:34, rec:47},
      {year:2024, hospital:"KonyaCare Hospital", dept:"Ward A", energy:140000, water:4200, waste:2500, medw:600,  co2:180, ren:18, rec:29},
      {year:2024, hospital:"KonyaCare Hospital", dept:"Ward B", energy:120000, water:3800, waste:2300, medw:520,  co2:160, ren:18, rec:30},
      {year:2025, hospital:"KonyaCare Hospital", dept:"Ward A", energy:130000, water:4000, waste:2200, medw:580,  co2:170, ren:24, rec:35},
      {year:2025, hospital:"KonyaCare Hospital", dept:"Ward B", energy:115000, water:3600, waste:2100, medw:500,  co2:150, ren:24, rec:36},
      {year:2025, hospital:"EuroHealth Antalya", dept:"ICU", energy:210000, water:5100, waste:3100, medw:900,  co2:260, ren:22, rec:34},
      {year:2025, hospital:"EuroHealth Antalya", dept:"OR",  energy:190000, water:4700, waste:2900, medw:980,  co2:240, ren:22, rec:36}
    ];

    // ---------- Utilities ----------
    const qs = (q)=>document.querySelector(q);
    const qsa = (q)=>Array.from(document.querySelectorAll(q));
    const sum = (arr, sel)=>arr.reduce((a,x)=>a+(+sel(x)||0),0);
    const mean = (arr, sel)=>arr.length? sum(arr,sel)/arr.length : 0;

    function t(key){ return (I18N[state.lang] && I18N[state.lang][key]) || I18N.en[key] || key; }

    function applyLang(){
      document.documentElement.lang = state.lang;
      qs('#heroTitle').textContent = t('hero_title');
      qs('#badgeDemo').textContent = t('badge_demo');
      qs('#heroTag').textContent = t('tagline');
      qs('#backBtn').textContent = t('btn_back');
      qs('#resetBtn').textContent = t('btn_reset');
      qs('#exportCsvBtn').textContent = t('btn_export_csv');
      qs('#exportPdfBtn').textContent = t('btn_export_pdf');
      qs('#exportXlsxBtn').textContent = t('btn_export_xlsx');
      qs('#zoomBtn').textContent = t('btn_zoom');
      const lp = qs('#loadPilotBtn'); if (lp) lp.textContent = t('btn_load_pilot');
      qs('#tabMainBtn').textContent = t('tab_main');
      qs('#tabLiveBtn').textContent = t('tab_live');
      qs('#lblKpiTitle').textContent = t('kpi_title');
      qs('#lblEnergyByDept').textContent = t('energy_by_dept');
      qs('#lblWasteComp').textContent = t('waste_composition');
      qs('#lblMonthlyCO2').textContent = t('monthly_co2_trend');
      qs('#lblRecordsFiltered').textContent = t('records_filtered');
      qs('#lblEstimator').textContent = t('estimator');
      qs('#lblEstimatorNote').textContent = t('estimator_note');
      qs('#lblEstCo2').textContent = t('est_co2');
      qs('#lblEstCo2Tr').textContent = state.lang==='tr' ? 'Tahmini CO₂e (ton)' : 'Estimated CO₂e (t)';
      qs('#lblLiveMetrics').textContent = t('live_metrics');
      qs('#lblMinuteTrend').textContent = t('minute_trend');
      qs('#lblInterval').textContent = t('interval');
      qs('#lblWindow').textContent = t('window');
      // buttons inside cards
      qsa('#openAddModalBtn').forEach(b=>b.textContent = t('new_entry'));
      qsa('#addSampleBtn').forEach(b=>b.textContent = t('add_sample'));
      // re-render KPI cards with translated labels
      renderKPIs();
    }

    function loadData(){
      const raw = localStorage.getItem(LS_KEY);
      state.data = raw ? JSON.parse(raw) : SAMPLE;
    }
    function saveData(){ localStorage.setItem(LS_KEY, JSON.stringify(state.data)); }

    function unique(arr, sel){ return [...new Set(arr.map(sel))]; }

    function fmt(n, d=0){ if (n===undefined || n===null || isNaN(n)) return '—'; return Number(n).toLocaleString(undefined,{maximumFractionDigits:d, minimumFractionDigits:d}); }

    function filtered(){
      const y = +qs('#yearSel').value || null;
      const h = qs('#hospSel').value || '';
      const d = qs('#deptSel').value || '';
      return state.data.filter(r => (y? r.year===y : true) && (h? r.hospital===h : true) && (d? r.dept===d : true));
    }

    function populateFilters(){
      const years = unique(state.data, r=>r.year).sort();
      const hosps = unique(state.data, r=>r.hospital).sort();
      const depts = unique(state.data, r=>r.dept).sort();

      qs('#yearSel').innerHTML = '<option value="">All Years</option>' + years.map(y=>`<option value="${y}">${y}</option>`).join('');
      qs('#hospSel').innerHTML = '<option value="">All Hospitals</option>' + hosps.map(h=>`<option value="${h}">${h}</option>`).join('');
      qs('#deptSel').innerHTML = '<option value="">All Departments</option>' + depts.map(d=>`<option value="${d}">${d}</option>`).join('');
    }

    function statusPill(rec){
      const ok = rec.ren >= 30 && rec.rec >= 35 && rec.co2 <= 350;
      const warn = !ok && (rec.ren >= 20 || rec.rec >= 30);
      const cls = ok? 'ok' : (warn? 'warn' : 'bad');
      const text = ok? 'OK' : (warn? 'Monitor' : 'Action');
      return `<span class="pill ${cls}">${text}</span>`
    }

    function renderTable(){
      const rows = filtered();
      qs('#countLabel').textContent = `${rows.length} record(s)`;
      qs('#tbody').innerHTML = rows.map(r=>`
        <tr>
          <td>${r.year}</td>
          <td>${r.hospital}</td>
          <td>${r.dept}</td>
          <td>${fmt(r.energy)}</td>
          <td>${fmt(r.water)}</td>
          <td>${fmt(r.waste)}</td>
          <td>${fmt(r.medw)}</td>
          <td>${fmt(r.co2)}</td>
          <td>${fmt(r.ren,0)}%</td>
          <td>${fmt(r.rec,0)}%</td>
          <td>${statusPill(r)}</td>
        </tr>
      `).join('');
    }

    function renderKPIs(){
      const rows = filtered();
      const kwh = sum(rows, r=>r.energy);
      const m3 = sum(rows, r=>r.water);
      const wkg = sum(rows, r=>r.waste);
      const mw  = sum(rows, r=>r.medw);
      const co2 = sum(rows, r=>r.co2);
      const ren = mean(rows, r=>r.ren);
      const rec = mean(rows, r=>r.rec);
      const s3extra = sum(rows, r=> r.scope3_extra||0 );

      const cards = [
        {key:'kpi_total_co2', value: fmt(co2), delta:`Avg ${fmt(mean(rows,r=>r.co2),1)} t/rec`, alert: co2 > settings.co2Threshold},
        {key:'kpi_energy',    value: fmt(kwh), delta:`${rows.length} records`},
        {key:'kpi_water',     value: fmt(m3),  delta:`${rows.length} records`},
        {key:'kpi_waste',     value: fmt(wkg), delta:`Incl. general`},
        {key:'kpi_medwaste',  value: fmt(mw),  delta:`Hazardous`},
        {key:'kpi_renrec',    value: `${fmt(ren,0)}% / ${fmt(rec,0)}%`, delta:'Averages'}
      ];
      if (s3extra>0){ cards.push({ key:'Scope 3 Extra', value: fmt(s3extra), delta:'tCO₂e (procurement/transport/etc.)' }) }

      qs('#kpis').innerHTML = cards.map(c=>
        `<div class="kpi ${c.alert?'alert':''}">
           <div class="label">${t(c.key)}</div>
           <div class="value">${c.value}</div>
           <div class="delta">${c.delta}</div>
         </div>`
      ).join('');
    }

    function renderCharts(){
      const rows = filtered();
      const byDept = {};
      rows.forEach(r=>{ byDept[r.dept] = (byDept[r.dept]||0) + (+r.energy||0); });
      const deptLabels = Object.keys(byDept);
      const deptVals = deptLabels.map(k=>byDept[k]);

      const wasteGeneral = sum(rows, r=>r.waste);
      const wasteMedical = sum(rows, r=>r.medw);

      const totalCO2 = sum(rows, r=>r.co2);
      const months = ['Jan','Feb','Mar','Apr','May','Jun','Jul','Aug','Sep','Oct','Nov','Dec'];
      const weights = (window.__seasonWeights && Array.isArray(window.__seasonWeights)) ? window.__seasonWeights : [1.08,1.06,1.02,0.98,0.95,0.94,0.93,0.95,0.98,1.02,1.06,1.10];
      const wSum = weights.reduce((a,x)=>a+x,0);
      const mVals = weights.map(w=> +(totalCO2 * (w/wSum)).toFixed(3));

      ['energy','waste','co2'].forEach(k=>{ if(state.charts[k]){ state.charts[k].destroy(); state.charts[k]=null; } });

      state.charts.energy = new Chart(qs('#energyChart'),{
        type:'bar', data:{ labels: deptLabels, datasets:[{ label:'kWh', data: deptVals }] },
        options:{ plugins:{ legend:{display:false, labels:{ color:'#ffffff' } } }, scales:{ x:{ ticks:{color:'#ffffff'}}, y:{ ticks:{color:'#ffffff'} } } }
      });

      state.charts.waste = new Chart(qs('#wasteChart'),{
        type:'doughnut', data:{ labels:['General','Medical'], datasets:[{ data:[wasteGeneral, wasteMedical] }] },
        options:{ plugins:{ legend:{ labels:{color:'#ffffff'} } } }
      });

      state.charts.co2 = new Chart(qs('#co2Chart'),{
        type:'line', data:{ labels: months, datasets:[{ label:'tCO₂e', data:mVals, tension:.35, fill:false }] },
        options:{ plugins:{ legend:{display:true, labels:{color:'#ffffff'} } }, scales:{ x:{ ticks:{color:'#ffffff'}}, y:{ ticks:{color:'#ffffff'} } } }
      });
    }

    function renderDeptDash(){
      const rows = filtered();
      const kwh = sum(rows, r=>r.energy);
      const m3 = sum(rows, r=>r.water);
      const wkg = sum(rows, r=>r.waste);
      const co2 = sum(rows, r=>r.co2);
      const ren = mean(rows, r=>r.ren);
      const rec = mean(rows, r=>r.rec);
      const cards = [
        { label:'CO₂e', value: fmt(co2) },
        { label:'Energy', value: fmt(kwh) },
        { label:'Water', value: fmt(m3) },
        { label:'Waste', value: fmt(wkg) },
        { label:'Renewables', value: fmt(ren,0)+'%' },
        { label:'Recycling', value: fmt(rec,0)+'%' }
      ]
      qs('#deptKpis').innerHTML = cards.map(c=> `<div class="kpi"><div class="label">${c.label}</div><div class="value">${c.value}</div></div>`).join('')
      const months = ['Jan','Feb','Mar','Apr','May','Jun','Jul','Aug','Sep','Oct','Nov','Dec'];
      const mVals = months.map((_,i)=> Math.max(0, co2/12 * (0.9 + Math.sin(i/12*Math.PI*2)*0.1)));
      if (state.charts.deptco2){ state.charts.deptco2.destroy(); state.charts.deptco2=null }
      state.charts.deptco2 = new Chart(qs('#deptCo2Chart'),{ type:'line', data:{ labels: months, datasets:[{ label:'tCO₂e', data:mVals, tension:.35 }] }, options:{ plugins:{ legend:{position:'top'} } } })
    }

    function applyAll(){ renderKPIs(); renderTable(); renderCharts(); }

    async function renderScopes(){
      const rows = filtered();
      let profiles = []
      try{ const r = await apiFetch('/api/factors', { method:'GET' }); profiles = Array.isArray(r.profiles)? r.profiles : [] }catch(_){ profiles = [] }
      const map = new Map(); profiles.forEach(p=> map.set(p.hospital+'|'+p.dept, p))
      let s1 = 0, s2 = 0
      rows.forEach(r=>{
        const key = (r.hospital||'')+'|'+(r.dept||'')
        const prof = map.get(key)
        const w = (prof && prof.scope_weights) ? prof.scope_weights : (settings.scope_weights||{ s1:0.25, s2:0.6 })
        s1 += (+r.co2||0) * (w.s1||0.25)
        s2 += (+r.co2||0) * (w.s2||0.6)
      })
      const total = sum(rows, r=>r.co2);
      const s3extra = sum(rows, r=> (r.scope3_extra||0) );
      const s3 = Math.max(0, total - s1 - s2) + s3extra;
      qs('#scope1Val').textContent = fmt(s1,1);
      qs('#scope2Val').textContent = fmt(s2,1);
      qs('#scope3Val').textContent = fmt(s3,1);
      const el = qs('#scopesChart');
      if (state.charts.scopes) { state.charts.scopes.destroy(); state.charts.scopes = null }
      state.charts.scopes = new Chart(el, { type:'doughnut', data:{ labels:['Scope 1','Scope 2','Scope 3'], datasets:[{ data:[s1,s2,s3] }] }, options:{ plugins:{ legend:{ position:'right' } } } })
    }

    function getApiKey(){ const el = document.getElementById('apiKeyInput'); const v = (el && el.value) ? el.value : (localStorage.getItem('hsp_api_key') || ''); return String(v).trim() }
    function setApiKey(k){ localStorage.setItem('hsp_api_key', k) }
    async function apiFetch(path, opts){
      const key = getApiKey();
      const headers = Object.assign({ 'Content-Type':'application/json' }, key ? { 'X-API-Key': key } : {});
      const r = await fetch(API_BASE + path, Object.assign({ headers }, opts || {}));
      const data = await r.json().catch(()=>({}));
      if (!r.ok) throw new Error(data && data.error ? data.error : 'api_error');
      return data
    }
    async function loadPilotDemo(){
      try{
        let env = 'prod'
        try{ const h = await apiFetch('/api/health',{ method:'GET' }); env = (h.app&&h.app.env)||'prod' }catch(_){ }
        await apiFetch('/api/pilot/init', { method:'POST' })
        const j = await apiFetch('/api/dataset', { method:'GET' })
        const rows = Array.isArray(j.rows)? j.rows : []
        if (rows.length){ state.data = rows; saveData(); populateFilters(); applyAll(); const pm = qs('#pilotMsg'); if (pm) pm.textContent = `İzmir Pilot yüklendi ✔️ (${rows.length} rows · env: ${env} · dir: ${env==='staging'? 'data_staging':'data'})` }
      }catch(e){ /* no-op */ }
    }
    async function loadHspDemo(){
      try{
        await apiFetch('/api/demo/hsp-load', { method:'POST' })
        const j = await apiFetch('/api/dataset', { method:'GET' })
        const rows = Array.isArray(j.rows)? j.rows : []
        if (rows.length){ state.data = rows; saveData(); populateFilters(); applyAll(); const pm = qs('#pilotMsg'); if (pm) pm.textContent = `HSP Demo yüklendi ✔️ (${rows.length} rows)` }
      }catch(e){ /* no-op */ }
    }
    async function updateEnvBadge(){ try{ const h = await apiFetch('/api/health',{ method:'GET' }); const env = (h.app&&h.app.env)||'prod'; const el = qs('#envBadge'); if (el){ el.textContent = `ENV: ${env}`; el.className = env==='staging'? 'pill warn' : 'pill ok' } const ap = qs('#apiMsg'); if (ap){ ap.style.display = 'none' } }catch(_){ const el = qs('#envBadge'); if (el){ el.textContent = 'ENV: unknown'; el.className = 'pill bad' } const ap = qs('#apiMsg'); if (ap){ ap.style.display = 'inline-flex' } } }
    async function doLogin(){
      const u = String(document.getElementById('loginUser').value||'').trim()
      const p = String(document.getElementById('loginPass').value||'').trim()
      if (!u || !p) return
      try{
        const j = await fetch(API_BASE+'/api/auth/login', { method:'POST', headers:{ 'Content-Type':'application/json' }, body: JSON.stringify({ username: u, password: p }) }).then(r=> r.json())
        if (j && j.token){ localStorage.setItem('hsp_api_key', j.token); const inp = document.getElementById('apiKeyInput'); if (inp) inp.value = j.token; document.getElementById('loginPass').value=''; updateAuthUI(); }
      }catch(_){ }
    }
    async function doLogout(){
      try{
        const key = getApiKey(); if (key){ await fetch(API_BASE+'/api/auth/logout', { method:'POST', headers:{ 'X-API-Key': key } }) }
      }catch(_){ }
      localStorage.removeItem('hsp_api_key'); const inp = document.getElementById('apiKeyInput'); if (inp) inp.value=''; updateAuthUI();
    }
    function updateAuthUI(){
      const key = getApiKey(); const logged = !!key
      const lb = document.getElementById('loginBtn'); const lo = document.getElementById('logoutBtn'); const lu = document.getElementById('loginUser'); const lp = document.getElementById('loginPass')
      if (lb) lb.style.display = logged? 'none':'inline-block'
      if (lo) lo.style.display = logged? 'inline-block':'none'
      if (lu) lu.style.display = logged? 'none':'inline-block'
      if (lp) lp.style.display = logged? 'none':'inline-block'
    }

    async function loadAlerts(){
      try {
        const key = getApiKey(); if (key) setApiKey(key)
        const data = await apiFetch('/api/alert-rules', { method:'GET' })
        const rules = Array.isArray(data.rules) ? data.rules : []
        qs('#alertsList').innerHTML = rules.length ? rules.map(r=> `<div class="kpi"><div class="label">${r.name}</div><div class="value" style="font-size:14px">${r.rule}</div><div class="delta">${r.enabled? 'Enabled':'Disabled'}</div></div>`).join('') : '<div class="muted">No rules</div>'
        qs('#alertsMsg').textContent = 'Loaded'
      } catch (e) { qs('#alertsMsg').textContent = String(e.message || e) }
    }
    async function evaluateAlerts(){
      try{
        const rows = filtered()
        const r = await apiFetch('/api/alert-evaluate', { method:'POST', body: JSON.stringify({ rows }) })
        const arr = Array.isArray(r.triggers)? r.triggers : []
        qs('#alertsTriggers').innerHTML = arr.length ? arr.map(t=> `<div class="kpi"><div class="label">${t.name}</div><div class="value">${t.count} match</div><div class="delta">${t.rule}</div></div>`).join('') : '<div class="muted">No triggers</div>'
      } catch(e){ qs('#alertsMsg').textContent = String(e.message||e) }
    }
    async function addRule(){
      try {
        const name = String(document.getElementById('newRuleName').value || '').trim()
        const rule = String(document.getElementById('newRuleExpr').value || '').trim()
        if (!name || !rule) { qs('#alertsMsg').textContent = 'Name and expression required'; return }
        await apiFetch('/api/alert-rules', { method:'POST', body: JSON.stringify({ name, rule, enabled:true }) })
        qs('#alertsMsg').textContent = 'Added'
        document.getElementById('newRuleName').value=''; document.getElementById('newRuleExpr').value=''
        loadAlerts()
      } catch (e) { qs('#alertsMsg').textContent = String(e.message || e) }
    }

    async function createTasksFromAlerts(){
      try{
        const rows = filtered()
        const r = await apiFetch('/api/alerts/autotask', { method:'POST', body: JSON.stringify({ rows, sla_days: 7 }) })
        qs('#alertsMsg').textContent = `Created ${r.created||0} task(s)`
        listTasks()
        showTab('Actions')
      }catch(e){ qs('#alertsMsg').textContent = String(e.message||e) }
    }

    async function createTask(){
      try{
        const title = String(document.getElementById('taskTitle').value||'').trim()
        const dept = String(document.getElementById('taskDept').value||'').trim()
        const assignee = String(document.getElementById('taskAssignee').value||'').trim()
        const sla_due = String(document.getElementById('taskSla').value||'').trim() || null
        if (!title) return
        await apiFetch('/api/tasks', { method:'POST', body: JSON.stringify({ title, dept, assignee, sla_due, status:'open' }) })
        document.getElementById('taskTitle').value=''; document.getElementById('taskDept').value=''; document.getElementById('taskAssignee').value=''; document.getElementById('taskSla').value=''
        listTasks()
      }catch(e){ /* no-op */ }
    }

    let taskDeptFilter = ''
    async function listTasks(){
      try{
        const r = await apiFetch('/api/tasks?limit=20', { method:'GET' })
        let tasks = Array.isArray(r.tasks)? r.tasks : []
        if (taskDeptFilter){ tasks = tasks.filter(t=> String(t.dept||'')===taskDeptFilter) }
        qs('#tasksList').innerHTML = tasks.length ? tasks.map(t=> {
          const overdue = t.status==='open' && t.sla_due && new Date(t.sla_due) < new Date()
          const pill = overdue ? '<span class="pill warn">Overdue</span>' : ''
          const esc = overdue && t.status!=='escalated' ? `<button class="btn" data-esc="${t.id}">Escalate</button>` : ''
          return `<div class="kpi"><div class="label">${t.title}</div><div class="value">${t.status} ${pill}</div><div class="delta">${t.dept||'—'} · ${t.assignee||'—'} ${t.sla_due? ' · SLA '+t.sla_due: ''}</div><div style="margin-top:6px; display:flex; gap:8px"><button class="btn" data-task="${t.id}">Mark Done</button>${esc}</div></div>`
        }).join('') : '<div class="muted">No tasks</div>'
        Array.from(qs('#tasksList').querySelectorAll('button[data-task]')).forEach(b=> b.addEventListener('click', async ()=>{ const id = b.getAttribute('data-task'); await apiFetch('/api/tasks/'+id, { method:'PATCH', body: JSON.stringify({ status:'done' }) }); listTasks() }))
        Array.from(qs('#tasksList').querySelectorAll('button[data-esc]')).forEach(b=> b.addEventListener('click', async ()=>{ const id = b.getAttribute('data-esc'); await apiFetch('/api/tasks/'+id, { method:'PATCH', body: JSON.stringify({ status:'escalated', assignee:'Admin' }) }); listTasks() }))
      }catch(e){ qs('#tasksList').textContent = String(e.message||e) }
    }

    async function logAction(){
      try {
        const action = String(document.getElementById('actionText').value || '').trim()
        const metaRaw = String(document.getElementById('actionMeta').value || '').trim()
        let meta = {}
        if (metaRaw) { try { meta = JSON.parse(metaRaw) } catch(_){} }
        if (!action) return
        await apiFetch('/api/actions/log', { method:'POST', body: JSON.stringify({ action, meta }) })
        document.getElementById('actionText').value=''; document.getElementById('actionMeta').value=''
        loadActions()
      } catch (e) {}
    }
    async function loadActions(){
      try {
        const data = await apiFetch('/api/actions/logs?limit=10', { method:'GET' })
        const logs = Array.isArray(data.logs) ? data.logs : []
        qs('#actionsList').innerHTML = logs.length ? logs.map(l=> `<div class="kpi"><div class="label">${l.action}</div><div class="delta">${new Date(l.t).toLocaleString()}</div></div>`).join('') : '<div class="muted">No actions</div>'
      } catch (e) { qs('#actionsList').textContent = String(e.message || e) }
    }

    function renderChat(){
      const box = qs('#chatMessages')
      box.innerHTML = chat.messages.map(m=> `<div class="chat-msg"><span class="role">${m.role}:</span> ${Array.isArray(m.content)&&m.content[0]? (m.content[0].text||'') : ''}</div>`).join('')
      qs('#chatFiles').innerHTML = chat.fileIds.length ? chat.fileIds.map((id,i)=> `<div class="pill">#${i+1} ${id}</div>`).join('') : '<div class="muted">None</div>'
    }
    function toggleChat(){ chat.open = !chat.open; qs('#chatDrawer').classList.toggle('active', chat.open) }
    async function loadModels(){
      try{
        const key = getApiKey(); if (key) setApiKey(key)
        const prov = qs('#providerSelect').value
        if (prov==='claude'){
          const j = await apiFetch('/api/models', { method:'GET' })
          const arr = Array.isArray(j.models)? j.models: []
          qs('#modelSelect').innerHTML = arr.map(m=> `<option value="${m}">${m}</option>`).join('')
          chat.provider = 'claude'; chat.model = arr[0]||''
        } else {
          const j = await apiFetch('/api/openai/models', { method:'GET' })
          const arr = Array.isArray(j.models)? j.models: []
          qs('#modelSelect').innerHTML = arr.map(m=> `<option value="${m}">${m}</option>`).join('')
          chat.provider = 'openai'; chat.model = arr[0]||''
        }
      } catch(e){ qs('#chatInfo').textContent = String(e.message||e) }
    }
    async function attachFile(){
      try{
        const inp = qs('#chatFileInput'); const f = inp.files && inp.files[0]; if (!f) return
        const reader = new FileReader()
        reader.onload = async () => {
          const b64 = reader.result.split(',')[1]
          const j = await apiFetch('/api/files/save', { method:'POST', body: JSON.stringify({ name: f.name, mime: f.type || 'application/octet-stream', data: b64 }) })
          chat.fileIds.push(j.id)
          try{ const detail = await apiFetch('/api/files/'+j.id, { method:'GET' }); if (detail && detail.text) chat.fileTexts.push(detail.text) }catch(_){ }
          renderChat()
        }
        reader.readAsDataURL(f)
      } catch(e){ qs('#chatInfo').textContent = String(e.message||e) }
    }
    function buildMessages(userText){
      const msgs = [...chat.messages]
      if (chat.fileTexts.length){ msgs.push({ role:'user', content:[{ type:'text', text: 'Attached files context:\n' + chat.fileTexts.join('\n\n') }] }) }
      msgs.push({ role:'user', content:[{ type:'text', text: userText }] })
      return msgs
    }
    function extractText(resp){
      try{
        if (resp && Array.isArray(resp.content)){
          const b = resp.content.find(x=> x.type==='text'); if (b && b.text) return b.text
          const t = resp.content[0] && resp.content[0].text ? resp.content[0].text : ''
          return t
        }
        return ''
      }catch(_){ return '' }
    }
    async function sendChat(){
      try{
        const t = String(qs('#chatText').value||'').trim(); if (!t) return
        const msgs = buildMessages(t)
        const prov = qs('#providerSelect').value
        const model = qs('#modelSelect').value
        const system = 'You are Zero@Hospital assistant. Provide precise, concise, actionable answers for hospital sustainability, emissions and operations.'
        let resp
        if (prov==='claude'){
          resp = await apiFetch('/api/chat', { method:'POST', body: JSON.stringify({ model, max_tokens: 1024, system, messages: msgs }) })
        } else {
          const base = msgs.map(m=> ({ role: m.role, content: [{ type:'text', text: Array.isArray(m.content)&&m.content[0]? (m.content[0].text||'') : '' }] }))
          const j = await apiFetch('/api/openai/chat', { method:'POST', body: JSON.stringify({ model, max_tokens: 1024, system, messages: base }) })
          resp = j
        }
        const text = extractText(resp)
        chat.messages = msgs.concat([{ role:'assistant', content:[{ type:'text', text }] }])
        qs('#chatText').value = ''
        renderChat()
      } catch(e){ qs('#chatInfo').textContent = String(e.message||e) }
    }
    async function saveChat(){
      try{
        await apiFetch('/api/session/save', { method:'POST', body: JSON.stringify({ messages: chat.messages, mode:'hospital', model: chat.model }) })
        qs('#chatInfo').textContent = 'Session saved'
      } catch(e){ qs('#chatInfo').textContent = String(e.message||e) }
    }

    function defaultTargets(){
      return [
        { dept:'OR', co2:350, energy:250000, water:4500, ren:35, rec:40 },
        { dept:'ICU', co2:400, energy:300000, water:7000, ren:30, rec:38 },
        { dept:'Imaging', co2:220, energy:180000, water:1600, ren:32, rec:45 },
        { dept:'Ward A', co2:180, energy:140000, water:4200, ren:28, rec:35 },
        { dept:'Ward B', co2:160, energy:120000, water:3800, ren:28, rec:35 }
      ]
    }
    function loadTargets(){
      const raw = localStorage.getItem(LS_TARGETS)
      const arr = raw ? JSON.parse(raw) : defaultTargets()
      qs('#targetsBody').innerHTML = arr.map((t,i)=>`
        <tr>
          <td>${t.dept}</td>
          <td><input class="input" value="${t.co2}" data-i="${i}" data-k="co2"/></td>
          <td><input class="input" value="${t.energy}" data-i="${i}" data-k="energy"/></td>
          <td><input class="input" value="${t.water}" data-i="${i}" data-k="water"/></td>
          <td><input class="input" value="${t.ren}" data-i="${i}" data-k="ren"/></td>
          <td><input class="input" value="${t.rec}" data-i="${i}" data-k="rec"/></td>
        </tr>
      `).join('')
      qsa('#targetsBody input').forEach(inp=> inp.addEventListener('change', ()=> saveTargets()))
      localStorage.setItem(LS_TARGETS, JSON.stringify(arr))
    }
    function saveTargets(){
      const rows = Array.from(qsa('#targetsBody tr')).map(tr=>{
        const tds = Array.from(tr.querySelectorAll('td'))
        return {
          dept: tds[0].textContent,
          co2: +tds[1].querySelector('input').value,
          energy: +tds[2].querySelector('input').value,
          water: +tds[3].querySelector('input').value,
          ren: +tds[4].querySelector('input').value,
          rec: +tds[5].querySelector('input').value,
        }
      })
      localStorage.setItem(LS_TARGETS, JSON.stringify(rows))
    }
    async function applyTargetsAsAlerts(){
      try {
        const raw = localStorage.getItem(LS_TARGETS)
        const arr = raw ? JSON.parse(raw) : defaultTargets()
        const key = getApiKey(); if (key) setApiKey(key)
        for (const t of arr){
          await apiFetch('/api/alert-rules', { method:'POST', body: JSON.stringify({ name: `${t.dept} CO2`, rule: `dept==\"${t.dept}\" && co2 > ${t.co2}`, enabled:true }) })
          await apiFetch('/api/alert-rules', { method:'POST', body: JSON.stringify({ name: `${t.dept} Energy`, rule: `dept==\"${t.dept}\" && energy > ${t.energy}`, enabled:true }) })
          await apiFetch('/api/alert-rules', { method:'POST', body: JSON.stringify({ name: `${t.dept} Water`, rule: `dept==\"${t.dept}\" && water > ${t.water}`, enabled:true }) })
          await apiFetch('/api/alert-rules', { method:'POST', body: JSON.stringify({ name: `${t.dept} Renewables`, rule: `dept==\"${t.dept}\" && ren < ${t.ren}`, enabled:true }) })
          await apiFetch('/api/alert-rules', { method:'POST', body: JSON.stringify({ name: `${t.dept} Recycling`, rule: `dept==\"${t.dept}\" && rec < ${t.rec}`, enabled:true }) })
        }
        qs('#targetsMsg').textContent = 'Targets applied as rules'
        loadAlerts()
      } catch (e) { qs('#targetsMsg').textContent = String(e.message || e) }
    }

    function renderCompliance(){
      const rows = filtered()
      const ren = mean(rows, r=>r.ren)
      const rec = mean(rows, r=>r.rec)
      const co2 = sum(rows, r=>r.co2)
      const kwh = sum(rows, r=>r.energy)
      const cards = [
        { label:'CSRD Readiness', value: ren>=30 && rec>=35 ? 'On Track' : 'Monitor', delta: 'Policies & KPIs' },
        { label:'ISO 14001 Alignment', value: 'In Progress', delta: 'Docs & Audit' },
        { label:'Clinical Accreditation', value: 'JCI/TEMOS', delta: 'Renewal checks' },
        { label:'CO₂e Total', value: fmt(co2), delta: 'tCO₂e' },
        { label:'Energy Total', value: fmt(kwh), delta: 'kWh' }
      ]
      qs('#complianceKpis').innerHTML = cards.map(c=>`<div class="kpi"><div class="label">${c.label}</div><div class="value">${c.value}</div><div class="delta">${c.delta}</div></div>`).join('')
    }
    async function exportCompliancePdf(){
      const { jsPDF } = window.jspdf
      const doc = new jsPDF({unit:'pt', format:'a4'})
      let y = 36
      doc.setFont('helvetica','bold'); doc.setFontSize(16)
      doc.text('Compliance Center — Zero@Hospital', 36, y); y+=20
      doc.setFont('helvetica','normal'); doc.setFontSize(10)
      const now = new Date().toLocaleString(); doc.text(now, 36, y); y+=14
      const rows = filtered()
      const ren = mean(rows, r=>r.ren), rec = mean(rows, r=>r.rec), co2 = sum(rows,r=>r.co2), kwh = sum(rows,r=>r.energy)
      const lines = [
        `CSRD Readiness: ${(ren>=30 && rec>=35) ? 'On Track':'Monitor'}`,
        `ISO 14001 Alignment: In Progress`,
        `Clinical Accreditation: JCI/TEMOS`,
        `CO₂e Total: ${fmt(co2)}`,
        `Energy Total: ${fmt(kwh)}`
      ]
      lines.forEach(l=>{ doc.text(l, 36, y); y+=14 })
      doc.save('compliance.pdf')
    }

    async function exportCsrdPdf(){
      const { jsPDF } = window.jspdf
      const doc = new jsPDF({unit:'pt', format:'a4'})
      let y = 36
      doc.setFont('helvetica','bold'); doc.setFontSize(16)
      doc.text('CSRD Report — Zero@Hospital', 36, y); y+=20
      doc.setFont('helvetica','normal'); doc.setFontSize(10)
      const rows = filtered()
      const ren = mean(rows, r=>r.ren), rec = mean(rows, r=>r.rec), co2 = sum(rows,r=>r.co2), kwh = sum(rows,r=>r.energy), water = sum(rows,r=>r.water)
      const weights = settings.scope_weights || { s1:0.25, s2:0.6 }
      const s1 = co2*(weights.s1||0.25), s2 = co2*(weights.s2||0.6), s3 = Math.max(0, co2 - s1 - s2)
      const now = new Date().toLocaleString(); doc.text(now, 36, y); y+=16
      doc.text('Summary KPIs',36,y); y+=12
      ;['Total CO₂e: '+fmt(co2),'Energy: '+fmt(kwh),'Water: '+fmt(water),'Renewables: '+fmt(ren,0)+'%','Recycling: '+fmt(rec,0)+'%'].forEach(l=>{ doc.text(l,36,y); y+=12 })
      y+=6; doc.text('Scopes',36,y); y+=12
      ;['Scope 1: '+fmt(s1,1),'Scope 2: '+fmt(s2,1),'Scope 3: '+fmt(s3,1)].forEach(l=>{ doc.text(l,36,y); y+=12 })
      y+=6; doc.text('Policies & Actions',36,y); y+=12
      ;['Energy efficiency program','Waste management improvements','Water saving initiatives'].forEach(l=>{ doc.text('• '+l,36,y); y+=12 })
      y+=6; doc.text('Data Provenance',36,y); y+=12
      doc.text('Demo dataset with local persistence',36,y); y+=12
      doc.save('csrd_report.pdf')
    }
    async function exportIsoPdf(){
      const { jsPDF } = window.jspdf
      const doc = new jsPDF({unit:'pt', format:'a4'})
      let y = 36
      doc.setFont('helvetica','bold'); doc.setFontSize(16)
      doc.text('ISO 14001 Report — Zero@Hospital', 36, y); y+=20
      doc.setFont('helvetica','normal'); doc.setFontSize(10)
      const rows = filtered()
      const co2 = sum(rows,r=>r.co2), kwh = sum(rows,r=>r.energy)
      const now = new Date().toLocaleString(); doc.text(now, 36, y); y+=16
      doc.text('Environmental Management System',36,y); y+=12
      ;['Policy documented','Objectives set','Operational controls in place','Internal audit scheduled'].forEach(l=>{ doc.text('• '+l,36,y); y+=12 })
      y+=6; doc.text('KPIs',36,y); y+=12
      ;['CO₂e Total: '+fmt(co2),'Energy Total: '+fmt(kwh)].forEach(l=>{ doc.text(l,36,y); y+=12 })
      doc.save('iso14001_report.pdf')
    }
    async function exportJciPdf(){
      const { jsPDF } = window.jspdf
      const doc = new jsPDF({unit:'pt', format:'a4'})
      let y = 36
      doc.setFont('helvetica','bold'); doc.setFontSize(16)
      doc.text('JCI/TEMOS Report — Zero@Hospital', 36, y); y+=20
      doc.setFont('helvetica','normal'); doc.setFontSize(10)
      const rows = filtered()
      const rec = mean(rows,r=>r.rec), ren = mean(rows,r=>r.ren)
      const now = new Date().toLocaleString(); doc.text(now, 36, y); y+=16
      doc.text('Accreditation Snapshot',36,y); y+=12
      ;['Waste management compliance','Hazardous materials handling','Facility safety checks'].forEach(l=>{ doc.text('• '+l,36,y); y+=12 })
      y+=6; doc.text('Environmental KPIs',36,y); y+=12
      ;['Recycling Avg: '+fmt(rec,0)+'%','Renewables Avg: '+fmt(ren,0)+'%'].forEach(l=>{ doc.text(l,36,y); y+=12 })
      doc.save('jci_temos_report.pdf')
    }
    async function exportEsrsGapPdf(){
      try{
        const j = await apiFetch('/api/esrs/checklist', { method:'GET' })
        const arr = Array.isArray(j.items)? j.items : []
        const total = arr.length, done = arr.filter(x=> x.status==='done').length, pending = arr.filter(x=> x.status!=='done').length
        const byStatus = { pending: arr.filter(x=> x.status==='pending').length, in_progress: arr.filter(x=> x.status==='in_progress').length, done }
        const dnsh = [ { area:'Water', status:'pending' }, { area:'Biodiversity', status:'pending' }, { area:'Pollution', status:'in_progress' }, { area:'Circular', status:'in_progress' } ]
        const taxonomy = [ { code:'E1', name:'Climate change mitigation', status: byStatus.done? 'partial':'pending' }, { code:'E2', name:'Climate change adaptation', status:'pending' } ]
        const { jsPDF } = window.jspdf
        const doc = new jsPDF({unit:'pt', format:'a4'})
        let y = 36
        doc.setFont('helvetica','bold'); doc.setFontSize(16)
        doc.text('ESRS Gap Analysis — Zero@Hospital', 36, y); y+=20
        doc.setFont('helvetica','normal'); doc.setFontSize(10)
        doc.text(`Items: ${total} · Done: ${done} · Pending/In Progress: ${pending}`, 36, y); y+=16
        doc.text('By Status',36,y); y+=12
        ;[`Pending: ${byStatus.pending}`, `In Progress: ${byStatus.in_progress}`, `Done: ${byStatus.done}`].forEach(l=>{ doc.text(l,36,y); y+=12 })
        y+=6; doc.text('DNSH Snapshot',36,y); y+=12
        dnsh.forEach(d=>{ doc.text(`${d.area}: ${d.status}`,36,y); y+=12 })
        y+=6; doc.text('EU Taxonomy Mapping',36,y); y+=12
        taxonomy.forEach(t=>{ doc.text(`${t.code} ${t.name}: ${t.status}`,36,y); y+=12 })
        y+=6; doc.text('Open Items',36,y); y+=12
        arr.filter(x=> x.status!=='done').slice(0,20).forEach(x=>{ doc.text(`${x.code} · ${x.name} · ${x.owner||'—'} ${x.due? ' · '+x.due:''}`,36,y); y+=12 })
        doc.save('esrs_gap.pdf')
      }catch(e){ qs('#schedulesMsg').textContent = String(e.message||e) }
    }
    async function emailEsrsGap(){
      try{
        const { jsPDF } = window.jspdf
        const doc = new jsPDF({unit:'pt', format:'a4'})
        let y = 36
        doc.setFont('helvetica','bold'); doc.setFontSize(16)
        doc.text('ESRS Gap Analysis — Zero@Hospital', 36, y); y+=20
        doc.setFont('helvetica','normal'); doc.setFontSize(10)
        doc.text(new Date().toLocaleString(),36,y); y+=16
        const pdf = doc.output('datauristring').split(',')[1]
        const elSel = document.getElementById('esrsGrpSel'); const name = (elSel && elSel.value) || ''
        if (!name) { qs('#schedulesMsg').textContent = 'Select group'; return }
        await apiFetch('/api/notify/send-group', { method:'POST', body: JSON.stringify({ name, subject:'ESRS Gap', body:'Attached ESRS gap PDF', attachments:[{ name:'esrs_gap.pdf', type:'application/pdf', data: pdf }] }) })
        qs('#schedulesMsg').textContent = 'Email group queued'
      }catch(e){ qs('#schedulesMsg').textContent = String(e.message||e) }
    }
    async function calcSbti(){ try{ const base = +(document.getElementById('sbtiBase').value||0); const start_year = +(document.getElementById('sbtiStart').value||new Date().getFullYear()); const target_year = +(document.getElementById('sbtiTargetYear').value||start_year+5); const target_pct = +(document.getElementById('sbtiTargetPct').value||50); const r = await apiFetch('/api/sbti/trajectory',{ method:'POST', body: JSON.stringify({ base_co2: base, start_year, target_year, target_pct }) }); const arr = Array.isArray(r.trajectory)? r.trajectory: []; qs('#sbtiMsg').textContent = arr.length ? arr.map(x=> `${x.year}: ${x.target_co2} t`).join(' · ') : 'No data' }catch(e){ qs('#sbtiMsg').textContent = String(e.message||e) } }
    async function calcRoi(){ try{ const investment_cost = +(document.getElementById('roiCost').value||0); const energy_saved_kwh_per_year = +(document.getElementById('roiSavedKwh').value||0); const cost_per_kwh = +(document.getElementById('roiPriceKwh').value||0); const r = await apiFetch('/api/finance/roi',{ method:'POST', body: JSON.stringify({ investment_cost, energy_saved_kwh_per_year, cost_per_kwh }) }); qs('#roiMsg').textContent = `Annual savings €${r.annual_savings} · Payback ${r.payback_years} years` }catch(e){ qs('#roiMsg').textContent = String(e.message||e) } }
    let journeySteps = []
    function renderJourneySteps(){ qs('#journeyStepsList').innerHTML = journeySteps.length ? journeySteps.map((s,i)=> `<div class="kpi"><div class="label">${s.type}</div><div class="value">${s.type==='travel'? `${s.mode||'air'} ${s.distance_km||0} km`: s.value}</div><div style="margin-top:6px"><button class="btn" data-delstep="${i}">Remove</button></div></div>`).join('') : '<div class="muted">No steps</div>'; Array.from(qs('#journeyStepsList').querySelectorAll('button[data-delstep]')).forEach(b=> b.addEventListener('click', ()=>{ const i = +b.getAttribute('data-delstep'); journeySteps.splice(i,1); renderJourneySteps() })) }
    function addJourneyStep(){ const type = document.getElementById('jStepType').value; if (type==='travel'){ const mode = document.getElementById('jTravelMode').value; const haul = document.getElementById('jTravelHaul').value; const cls = document.getElementById('jTravelClass').value; const km = +(document.getElementById('jStepValue').value||0); journeySteps.push({ type:'travel', mode, haul, class: cls, distance_km: km }) } else { const value = +(document.getElementById('jStepValue').value||0); journeySteps.push({ type, value }) } renderJourneySteps() }
    async function calcJourney(){ try{ const r = await apiFetch('/api/journeys/calc',{ method:'POST', body: JSON.stringify({ steps: journeySteps }) }); qs('#journeyMsg').textContent = `Total ${r.tCO2e} tCO₂e (energy ${r.breakdown.energy.toFixed? r.breakdown.energy.toFixed(3): r.breakdown.energy}, water ${r.breakdown.water.toFixed? r.breakdown.water.toFixed(3): r.breakdown.water}, waste ${r.breakdown.waste.toFixed? r.breakdown.waste.toFixed(3): r.breakdown.waste}, medw ${r.breakdown.medw.toFixed? r.breakdown.medw.toFixed(3): r.breakdown.medw}, travel ${r.breakdown.travel.toFixed? r.breakdown.travel.toFixed(3): r.breakdown.travel})` }catch(e){ qs('#journeyMsg').textContent = String(e.message||e) } }
    async function saveJourney(){ try{ const patient = String(document.getElementById('jPatient').value||'').trim(); const hospital = String(document.getElementById('jHospital').value||'').trim(); const dept = String(document.getElementById('jDept').value||'').trim(); const calc = await apiFetch('/api/journeys/calc',{ method:'POST', body: JSON.stringify({ steps: journeySteps }) }); const tCO2e = calc.tCO2e||0; await apiFetch('/api/journeys',{ method:'POST', body: JSON.stringify({ patient, hospital, dept, steps: journeySteps, tCO2e }) }); document.getElementById('jPatient').value=''; document.getElementById('jHospital').value=''; document.getElementById('jDept').value=''; journeySteps = []; renderJourneySteps(); qs('#journeyMsg').textContent = 'Saved journey'; listJourneys() }catch(e){ qs('#journeyMsg').textContent = String(e.message||e) } }
    async function listJourneys(){ try{ const j = await apiFetch('/api/journeys',{ method:'GET' }); const arr = Array.isArray(j.journeys)? j.journeys: []; qs('#journeysList').innerHTML = arr.length ? arr.map(x=> `<div class="kpi"><div class="label">${x.patient||'—'} · ${x.hospital||'—'} · ${x.dept||'—'}</div><div class="value">${x.tCO2e||0} tCO₂e</div><div class="delta">${new Date(x.created_at).toLocaleString()}</div></div>`).join('') : '<div class="muted">No journeys</div>' }catch(e){ qs('#journeysList').textContent = String(e.message||e) } }
    async function runBenchmark(){ try{ const dept = document.getElementById('deptSel').value||''; const metric = document.getElementById('bmMetric').value; const country = ''; const r = await apiFetch(`/api/benchmark/peers?dept=${encodeURIComponent(dept)}&metric=${encodeURIComponent(metric)}&country=${encodeURIComponent(country)}`, { method:'GET' }); const arr = Array.isArray(r.peers)? r.peers: []; const hosp = document.getElementById('hospSel').value||''; qs('#bmPeersList').innerHTML = arr.length ? arr.map(p=> `<div class="kpi"><div class="label">${p.hospital}</div><div class="value">${p.value.toFixed? p.value.toFixed(3): p.value}</div><div class="delta">rank ${p.rank}/${arr.length} · ${p.percentile}%</div>${p.hospital===hosp? '<div class="delta">selected</div>':''}</div>`).join('') : '<div class="muted">No peers</div>'; qs('#bmMsg').textContent = `${arr.length} peers` }catch(e){ qs('#bmMsg').textContent = String(e.message||e) } }
    async function getBenchmarkTips(){ try{ const dept = document.getElementById('deptSel').value||''; const metric = document.getElementById('bmMetric').value; const hospital = document.getElementById('hospSel').value||''; const r = await apiFetch('/api/benchmark/recommendations',{ method:'POST', body: JSON.stringify({ dept, hospital, metric }) }); qs('#bmMsg').textContent = `Tip: ${r.tip}; target avg: ${r.target}` }catch(e){ qs('#bmMsg').textContent = String(e.message||e) } }
    async function saveSupplier(){ try{ const name = String(document.getElementById('supName').value||'').trim(); const co2e_score = +(document.getElementById('supCo2e').value||0); const certificates = String(document.getElementById('supCerts').value||'').split(',').map(s=> s.trim()).filter(Boolean); const itemName = String(document.getElementById('itemName').value||'').trim(); const itemCategory = String(document.getElementById('itemCategory').value||'').trim(); const itemKg = +(document.getElementById('itemKgCo2e').value||0); const items = itemName? [{ name:itemName, category:itemCategory, kgco2e:itemKg }]: []; await apiFetch('/api/procurement/suppliers',{ method:'POST', body: JSON.stringify({ name, co2e_score, certificates, items }) }); document.getElementById('supName').value=''; document.getElementById('supCo2e').value=''; document.getElementById('supCerts').value=''; document.getElementById('itemName').value=''; document.getElementById('itemCategory').value=''; document.getElementById('itemKgCo2e').value=''; qs('#procSupMsg').textContent='Saved'; listSuppliers(); listProcScores() }catch(e){ qs('#procSupMsg').textContent = String(e.message||e) } }
    async function listSuppliers(){ try{ const j = await apiFetch('/api/procurement/suppliers',{ method:'GET' }); const arr = Array.isArray(j.suppliers)? j.suppliers: []; qs('#procSupMsg').textContent = `${arr.length} supplier(s)` }catch(e){ qs('#procSupMsg').textContent = String(e.message||e) } }
    async function listProcScores(){ try{ const r = await apiFetch('/api/procurement/scores',{ method:'GET' }); const arr = Array.isArray(r.scores)? r.scores: []; qs('#procScoresList').innerHTML = arr.length ? arr.map(s=> `<div class="kpi"><div class="label">${s.name}</div><div class="value">score ${s.score}</div><div class="delta">base ${s.co2e} · certs ${s.certs}</div></div>`).join('') : '<div class="muted">No scores</div>' }catch(e){ qs('#procScoresList').textContent = String(e.message||e) } }
    async function getProcRecommendations(){ try{ const category = String(document.getElementById('recCategory').value||'').trim(); const r = await apiFetch('/api/procurement/recommendations',{ method:'POST', body: JSON.stringify({ category }) }); const tips = Array.isArray(r.tips)? r.tips: []; qs('#procTipsList').innerHTML = tips.length ? tips.map(t=> `<div class="kpi"><div class="label">${t.item}</div><div class="value">${t.kgco2e} kgCO₂e</div><div class="delta">${t.supplier}</div></div>`).join('') : '<div class="muted">No tips</div>' }catch(e){ qs('#procTipsList').textContent = String(e.message||e) } }
    async function loadRadarScores(){ try{ const elRC = document.getElementById('radarCampusSel'); const campus = String((elRC && elRC.value)||'').trim(); const r = await apiFetch('/api/radar/scores'+(campus? ('?campus='+encodeURIComponent(campus)) : ''),{ method:'GET' }); const arr = Array.isArray(r.frameworks)? r.frameworks: []; const prefix = r.campus? (`Campus ${r.campus} · `) : ''; qs('#radarScoresList').innerHTML = arr.length ? arr.map(f=> { const pill = (+f.score)<70? '<span class="pill warn">Needs Attention</span>' : '<span class="pill">OK</span>'; return `<div class="kpi"><div class="label">${f.name}</div><div class="value">${f.score}% ${pill}</div></div>` }).join('') : '<div class="muted">No scores</div>'; qs('#radarMsg').textContent = `${prefix}${arr.length} frameworks` }catch(e){ qs('#radarMsg').textContent = String(e.message||e) } }
    async function populateRadarCampus(){ try{ const j = await apiFetch('/api/campus/defs',{ method:'GET' }); const arr = Array.isArray(j.campuses)? j.campuses: []; const el = document.getElementById('radarCampusSel'); if (el){ el.innerHTML = '<option value="">All Campuses</option>' + arr.map(c=> `<option value="${c.name}">${c.name}</option>`).join('') } }catch(_){ }
    async function getRadarRecommendations(){ try{ const r = await apiFetch('/api/radar/recommendations',{ method:'GET' }); const tips = Array.isArray(r.tips)? r.tips: []; qs('#radarMsg').textContent = tips.length ? tips.map(t=> `${t.framework}: ${t.tip}`).join(' · ') : 'No tips' }catch(e){ qs('#radarMsg').textContent = String(e.message||e) } }
    async function saveRadarAction(){ try{ const framework = String(document.getElementById('radarFramework').value||'').trim(); const action = String(document.getElementById('radarAction').value||'').trim(); const owner = String(document.getElementById('radarOwner').value||'').trim(); const due = String(document.getElementById('radarDue').value||'').trim(); await apiFetch('/api/radar/actions',{ method:'POST', body: JSON.stringify({ framework, action, owner, due }) }); document.getElementById('radarFramework').value=''; document.getElementById('radarAction').value=''; document.getElementById('radarOwner').value=''; document.getElementById('radarDue').value=''; listRadarActions() }catch(e){ qs('#radarMsg').textContent = String(e.message||e) } }
    async function listRadarActions(){ try{ const j = await apiFetch('/api/radar/actions',{ method:'GET' }); const arr = Array.isArray(j.actions)? j.actions: []; qs('#radarActionsList').innerHTML = arr.length ? arr.map(a=> `<div class="kpi"><div class="label">${a.framework}</div><div class="value">${a.action}</div><div class="delta">${a.owner||'—'} · ${a.due||'—'} · ${new Date(a.created_at).toLocaleString()}</div></div>`).join('') : '<div class="muted">No actions</div>' }catch(e){ qs('#radarActionsList').textContent = String(e.message||e) } }
    async function listDnsh(){ try{ const j = await apiFetch('/api/dnsh/checklist',{ method:'GET' }); const arr = Array.isArray(j.items)? j.items: []; qs('#dnshList').innerHTML = arr.length ? arr.map(it=> `<div class="kpi"><div class="label">${it.area}</div><div class="value">${it.status}</div><div class="delta">${it.name} · ${it.owner||'—'} ${it.due? ' · '+it.due:''}</div><div style="margin-top:6px"><button class="btn" data-dnshdel="${it.code}">Delete</button></div></div>`).join('') : '<div class="muted">No items</div>'; Array.from(qs('#dnshList').querySelectorAll('button[data-dnshdel]')).forEach(b=> b.addEventListener('click', async ()=>{ const code = b.getAttribute('data-dnshdel'); await apiFetch('/api/dnsh/checklist?code='+encodeURIComponent(code), { method:'DELETE' }); listDnsh() })) }catch(e){ qs('#schedulesMsg').textContent = String(e.message||e) }
    async function saveDnsh(){ try{ const area = String(document.getElementById('dnshArea').value||'').trim(); const name = String(document.getElementById('dnshName').value||'').trim(); const status = String(document.getElementById('dnshStatus').value||'').trim(); const owner = String(document.getElementById('dnshOwner').value||'').trim(); const due = String(document.getElementById('dnshDue').value||'').trim(); if (!area||!name) return; await apiFetch('/api/dnsh/checklist',{ method:'POST', body: JSON.stringify({ area, name, status, owner, due }) }); document.getElementById('dnshArea').value=''; document.getElementById('dnshName').value=''; document.getElementById('dnshOwner').value=''; document.getElementById('dnshDue').value=''; listDnsh() }catch(e){ qs('#schedulesMsg').textContent = String(e.message||e) } }
    async function listEsrs(){ try{ const j = await apiFetch('/api/esrs/checklist',{ method:'GET' }); const arr = Array.isArray(j.items)? j.items: []; qs('#esrsList').innerHTML = arr.length ? arr.map(it=> `<div class="kpi"><div class="label">${it.code}</div><div class="value">${it.status}</div><div class="delta">${it.name} · ${it.owner||'—'} ${it.due? ' · '+it.due:''}</div><div style="margin-top:6px"><button class="btn" data-esrsdel="${it.code}">Delete</button></div></div>`).join('') : '<div class="muted">No items</div>'; Array.from(qs('#esrsList').querySelectorAll('button[data-esrsdel]')).forEach(b=> b.addEventListener('click', async ()=>{ const code = b.getAttribute('data-esrsdel'); await apiFetch('/api/esrs/checklist?code='+encodeURIComponent(code), { method:'DELETE' }); listEsrs() })) }catch(e){ qs('#schedulesMsg').textContent = String(e.message||e) }
    async function saveEsrs(){ try{ const code = String(document.getElementById('esrsCode').value||'').trim(); const name = String(document.getElementById('esrsName').value||'').trim(); const status = String(document.getElementById('esrsStatus').value||'').trim(); const owner = String(document.getElementById('esrsOwner').value||'').trim(); const due = String(document.getElementById('esrsDue').value||'').trim(); if (!code||!name) return; await apiFetch('/api/esrs/checklist',{ method:'POST', body: JSON.stringify({ code, name, status, owner, due }) }); document.getElementById('esrsCode').value=''; document.getElementById('esrsName').value=''; document.getElementById('esrsOwner').value=''; document.getElementById('esrsDue').value=''; listEsrs() }catch(e){ qs('#schedulesMsg').textContent = String(e.message||e) } }

    async function createSchedule(){
      try{
        const template = qs('#schedTemplate').value
        const frequency = qs('#schedFreq').value
        const next_run = String(qs('#schedNext').value||'').trim() || new Date(Date.now()+24*60*60*1000).toISOString()
        const emG = qs('#schedEmailGroup'); const email_group = String((emG && emG.value)||'')
        const emT = qs('#schedEmailTemplate'); const email_template = String((emT && emT.value)||'')
        await apiFetch('/api/reports/schedule', { method:'POST', body: JSON.stringify({ template, frequency, next_run, email_group, email_template }) })
        qs('#schedulesMsg').textContent = 'Scheduled'
        listSchedules()
      }catch(e){ qs('#schedulesMsg').textContent = String(e.message||e) }
    }
    async function listSchedules(){
      try{
        const j = await apiFetch('/api/reports/schedule', { method:'GET' })
        const arr = Array.isArray(j.schedules)? j.schedules : []
        qs('#schedulesMsg').textContent = `${arr.length} schedule(s)`
      }catch(e){ qs('#schedulesMsg').textContent = String(e.message||e) }
    }
    async function listReports(){
      try{
        const j = await apiFetch('/api/reports/list', { method:'GET' })
        const arr = Array.isArray(j.reports)? j.reports : []
        const groupsResp = await apiFetch('/api/notify/groups', { method:'GET' })
        const groups = Array.isArray(groupsResp.groups)? groupsResp.groups : []
        qs('#reportsList').innerHTML = arr.length ? arr.map(r=> {
          const sel = `<select id="grp_${r.id}" class="select" style="max-width:160px">` + groups.map(g=> `<option value="${g.name}">${g.name}</option>`).join('') + `</select>`
          return `<div class="kpi"><div class="label">${r.template}</div><div class="value">${new Date(r.created_at).toLocaleString()}</div><div class="delta">${r.id}</div><div style="margin-top:6px; display:flex; gap:8px"><button class="btn" data-rep="${r.id}">Download</button><button class="btn" data-pdf="${r.id}">Export PDF</button>${sel}<button class="btn" data-emailg="${r.id}">Email Group</button></div></div>`
        }).join('') : '<div class="muted">No reports</div>'
        Array.from(qs('#reportsList').querySelectorAll('button[data-rep]')).forEach(b=> b.addEventListener('click', async ()=>{
          const id = b.getAttribute('data-rep'); const r = await apiFetch('/api/reports/'+id, { method:'GET' }); const blob = new Blob([JSON.stringify(r,null,2)], {type:'application/json'}); const url = URL.createObjectURL(blob); const a = document.createElement('a'); a.href=url; a.download=id+'.json'; a.click(); URL.revokeObjectURL(url);
        }))
        Array.from(qs('#reportsList').querySelectorAll('button[data-pdf]')).forEach(b=> b.addEventListener('click', async ()=>{
          const id = b.getAttribute('data-pdf'); const r = await apiFetch('/api/reports/'+id, { method:'GET' });
          const { jsPDF } = window.jspdf
          const doc = new jsPDF({unit:'pt', format:'a4'})
          let y = 36
          doc.setFont('helvetica','bold'); doc.setFontSize(16)
          doc.text(`Report — ${r.template}`, 36, y); y+=20
          doc.setFont('helvetica','normal'); doc.setFontSize(10)
          doc.text(new Date(r.created_at).toLocaleString(),36,y); y+=16
          doc.text('Summary',36,y); y+=12
          { const sm = r.summary||{}; ['CO₂e: '+(sm.co2||'—'),'Energy: '+(sm.energy||'—'),'Water: '+(sm.water||'—'),'Waste: '+(sm.waste||'—'),'MedWaste: '+(sm.medw||'—')].forEach(l=>{ doc.text(String(l),36,y); y+=12 }) }
          y+=6; doc.text('Scopes',36,y); y+=12
          { const sc = ((r.summary||{}).scope)||{}; ['S1: '+(sc.s1||'—'),'S2: '+(sc.s2||'—'),'S3: '+(sc.s3||'—')].forEach(l=>{ doc.text(String(l),36,y); y+=12 }) }
          doc.save(id+'.pdf')
        }))
        Array.from(qs('#reportsList').querySelectorAll('button[data-emailg]')).forEach(b=> b.addEventListener('click', async ()=>{
          const id = b.getAttribute('data-emailg'); const r = await apiFetch('/api/reports/'+id, { method:'GET' });
          const { jsPDF } = window.jspdf
          const doc = new jsPDF({unit:'pt', format:'a4'})
          let y = 36
          doc.setFont('helvetica','bold'); doc.setFontSize(16)
          doc.text(`Report — ${r.template}`, 36, y); y+=20
          doc.setFont('helvetica','normal'); doc.setFontSize(10)
          doc.text(new Date(r.created_at).toLocaleString(),36,y); y+=16
          doc.text('Summary',36,y); y+=12
          { const sm = r.summary||{}; ['CO₂e: '+(sm.co2||'—'),'Energy: '+(sm.energy||'—'),'Water: '+(sm.water||'—'),'Waste: '+(sm.waste||'—'),'MedWaste: '+(sm.medw||'—')].forEach(l=>{ doc.text(String(l),36,y); y+=12 }) }
          y+=6; doc.text('Scopes',36,y); y+=12
          { const sc = ((r.summary||{}).scope)||{}; ['S1: '+(sc.s1||'—'),'S2: '+(sc.s2||'—'),'S3: '+(sc.s3||'—')].forEach(l=>{ doc.text(String(l),36,y); y+=12 }) }
          const pdf = doc.output('datauristring').split(',')[1]
          const sel = document.getElementById('grp_'+id)
          const name = sel ? sel.value : ''
          if (!name) { qs('#schedulesMsg').textContent = 'Select group'; return }
          await apiFetch('/api/notify/send-group', { method:'POST', body: JSON.stringify({ name, subject: `Report ${id}`, body: 'Auto report', attachments:[{ name: id+'.pdf', type:'application/pdf', data: pdf }] }) })
          qs('#schedulesMsg').textContent = 'Email group queued'
        }))
      }catch(e){ qs('#reportsList').textContent = String(e.message||e) }
    }
    async function runReportNow(){ try{ await apiFetch('/api/reports/generate', { method:'POST', body: JSON.stringify({ template: qs('#schedTemplate').value }) }); listReports() }catch(e){ qs('#schedulesMsg').textContent = String(e.message||e) } }
    async function syncDataset(){ try{ await apiFetch('/api/dataset', { method:'POST', body: JSON.stringify({ rows: state.data }) }); qs('#filesMsg').textContent = 'Synced dataset'; }catch(e){ qs('#filesMsg').textContent = String(e.message||e) } }
    async function saveReading(){ try{ const meter = String(document.getElementById('mrMeter').value||'').trim(); const value = +(document.getElementById('mrValue').value||0); const unit = String(document.getElementById('mrUnit').value||'').trim()||'kWh'; const hospital = String(document.getElementById('mrHospital').value||'').trim(); const dept = String(document.getElementById('mrDept').value||'').trim(); if (!meter) return; await apiFetch('/api/connectors/meter-readings', { method:'POST', body: JSON.stringify({ meter, value, unit, hospital, dept }) }); document.getElementById('mrMeter').value=''; document.getElementById('mrValue').value=''; document.getElementById('mrUnit').value=''; document.getElementById('mrHospital').value=''; document.getElementById('mrDept').value=''; listReadings() }catch(e){ qs('#filesMsg').textContent = String(e.message||e) } }
    async function listReadings(){ try{ const j = await apiFetch('/api/connectors/meter-readings?limit=20', { method:'GET' }); const arr = Array.isArray(j.readings)? j.readings: []; qs('#readingsList').innerHTML = arr.length ? arr.map(r=> `<div class="kpi"><div class="label">${r.meter}</div><div class="value">${fmt(r.value)} ${r.unit}</div><div class="delta">${r.hospital||'—'} · ${r.dept||'—'} · ${new Date(r.t).toLocaleString()}</div></div>`).join('') : '<div class="muted">No readings</div>' }catch(e){ qs('#filesMsg').textContent = String(e.message||e) } }
    async function runPredictFailure(){ try{ const r = await apiFetch('/api/predict/failure',{ method:'GET' }); const arr = Array.isArray(r.predictions)? r.predictions: []; qs('#predictList').innerHTML = arr.length ? arr.map(p=> { const pill = p.risk>=0.8? '<span class="pill warn">High</span>' : p.risk>=0.5? '<span class="pill">Medium</span>' : '<span class="pill">Low</span>'; return `<div class="kpi"><div class="label">${p.meter}</div><div class="value">risk ${Math.round(p.risk*100)}% ${pill}</div><div class="delta">last ${p.last} · μ ${p.mean} · σ ${p.std} · z ${p.z}</div><div style="margin-top:6px"><button class="btn" data-riskmeter="${p.meter}" data-riskval="${p.risk}">Create Task</button></div></div>` }).join('') : '<div class="muted">No predictions</div>'; Array.from(qs('#predictList').querySelectorAll('button[data-riskmeter]')).forEach(b=> b.addEventListener('click', async ()=>{ const meter = b.getAttribute('data-riskmeter'); const risk = +(b.getAttribute('data-riskval')||0); await apiFetch('/api/tasks',{ method:'POST', body: JSON.stringify({ title:`Predictive risk for ${meter}`, dept:'Facilities', assignee:'', status:'open', sla_due: new Date(Date.now()+3*24*60*60*1000).toISOString().slice(0,10), notes:`Risk ${Math.round(risk*100)}%` }) }); listTasks() })) }catch(e){ qs('#predictList').textContent = String(e.message||e) } }
    async function calcTravel(){ try{ const mode = document.getElementById('travelMode').value; const km = +(document.getElementById('travelKm').value||0); const passengers = +(document.getElementById('travelPassengers').value||1); const r = await apiFetch('/api/icao/calc',{ method:'POST', body: JSON.stringify({ mode, distance_km: km, passengers }) }); qs('#travelMsg').textContent = `tCO₂e ${r.tCO2e}`; return r.tCO2e }catch(e){ qs('#travelMsg').textContent = String(e.message||e); return 0 } }
    async function addTravel(){ try{ const tco2 = await calcTravel(); const dept = String(document.getElementById('travelDept').value||'').trim(); const rec = { year: new Date().getFullYear(), hospital: state.filters.hospital||'—', country:'', dept: dept||state.filters.dept||'—', energy:0, water:0, waste:0, medw:0, co2:0, ren:0, rec:0, scope3_extra: tco2 }; state.data.push(rec); saveData(); applyAll(); qs('#travelMsg').textContent = 'Added to dataset' }catch(e){ qs('#travelMsg').textContent = String(e.message||e) } }
    let streamES = null
    function startStream(){ try{ if (streamES) return; streamES = new EventSource(API_BASE+'/api/connectors/stream'); streamES.onmessage = (e)=>{ const d = JSON.parse(e.data||'{}'); const el = qs('#streamBox'); const div = document.createElement('div'); div.className='kpi'; div.innerHTML = `<div class="label">${d.meter}</div><div class="value">${fmt(d.value)} ${d.unit}</div><div class="delta">${new Date(d.t).toLocaleString()}</div>`; el.prepend(div); }; }catch(_){ }
    }
    function stopStream(){ try{ if (streamES){ streamES.close(); streamES=null } }catch(_){ }

    async function loadSettings(){
      try{
        const j = await apiFetch('/api/settings', { method:'GET' })
        const f = (j.factors||{})
        settings.factors = Object.assign({}, settings.factors||{}, f)
        settings.co2Threshold = j.co2Threshold!==undefined ? j.co2Threshold : settings.co2Threshold
        settings.scope_weights = Object.assign({}, settings.scope_weights||{}, j.scope_weights||{})
        const g = settings.factors
        document.getElementById('fEnergyFactor').value = g.energy_kwh_to_tco2e!==undefined ? g.energy_kwh_to_tco2e : ''
        document.getElementById('fWaterFactor').value = g.water_m3_to_tco2e!==undefined ? g.water_m3_to_tco2e : ''
        document.getElementById('fWasteFactor').value = g.waste_kg_to_tco2e!==undefined ? g.waste_kg_to_tco2e : ''
        document.getElementById('fMedwFactor').value = g.medw_kg_to_tco2e!==undefined ? g.medw_kg_to_tco2e : ''
        document.getElementById('fCo2Threshold').value = settings.co2Threshold
        document.getElementById('fScope1').value = (settings.scope_weights && settings.scope_weights.s1!==undefined) ? settings.scope_weights.s1 : ''
        document.getElementById('fScope2').value = (settings.scope_weights && settings.scope_weights.s2!==undefined) ? settings.scope_weights.s2 : ''
        qs('#settingsMsg').textContent = 'Loaded'
        applyAll()
      }catch(e){ qs('#settingsMsg').textContent = String(e.message||e) }
    }
    async function saveSettings(){
      try{
        const payload = {
          factors: {
            energy_kwh_to_tco2e: +document.getElementById('fEnergyFactor').value || undefined,
            water_m3_to_tco2e: +document.getElementById('fWaterFactor').value || undefined,
            waste_kg_to_tco2e: +document.getElementById('fWasteFactor').value || undefined,
            medw_kg_to_tco2e: +document.getElementById('fMedwFactor').value || undefined,
          },
          co2Threshold: +document.getElementById('fCo2Threshold').value || undefined,
          scope_weights: {
            s1: +document.getElementById('fScope1').value || undefined,
            s2: +document.getElementById('fScope2').value || undefined,
          }
        }
        await apiFetch('/api/settings', { method:'POST', body: JSON.stringify(payload) })
        qs('#settingsMsg').textContent = 'Saved'
        loadSettings()
      }catch(e){ qs('#settingsMsg').textContent = String(e.message||e) }
    }
    async function listFactorProfiles(){
      try{
        const r = await apiFetch('/api/factors', { method:'GET' })
        const arr = Array.isArray(r.profiles)? r.profiles : []
        qs('#factorProfilesList').innerHTML = arr.length ? arr.map(p=> `<div class="kpi"><div class="label">${p.hospital} · ${p.dept}</div><div class="value">energy ${p.factors.energy_kwh_to_tco2e||'—'}</div><div class="delta">water ${p.factors.water_m3_to_tco2e||'—'} · waste ${p.factors.waste_kg_to_tco2e||'—'} · medw ${p.factors.medw_kg_to_tco2e||'—'}</div><div class="delta">s1 ${(p.scope_weights && p.scope_weights.s1!=null)? p.scope_weights.s1 : '—'} · s2 ${(p.scope_weights && p.scope_weights.s2!=null)? p.scope_weights.s2 : '—'}</div><div style="margin-top:6px"><button class="btn" data-del-h="${p.hospital}" data-del-d="${p.dept}">Delete</button></div></div>`).join('') : '<div class="muted">No profiles</div>'
        Array.from(qs('#factorProfilesList').querySelectorAll('button[data-del-h]')).forEach(b=> b.addEventListener('click', async ()=>{ const h = b.getAttribute('data-del-h'); const d = b.getAttribute('data-del-d'); try{ await apiFetch(`/api/factors?hospital=${encodeURIComponent(h)}&dept=${encodeURIComponent(d)}`, { method:'DELETE' }) }catch(_){ } listFactorProfiles() }))
      }catch(e){ qs('#factorProfilesList').textContent = String(e.message||e) }
    }
    async function saveFactorProfile(){
      try{
        const hospital = String(document.getElementById('fpHospital').value||'').trim()
        const dept = String(document.getElementById('fpDept').value||'').trim()
        const factors = {
          energy_kwh_to_tco2e: +document.getElementById('fpEnergy').value || undefined,
          water_m3_to_tco2e: +document.getElementById('fpWater').value || undefined,
          waste_kg_to_tco2e: +document.getElementById('fpWaste').value || undefined,
          medw_kg_to_tco2e: +document.getElementById('fpMedw').value || undefined,
        }
        const scope_weights = {
          s1: +document.getElementById('fpScope1W').value || undefined,
          s2: +document.getElementById('fpScope2W').value || undefined,
        }
        if (!hospital || !dept) return
        await apiFetch('/api/factors', { method:'POST', body: JSON.stringify({ hospital, dept, factors, scope_weights }) })
        document.getElementById('fpHospital').value=''; document.getElementById('fpDept').value=''; document.getElementById('fpEnergy').value=''; document.getElementById('fpWater').value=''; document.getElementById('fpWaste').value=''; document.getElementById('fpMedw').value=''
        document.getElementById('fpScope1W').value=''; document.getElementById('fpScope2W').value=''
        listFactorProfiles()
      }catch(e){ qs('#settingsMsg').textContent = String(e.message||e) }
    }

    async function listGroups(){
      try{
        const j = await apiFetch('/api/notify/groups', { method:'GET' })
        const arr = Array.isArray(j.groups)? j.groups : []
        const html = arr.length ? arr.map(g=> `<div class="kpi"><div class="label">${g.name}</div><div class="value">${g.emails.join(', ')}</div><div class="delta">${g.emails.length} recipients</div><div style="margin-top:6px"><button class="btn" data-gname="${g.name}">Delete</button></div></div>`).join('') : '<div class="muted">No groups</div>'
        qs('#groupsList').innerHTML = html
        Array.from(qs('#groupsList').querySelectorAll('button[data-gname]')).forEach(b=> b.addEventListener('click', async ()=>{ const name = b.getAttribute('data-gname'); await apiFetch('/api/notify/groups?name='+encodeURIComponent(name), { method:'DELETE' }); listGroups() }))
      }catch(e){ qs('#groupsList').textContent = String(e.message||e) }
    }
    async function saveGroup(){
      try{
        const name = String(document.getElementById('grpName').value||'').trim()
        const emails = String(document.getElementById('grpEmails').value||'').trim()
        if (!name || !emails) return
        await apiFetch('/api/notify/groups', { method:'POST', body: JSON.stringify({ name, emails }) })
        document.getElementById('grpName').value=''; document.getElementById('grpEmails').value=''
        listGroups()
      }catch(e){ qs('#settingsMsg').textContent = String(e.message||e) }
    }
    async function listTemplates(){
      try{
        const j = await apiFetch('/api/notify/templates', { method:'GET' })
        const arr = Array.isArray(j.templates)? j.templates : []
        qs('#templatesList').innerHTML = arr.length ? arr.map(t=> `<div class="kpi"><div class="label">${t.name}</div><div class="value">${t.subject}</div><div class="delta">${t.body.slice(0,80)}...</div><div style="margin-top:6px"><button class="btn" data-tmpl="${t.name}">Delete</button></div></div>`).join('') : '<div class="muted">No templates</div>'
        Array.from(qs('#templatesList').querySelectorAll('button[data-tmpl]')).forEach(b=> b.addEventListener('click', async ()=>{ const name = b.getAttribute('data-tmpl'); await apiFetch('/api/notify/templates?name='+encodeURIComponent(name), { method:'DELETE' }); listTemplates() }))
      }catch(e){ qs('#templatesList').textContent = String(e.message||e) }
    }
    async function saveTemplate(){
      try{
        const name = String(document.getElementById('tmplName').value||'').trim()
        const subject = String(document.getElementById('tmplSubject').value||'').trim()
        const body = String(document.getElementById('tmplBody').value||'').trim()
        if (!name || !subject || !body) return
        await apiFetch('/api/notify/templates', { method:'POST', body: JSON.stringify({ name, subject, body }) })
        document.getElementById('tmplName').value=''; document.getElementById('tmplSubject').value=''; document.getElementById('tmplBody').value=''
        listTemplates()
      }catch(e){ qs('#settingsMsg').textContent = String(e.message||e) }
    }
    async function listEscRules(){
      try{
        const j = await apiFetch('/api/escalation/rules', { method:'GET' })
        const arr = Array.isArray(j.rules)? j.rules : []
        qs('#escRulesList').innerHTML = arr.length ? arr.map(r=> `<div class="kpi"><div class="label">${r.name}</div><div class="value">${r.dept||'—'} · ${r.overdue_days}d</div><div class="delta">${r.group} · ${r.template} · ${r.assignee||'—'}</div><div style="margin-top:6px"><button class="btn" data-escdel="${r.name}">Delete</button></div></div>`).join('') : '<div class="muted">No rules</div>'
        Array.from(qs('#escRulesList').querySelectorAll('button[data-escdel]')).forEach(b=> b.addEventListener('click', async ()=>{ const name = b.getAttribute('data-escdel'); await apiFetch('/api/escalation/rules?name='+encodeURIComponent(name), { method:'DELETE' }); listEscRules() }))
      }catch(e){ qs('#escRulesList').textContent = String(e.message||e) }
    }
    async function saveEscRule(){
      try{
        const name = String(document.getElementById('escName').value||'').trim()
        const dept = String(document.getElementById('escDept').value||'').trim()
        const overdue_days = Math.max(0, +(document.getElementById('escOverdue').value||0))
        const group = String(document.getElementById('escGroup').value||'').trim()
        const template = String(document.getElementById('escTemplate').value||'').trim()
        const assignee = String(document.getElementById('escAssignee').value||'').trim()
        if (!name || !overdue_days || !group || !template) return
        await apiFetch('/api/escalation/rules', { method:'POST', body: JSON.stringify({ name, dept, overdue_days, group, template, assignee }) })
        document.getElementById('escName').value=''; document.getElementById('escDept').value=''; document.getElementById('escOverdue').value=''; document.getElementById('escGroup').value=''; document.getElementById('escTemplate').value=''; document.getElementById('escAssignee').value=''
        listEscRules()
      }catch(e){ qs('#schedulesMsg').textContent = String(e.message||e) }
    }
    async function saveProcProfile(){
      try{
        const name = String(document.getElementById('procName').value||'').trim()
        const dept = String(document.getElementById('procDept').value||'').trim()
        const energy = +(document.getElementById('procEnergy').value||0)
        const sterilF = +(document.getElementById('procSterilFactor').value||0.5)
        const staffF = +(document.getElementById('procStaffFactor').value||0.0)
        const consCsv = String(document.getElementById('procConsumables').value||'').trim()
        const consumables = consCsv ? consCsv.split(/\n|,/).map(s=> s.trim()).filter(Boolean).map(s=>{ const [n,v] = s.split(':'); return { name:String(n||'').trim(), kgco2e:+(v||0) } }) : []
        await apiFetch('/api/procedures/profiles',{ method:'POST', body: JSON.stringify({ name, dept, factors:{ energy_kwh: energy, sterilization_factor_kgco2e_per_cycle: sterilF, staff_factor_kgco2e_per_hour: staffF, consumables } }) })
        document.getElementById('procName').value=''; document.getElementById('procDept').value=''; document.getElementById('procEnergy').value=''; document.getElementById('procSterilFactor').value=''; document.getElementById('procStaffFactor').value=''; document.getElementById('procConsumables').value=''
        qs('#procMsg').textContent = 'Saved profile'
        listProcProfiles()
      }catch(e){ qs('#procMsg').textContent = String(e.message||e) }
    }
    async function listProcProfiles(){
      try{
        const j = await apiFetch('/api/procedures/profiles',{ method:'GET' })
        const arr = Array.isArray(j.profiles)? j.profiles: []
        qs('#procProfilesList').innerHTML = arr.length ? arr.map(p=> `<div class="kpi"><div class="label">${p.name}</div><div class="value">${p.dept||'—'}</div><div class="delta">energy ${((p.factors&&p.factors.energy_kwh)||0)} kWh</div></div>`).join('') : '<div class="muted">No profiles</div>'
      }catch(e){ qs('#procProfilesList').textContent = String(e.message||e) }
    }
    async function loadProcBenchmarks(){
      try{
        const j = await apiFetch('/api/procedures/benchmarks',{ method:'GET' })
        const arr = Array.isArray(j.benchmarks)? j.benchmarks: []
        qs('#procBenchList').innerHTML = arr.length ? arr.map(b=> `<div class="kpi"><div class="label">${b.name}</div><div class="value">${b.tCO2e} tCO₂e</div></div>`).join('') : '<div class="muted">No benchmarks</div>'
      }catch(e){ qs('#procBenchList').textContent = String(e.message||e) }
    }
    async function calcProcCo2(){
      try{
        const name = String(document.getElementById('calcName').value||'').trim()
        const energy_kwh = +(document.getElementById('calcEnergy').value||0)
        const sterilization_cycles = +(document.getElementById('calcSterilCycles').value||0)
        const staff_hours = +(document.getElementById('calcStaffHours').value||0)
        const useCsv = String(document.getElementById('calcConsumables').value||'').trim()
        const consumables = useCsv ? useCsv.split(/\n|,/).map(s=> s.trim()).filter(Boolean).map(s=>{ const [n,q] = s.split(':'); return { name:String(n||'').trim(), qty:+(q||1), kgco2e:0 } }) : []
        const profs = await apiFetch('/api/procedures/profiles',{ method:'GET' })
        const pf = (Array.isArray(profs.profiles)? profs.profiles: []).find(p=> p.name===name)
        const pfF = (pf && pf.factors) || {}
        const staff_factor_kgco2e_per_hour = pfF.staff_factor_kgco2e_per_hour || 0
        const sterilization_factor_kgco2e_per_cycle = pfF.sterilization_factor_kgco2e_per_cycle || 0.5
        const consResolved = consumables.map(u=>{ const cons = pfF.consumables || []; const base = cons.find(c=> c.name===u.name); return { name:u.name, qty:u.qty, kgco2e: base ? base.kgco2e : 0 } })
        const r = await apiFetch('/api/procedures/calc',{ method:'POST', body: JSON.stringify({ energy_kwh, sterilization_cycles, staff_hours, staff_factor_kgco2e_per_hour, sterilization_factor_kgco2e_per_cycle, consumables: consResolved }) })
        qs('#calcProcMsg').textContent = `Total ${r.tCO2e} tCO₂e (energy ${r.breakdown.energy.toFixed? r.breakdown.energy.toFixed(3): r.breakdown.energy}, steril ${r.breakdown.steril.toFixed? r.breakdown.steril.toFixed(3): r.breakdown.steril}, staff ${r.breakdown.staff.toFixed? r.breakdown.staff.toFixed(3): r.breakdown.staff}, cons ${r.breakdown.consumables.toFixed? r.breakdown.consumables.toFixed(3): r.breakdown.consumables})`
      }catch(e){ qs('#calcProcMsg').textContent = String(e.message||e) }
    }
    async function loadSec(){ try{ const j = await apiFetch('/api/security/config',{ method:'GET' }); document.getElementById('secWindowMs').value = j.windowMs||60000; document.getElementById('secMax').value = j.max||120; document.getElementById('secTtlH').value = j.session_ttl_hours||12; document.getElementById('secPwMin').value = j.password_min||8 }catch(e){ qs('#settingsMsg').textContent = String(e.message||e) } }
    async function saveSec(){ try{ const windowMs = +(document.getElementById('secWindowMs').value||60000); const max = +(document.getElementById('secMax').value||120); const session_ttl_hours = +(document.getElementById('secTtlH').value||12); const password_min = +(document.getElementById('secPwMin').value||8); await apiFetch('/api/security/config',{ method:'POST', body: JSON.stringify({ windowMs, max, session_ttl_hours, password_min }) }); qs('#settingsMsg').textContent = 'Security saved' }catch(e){ qs('#settingsMsg').textContent = String(e.message||e) } }
    async function runEscalationNow(){ try{ const r = await apiFetch('/api/escalation/run', { method:'POST' }); qs('#schedulesMsg').textContent = `Escalated ${r.escalated||0}, emailed ${r.emailed||0}`; listTasks() }catch(e){ qs('#schedulesMsg').textContent = String(e.message||e) } }
    async function listOutbox(){ try{ const j = await apiFetch('/api/email/outbox', { method:'GET' }); const arr = Array.isArray(j.outbox)? j.outbox : []; qs('#outboxList').innerHTML = arr.length ? arr.map(x=> `<div class="kpi"><div class="label">${x.subject}</div><div class="value">${x.to}</div><div class="delta">${new Date(x.created_at).toLocaleString()}</div><div style="margin-top:6px"><button class="btn" data-outid="${x.id}">Delete</button></div></div>`).join('') : '<div class="muted">Outbox empty</div>'; Array.from(qs('#outboxList').querySelectorAll('button[data-outid]')).forEach(b=> b.addEventListener('click', async ()=>{ const id = b.getAttribute('data-outid'); await apiFetch('/api/email/outbox?id='+encodeURIComponent(id), { method:'DELETE' }); listOutbox() })) }catch(e){ qs('#outboxList').textContent = String(e.message||e) } }
    async function sendOutbox(){ try{ const r = await apiFetch('/api/email/send-outbox', { method:'POST' }); qs('#schedulesMsg').textContent = `Sent ${r.sent||0}`; listOutbox(); listSent(); }catch(e){ qs('#schedulesMsg').textContent = String(e.message||e) } }
    async function listSent(){ try{ const j = await apiFetch('/api/email/sent', { method:'GET' }); const arr = Array.isArray(j.sent)? j.sent : []; qs('#sentList').innerHTML = arr.length ? arr.map(x=> `<div class="kpi"><div class="label">${x.subject}</div><div class="value">${x.to}</div><div class="delta">${new Date(x.sent_at||x.created_at).toLocaleString()}</div></div>`).join('') : '<div class="muted">No sent emails</div>' }catch(e){ qs('#sentList').textContent = String(e.message||e) } }
    async function saveSmtp(){ try{ const host = String(document.getElementById('smtpHost').value||'').trim(); const port = +(document.getElementById('smtpPort').value||0); const user = String(document.getElementById('smtpUser').value||'').trim(); const pass = String(document.getElementById('smtpPass').value||'').trim(); await apiFetch('/api/email/smtp-config', { method:'POST', body: JSON.stringify({ host, port, user, pass }) }); qs('#schedulesMsg').textContent = 'SMTP saved' }catch(e){ qs('#schedulesMsg').textContent = String(e.message||e) } }
    async function loadSmtp(){ try{ const j = await apiFetch('/api/email/smtp-config', { method:'GET' }); document.getElementById('smtpHost').value = j.host||''; document.getElementById('smtpPort').value = j.port||0; document.getElementById('smtpUser').value = j.user||''; document.getElementById('smtpPass').value = j.pass||''; }catch(e){ qs('#schedulesMsg').textContent = String(e.message||e) } }

    async function loadHealth(){ try{ const j = await apiFetch('/api/health',{ method:'GET' }); const checks = j.checks||{}; const app = j.app||{}; const fs = checks.filesystem||{}; const df = checks.dataFolder||{}; qs('#healthBox').innerHTML = `<div class=\"kpi\"><div class=\"label\">Status</div><div class=\"value\">${j.status||'—'}</div><div class=\"delta\">uptime ${app.uptime_sec||0}s</div></div><div class=\"kpi\"><div class=\"label\">Filesystem</div><div class=\"value\">${fs.free_mb||0} MB free</div></div><div class=\"kpi\"><div class=\"label\">Data</div><div class=\"value\">${df.status||'—'}</div><div class=\"delta\">R:${df.readable?'Y':'N'} W:${df.writable?'Y':'N'}</div></div>` }catch(e){ qs('#healthBox').textContent = String(e.message||e) } }
    async function loadOpsSummary(){ try{ const j = await apiFetch('/api/ops/summary',{ method:'GET' }); const top = Array.isArray(j.top_endpoints)? j.top_endpoints: []; const hi = Array.isArray(j.high_latency)? j.high_latency: []; qs('#opsSummaryBox').innerHTML = `<div class=\"kpi\"><div class=\"label\">Requests</div><div class=\"value\">${j.total_requests||0}</div><div class=\"delta\">window ${j.window_hours||24}h</div></div>` + (top.slice(0,5).map(t=> `<div class=\"kpi\"><div class=\"label\">${t.path}</div><div class=\"value\">${t.count}</div><div class=\"delta\">p95 ${t.p95_ms}ms · err ${t.error_rate}</div></div>`).join('')) + `<div class=\"muted\" style=\"margin-top:8px\">High p95: ${hi.map(h=> h.path+':'+h.p95_ms+'ms').join(' · ')}</div>` }catch(e){ qs('#opsSummaryBox').textContent = String(e.message||e) } }
    async function listOpsAlerts(){ try{ const j = await apiFetch('/api/ops/alerts',{ method:'GET' }); const arr = Array.isArray(j.alerts)? j.alerts: []; qs('#opsAlertsList').innerHTML = arr.length ? arr.map(a=> { const d=a.data||{}; return `<div class=\"kpi\"><div class=\"label\">${a.type}</div><div class=\"value\">${a.severity}</div><div class=\"delta\">${a.message} · ${d.path||'—'} · p95 ${d.p95_ms||0}ms · ${new Date(a.created_at).toLocaleString()}</div></div>` }).join('') : '<div class=\"muted\">No alerts</div>' }catch(e){ qs('#opsAlertsList').textContent = String(e.message||e) } }
    async function listOpsTickets(){ try{ const j = await apiFetch('/api/ops/tickets',{ method:'GET' }); const arr = Array.isArray(j.tickets)? j.tickets: []; qs('#opsTicketsList').innerHTML = arr.length ? arr.map(t=> { const m=t.metrics||{}; return `<div class=\"kpi\"><div class=\"label\">${t.type}</div><div class=\"value\">${t.status}</div><div class=\"delta\">${t.endpoint} · p95 ${m.p95_ms||0}ms · err ${m.error_rate||0} · ${new Date(t.created_at).toLocaleString()}</div></div>` }).join('') : '<div class=\"muted\">No tickets</div>' }catch(e){ qs('#opsTicketsList').textContent = String(e.message||e) } }
    async function genOpsTickets(){ try{ const r = await apiFetch('/api/ops/tickets/generate',{ method:'POST' }); qs('#opsTicketsList').innerHTML = `<div class=\"muted\">Created ${r.created||0}</div>`; listOpsTickets() }catch(e){ qs('#opsTicketsList').textContent = String(e.message||e) } }
    async function listBackups(){ try{ const j = await apiFetch('/api/ops/backups/list',{ method:'GET' }); const arr = Array.isArray(j.backups)? j.backups: []; qs('#backupsList').innerHTML = arr.length ? arr.map(b=> `<div class=\"kpi\"><div class=\"label\">${b.file}</div><div class=\"value\">${b.size_bytes} bytes</div></div>`).join('') : '<div class=\"muted\">No backups</div>' }catch(e){ qs('#backupsList').textContent = String(e.message||e) } }
    async function listBackupLogs(){ try{ const j = await apiFetch('/api/ops/backup/logs',{ method:'GET' }); const arr = Array.isArray(j.logs)? j.logs: []; qs('#backupLogsList').innerHTML = arr.length ? arr.map(l=> `<div class=\"kpi\"><div class=\"label\">${l.file}</div><div class=\"value\">${l.status}</div><div class=\"delta\">env ${l.env} · ${l.size_bytes} bytes · ${l.ts}</div></div>`).join('') : '<div class=\"muted\">No logs</div>' }catch(e){ qs('#backupLogsList').textContent = String(e.message||e) } }
    async function loadOpsPrefixes(){ try{ const j = await apiFetch('/api/ops/prefixes',{ method:'GET' }); const arr = Array.isArray(j.prefixes)? j.prefixes: []; const el = document.getElementById('advisorPrefixPreset'); if (el){ const opts = ['<option value=\"\">Select prefix…</option>'].concat(arr.map(x=> `<option value=\"${x.prefix}\">${x.prefix} (${x.count})</option>`)); el.innerHTML = opts.join('') } }catch(_){ }
    async function runAdvisor(){ try{ const endpoint = String(document.getElementById('advisorEndpoint').value||'').trim(); const prefix = String(document.getElementById('advisorPrefix').value||'').trim(); if (!endpoint && !prefix) return; const r = await apiFetch('/api/ops/advisory',{ method:'POST', body: JSON.stringify({ endpoint, prefix }) }); const advice = Array.isArray(r.advice)? r.advice: []; qs('#advisorBox').innerHTML = advice.length ? advice.map(t=> `<div class=\"kpi\"><div class=\"label\">Advice</div><div class=\"value\">${t}</div><div class=\"delta\">p95 ${r.p95_ms}ms · err ${r.error_rate} · count ${r.count}</div></div>`).join('') : '<div class=\"muted\">No advice</div>' }catch(e){ qs('#advisorBox').textContent = String(e.message||e) } }
    async function loadOpsCharts(){ try{ const endpoint = String(document.getElementById('advisorEndpoint').value||'').trim(); const prefix = String(document.getElementById('advisorPrefix').value||'').trim(); const thr = +(document.getElementById('opsOutlierThr').value||2000); const q = new URLSearchParams(); if (endpoint) q.set('endpoint', endpoint); if (prefix) q.set('prefix', prefix); const r = await apiFetch('/api/ops/timeseries'+(q.toString()? ('?'+q.toString()): ''),{ method:'GET' }); const labels = Array.isArray(r.labels)? r.labels: []; const p95 = Array.isArray(r.p95_ms)? r.p95_ms: []; const err = Array.isArray(r.error_rate)? r.error_rate: []; const p95ma = Array.isArray(r.p95_ma5)? r.p95_ma5: []; const errma = Array.isArray(r.err_ma5)? r.err_ma5: []; const outliers = p95.map(v=> (v>thr? v: null)); qs('#opsChartLabel').textContent = endpoint? ('Endpoint '+endpoint) : (prefix? ('Prefix '+prefix) : 'All endpoints'); if (window.opsP95Chart){ window.opsP95Chart.destroy(); window.opsP95Chart=null } if (window.opsErrChart){ window.opsErrChart.destroy(); window.opsErrChart=null } window.opsP95Chart = new Chart(document.getElementById('opsP95Chart'),{ type:'line', data:{ labels, datasets:[{ label:'p95 ms', data:p95, tension:.3 },{ label:'p95 ma(5)', data:p95ma, tension:.3 },{ label:'outliers', data: outliers, showLine:false, pointRadius:4 }] }, options:{ plugins:{ legend:{position:'top'} } } }); window.opsErrChart = new Chart(document.getElementById('opsErrChart'),{ type:'line', data:{ labels, datasets:[{ label:'error rate', data: err, tension:.3 },{ label:'err ma(5)', data: errma, tension:.3 }] }, options:{ plugins:{ legend:{position:'top'} }, scales:{ y:{ min:0, max:1 } } } }); }catch(e){ qs('#opsSummaryBox').textContent = String(e.message||e) } }
    function genAdvisorPlan(){ try{ const endpoint = String(document.getElementById('advisorEndpoint').value||'').trim(); const prefix = String(document.getElementById('advisorPrefix').value||'').trim(); const target = endpoint||prefix||''; const items = []; items.push({ title:'Add response caching for heavy endpoints' }); items.push({ title:'Reduce synchronous I/O and batch small writes' }); items.push({ title:'Optimize CSV parsing and validation pipeline' }); items.push({ title:'Add input validation and defensive checks' }); const html = items.map(x=> `<div class=\"kpi\"><div class=\"label\">Action</div><div class=\"value\">${x.title}</div><div class=\"delta\">target ${target||'—'}</div></div>`).join(''); qs('#advisorPlanBox').innerHTML = html; qs('#advisorPlanBox').dataset.items = JSON.stringify(items) }catch(e){ qs('#advisorPlanBox').textContent = String(e.message||e) } }
    async function createOpsActions(){ try{ const endpoint = String(document.getElementById('advisorEndpoint').value||'').trim(); const prefix = String(document.getElementById('advisorPrefix').value||'').trim(); let items = []; try{ const d = qs('#advisorPlanBox').dataset.items; if (d) items = JSON.parse(d) }catch(_){ } if (!items.length) items = [{ title:'Add response caching' },{ title:'Reduce synchronous I/O' }]; const r = await apiFetch('/api/ops/actions/create',{ method:'POST', body: JSON.stringify({ endpoint, prefix, items }) }); qs('#advisorPlanBox').innerHTML = `<div class=\"muted\">Created ${r.created||0} action(s)</div>`; showTab('Actions'); listTasks() }catch(e){ qs('#advisorPlanBox').textContent = String(e.message||e) } }
    function genRollbackCmd(){ try{ const env = document.getElementById('rollbackEnvSel').value||'prod'; const list = qs('#backupsList'); const first = list.querySelector('.kpi .label'); const file = first? first.textContent.trim(): ''; if (!file){ qs('#rollbackCmdBox').textContent = 'Select backups first'; return } const cmd = `./scripts/rollback.sh ${env} ${file}`; qs('#rollbackCmdBox').innerHTML = `<div class=\"kpi\"><div class=\"label\">Command</div><div class=\"value\">${cmd}</div></div>` }catch(e){ qs('#rollbackCmdBox').textContent = String(e.message||e) } }
    async function runLLMAdvisor(){ try{ const endpoint = String(document.getElementById('advisorEndpoint').value||'').trim(); const prefix = String(document.getElementById('advisorPrefix').value||'').trim(); if (!endpoint && !prefix) return; const adv = await apiFetch('/api/ops/advisory',{ method:'POST', body: JSON.stringify({ endpoint, prefix }) }); const target = endpoint? `Endpoint: ${endpoint}` : `Prefix: ${prefix}`; const payload = { model:'claude-3.5-sonnet', max_tokens:512, system:'You are an Ops Advisor for Zero@Hospital. Provide concise, actionable optimization steps for API performance.', messages:[{ role:'user', content:[{ type:'text', text: `${target}\nRequests: ${adv.count}\nP95: ${adv.p95_ms} ms\nError rate: ${adv.error_rate}\nAdvice: ${Array.isArray(adv.advice)? adv.advice.join('; '): adv.advice}` }]}] }; const resp = await apiFetch('/api/chat',{ method:'POST', body: JSON.stringify(payload) }); const text = (resp && Array.isArray(resp.content) && resp.content[0] && resp.content[0].text) ? resp.content[0].text : 'No LLM output'; qs('#llmAdvisorBox').innerHTML = `<div class=\"kpi\"><div class=\"label\">LLM Advisory</div><div class=\"value\">${text}</div></div>` }catch(e){ qs('#llmAdvisorBox').textContent = String(e.message||e) } }

    function populateCarbonHospitals(){ try{ const hosps = unique(state.data, r=>r.hospital).sort(); const el = document.getElementById('cmBalanceHospital'); if (el){ el.innerHTML = hosps.map(h=> `<option value="${h}">${h}</option>`).join('') } }catch(_){ }
    async function saveCarbonGroup(){ try{ const name = String(document.getElementById('cmGroupName').value||'').trim(); const hospitals = String(document.getElementById('cmGroupHospitals').value||'').trim(); if (!name||!hospitals) return; await apiFetch('/api/carbon/groups',{ method:'POST', body: JSON.stringify({ name, hospitals }) }); document.getElementById('cmGroupName').value=''; document.getElementById('cmGroupHospitals').value=''; listCarbonGroups() }catch(e){ qs('#carbonGroupsList').textContent = String(e.message||e) } }
    async function listCarbonGroups(){ try{ const j = await apiFetch('/api/carbon/groups',{ method:'GET' }); const arr = Array.isArray(j.groups)? j.groups: []; qs('#carbonGroupsList').innerHTML = arr.length ? arr.map(g=> `<div class="kpi"><div class="label">${g.name}</div><div class="value">${(g.hospitals||[]).join(', ')}</div><div style="margin-top:6px"><button class="btn" data-delcg="${g.name}">Delete</button></div></div>`).join('') : '<div class="muted">No groups</div>'; Array.from(qs('#carbonGroupsList').querySelectorAll('button[data-delcg]')).forEach(b=> b.addEventListener('click', async ()=>{ const name = b.getAttribute('data-delcg'); await apiFetch('/api/carbon/groups?name='+encodeURIComponent(name), { method:'DELETE' }); listCarbonGroups() })) }catch(e){ qs('#carbonGroupsList').textContent = String(e.message||e) } }
    async function saveQuota(){ try{ const hospital = String(document.getElementById('cmQuotaHospital').value||'').trim(); const year = +(document.getElementById('cmQuotaYear').value||new Date().getFullYear()); const quota_tco2e = +(document.getElementById('cmQuotaT').value||0); if (!hospital || !quota_tco2e) return; await apiFetch('/api/carbon/quotas',{ method:'POST', body: JSON.stringify({ hospital, year, quota_tco2e }) }); document.getElementById('cmQuotaHospital').value=''; document.getElementById('cmQuotaYear').value=''; document.getElementById('cmQuotaT').value=''; listQuotas() }catch(e){ qs('#carbonQuotasList').textContent = String(e.message||e) } }
    async function listQuotas(){ try{ const j = await apiFetch('/api/carbon/quotas',{ method:'GET' }); const arr = Array.isArray(j.quotas)? j.quotas: []; qs('#carbonQuotasList').innerHTML = arr.length ? arr.map(q=> `<div class="kpi"><div class="label">${q.hospital}</div><div class="value">${q.quota_tco2e} t</div><div class="delta">${q.year}</div></div>`).join('') : '<div class="muted">No quotas</div>' }catch(e){ qs('#carbonQuotasList').textContent = String(e.message||e) } }
    async function saveCredit(){ try{ const hospital = String(document.getElementById('cmCreditHospital').value||'').trim(); const amount_tco2e = +(document.getElementById('cmCreditAmount').value||0); const note = String(document.getElementById('cmCreditNote').value||'').trim(); if (!hospital || !amount_tco2e) return; await apiFetch('/api/carbon/credits',{ method:'POST', body: JSON.stringify({ hospital, amount_tco2e, note }) }); document.getElementById('cmCreditHospital').value=''; document.getElementById('cmCreditAmount').value=''; document.getElementById('cmCreditNote').value=''; listCredits() }catch(e){ qs('#carbonCreditsList').textContent = String(e.message||e) } }
    async function listCredits(){ try{ const j = await apiFetch('/api/carbon/credits',{ method:'GET' }); const arr = Array.isArray(j.credits)? j.credits: []; qs('#carbonCreditsList').innerHTML = arr.length ? arr.map(c=> `<div class="kpi"><div class="label">${c.hospital}</div><div class="value">${c.amount_tco2e} t</div><div class="delta">${new Date(c.created_at).toLocaleString()} ${c.note? ' · '+c.note:''}</div></div>`).join('') : '<div class="muted">No credits</div>' }catch(e){ qs('#carbonCreditsList').textContent = String(e.message||e) } }
    async function proposeTrade(){ try{ const from = String(document.getElementById('cmTradeFrom').value||'').trim(); const to = String(document.getElementById('cmTradeTo').value||'').trim(); const amount_tco2e = +(document.getElementById('cmTradeAmount').value||0); const price_eur_per_t = +(document.getElementById('cmTradePrice').value||0); if (!from||!to||!amount_tco2e) return; await apiFetch('/api/carbon/trades',{ method:'POST', body: JSON.stringify({ from, to, amount_tco2e, price_eur_per_t }) }); document.getElementById('cmTradeFrom').value=''; document.getElementById('cmTradeTo').value=''; document.getElementById('cmTradeAmount').value=''; document.getElementById('cmTradePrice').value=''; listTrades() }catch(e){ qs('#carbonTradesList').textContent = String(e.message||e) } }
    async function listTrades(){ try{ const j = await apiFetch('/api/carbon/trades',{ method:'GET' }); const arr = Array.isArray(j.trades)? j.trades: []; qs('#carbonTradesList').innerHTML = arr.length ? arr.map(t=> `<div class=\"kpi\"><div class=\"label\">${t.from} → ${t.to}</div><div class=\"value\">${t.amount_tco2e} t @ €${t.price_eur_per_t||0}/t</div><div class=\"delta\">${t.status} · ${new Date(t.created_at).toLocaleString()}</div>${t.status==='open'? '<div style=\"margin-top:6px\"><button class=\"btn\" data-accepttr=\"'+t.id+'\">Accept</button></div>':''}</div>`).join('') : '<div class="muted">No trades</div>'; Array.from(qs('#carbonTradesList').querySelectorAll('button[data-accepttr]')).forEach(b=> b.addEventListener('click', async ()=>{ const id = b.getAttribute('data-accepttr'); await apiFetch('/api/carbon/trades/'+id, { method:'PATCH', body: JSON.stringify({ status:'accepted' }) }); listTrades() })) }catch(e){ qs('#carbonTradesList').textContent = String(e.message||e) } }
    async function loadBalance(){ try{ const hospital = document.getElementById('cmBalanceHospital').value||''; const r = await apiFetch('/api/carbon/balance?hospital='+encodeURIComponent(hospital), { method:'GET' }); qs('#carbonBalanceBox').innerHTML = `<div class=\"kpi\"><div class=\"label\">${r.hospital||hospital}</div><div class=\"value\">Net ${r.net_t} t</div><div class=\"delta\">emitted ${r.emitted_t} · quota ${r.quota_t} · credits ${r.credit_t} · €${r.value_eur}</div></div>` }catch(e){ qs('#carbonBalanceBox').textContent = String(e.message||e) } }

    async function loadInsuranceCfg(){ try{ const j = await apiFetch('/api/insurance/config',{ method:'GET' }); document.getElementById('insBaseRate').value = j.base_rate_eur||0; document.getElementById('insThreshold').value = j.co2_threshold_t||0; document.getElementById('insBonusPct').value = j.bonus_pct_per_10pct_reduction||0; document.getElementById('insPenaltyPct').value = j.penalty_pct_per_10pct_excess||0; qs('#insuranceCfgMsg').textContent = 'Loaded' }catch(e){ qs('#insuranceCfgMsg').textContent = String(e.message||e) } }
    async function saveInsuranceCfg(){ try{ const base_rate_eur = +(document.getElementById('insBaseRate').value||0); const co2_threshold_t = +(document.getElementById('insThreshold').value||0); const bonus_pct_per_10pct_reduction = +(document.getElementById('insBonusPct').value||0); const penalty_pct_per_10pct_excess = +(document.getElementById('insPenaltyPct').value||0); await apiFetch('/api/insurance/config',{ method:'POST', body: JSON.stringify({ base_rate_eur, co2_threshold_t, bonus_pct_per_10pct_reduction, penalty_pct_per_10pct_excess }) }); qs('#insuranceCfgMsg').textContent = 'Saved' }catch(e){ qs('#insuranceCfgMsg').textContent = String(e.message||e) } }
    async function calcInsuranceImpact(){ try{ const hospital = document.getElementById('hospSel').value||''; const dept = document.getElementById('deptSel').value||''; const base_reimbursement_eur = +(document.getElementById('insBaseReimb').value||0); const baseline_co2_t = +(document.getElementById('insBaselineCo2').value||NaN); const current_co2_t = +(document.getElementById('insCurrentCo2').value||NaN); const r = await apiFetch('/api/insurance/impact',{ method:'POST', body: JSON.stringify({ hospital, dept, base_reimbursement_eur, baseline_co2_t, current_co2_t }) }); qs('#insuranceImpactBox').innerHTML = `<div class=\"kpi\"><div class=\"label\">Reduction</div><div class=\"value\">${r.reduction_pct}%</div><div class=\"delta\">baseline ${r.baseline_co2_t} t · current ${r.current_co2_t} t · threshold ${r.threshold_t} t</div></div><div class=\"kpi\"><div class=\"label\">Reimbursement</div><div class=\"value\">€${r.new_reimbursement_eur}</div><div class=\"delta\">bonus €${r.bonus_eur} · penalty €${r.penalty_eur}</div></div><div class=\"kpi\"><div class=\"label\">Internal Carbon Value</div><div class=\"value\">€${r.credit_value_eur}</div><div class=\"delta\">linked to group market balance</div></div>` }catch(e){ qs('#insuranceImpactBox').textContent = String(e.message||e) } }

    async function loadWasteBaselines(){ try{ const j = await apiFetch('/api/waste/baselines',{ method:'GET' }); const arr = Array.isArray(j.baselines)? j.baselines: []; qs('#wBaselinesList').innerHTML = arr.length ? arr.map(b=> `<div class=\"kpi\"><div class=\"label\">${b.dept}</div><div class=\"value\">${Math.round(b.share*100)}%</div></div>`).join('') : '<div class=\"muted\">No baselines</div>' }catch(e){ qs('#wBaselinesList').textContent = String(e.message||e) } }
    async function saveWasteBaseline(){ try{ const dept = String(document.getElementById('wBaselineDept').value||'').trim(); const sharePct = +(document.getElementById('wBaselineShare').value||0); const share = Math.max(0, Math.min(1, sharePct/100)); if (!dept) return; await apiFetch('/api/waste/baselines',{ method:'POST', body: JSON.stringify({ dept, share }) }); document.getElementById('wBaselineDept').value=''; document.getElementById('wBaselineShare').value=''; loadWasteBaselines() }catch(e){ qs('#wBaselinesList').textContent = String(e.message||e) } }
    async function runWasteAIDept(){ try{ const hospital = document.getElementById('hospSel').value||''; const dept = document.getElementById('deptSel').value||''; const r = await apiFetch(`/api/waste/segregation?hospital=${encodeURIComponent(hospital)}&dept=${encodeURIComponent(dept)}`,{ method:'GET' }); const tips = Array.isArray(r.tips)? r.tips: []; qs('#wasteAiMsg').textContent = tips.length ? tips.join(' · ') : 'No tips'; }catch(e){ qs('#wasteAiMsg').textContent = String(e.message||e) } }
    async function quickWasteAnalyze(){ try{ const dept = document.getElementById('deptSel').value||''; const waste_kg = +(document.getElementById('wWasteKg').value||0); const medw_kg = +(document.getElementById('wMedwKg').value||0); const r = await apiFetch('/api/waste/segregation/analyze',{ method:'POST', body: JSON.stringify({ dept, waste_kg, medw_kg }) }); qs('#quickWasteBox').innerHTML = `<div class=\"kpi\"><div class=\"label\">Medical Share</div><div class=\"value\">${r.share_pct}%</div><div class=\"delta\">baseline ${r.baseline_pct}% · over ${r.over_pct}%</div></div>` }catch(e){ qs('#quickWasteBox').textContent = String(e.message||e) } }
    async function createWasteTasks(){ try{ const hospital = document.getElementById('hospSel').value||''; const dept = document.getElementById('deptSel').value||''; const r = await apiFetch('/api/waste/segregation/create-tasks',{ method:'POST', body: JSON.stringify({ hospital, dept, sla_days:7 }) }); qs('#wasteAiMsg').textContent = `Created ${r.created||0} task(s)`; showTab('Actions'); listTasks() }catch(e){ qs('#wasteAiMsg').textContent = String(e.message||e) } }
    async function loadPandCfg(){ try{ const j = await apiFetch('/api/pandemic/config',{ method:'GET' }); document.getElementById('pandEnergy').value = j.energy_kwh_per_day||0; document.getElementById('pandWater').value = j.water_m3_per_day||0; document.getElementById('pandOxygen').value = j.oxygen_l_per_day||0; document.getElementById('pandWaste').value = j.waste_kg_per_day||0; document.getElementById('pandPpe').value = j.ppe_units_per_day||0; document.getElementById('pandEnergyThr').value = j.energy_threshold_kwh||0; document.getElementById('pandOxygenThr').value = j.oxygen_threshold_l||0; qs('#pandCfgMsg').textContent = 'Loaded' }catch(e){ qs('#pandCfgMsg').textContent = String(e.message||e) } }
    async function savePandCfg(){ try{ const energy_kwh_per_day = +(document.getElementById('pandEnergy').value||0); const water_m3_per_day = +(document.getElementById('pandWater').value||0); const oxygen_l_per_day = +(document.getElementById('pandOxygen').value||0); const waste_kg_per_day = +(document.getElementById('pandWaste').value||0); const ppe_units_per_day = +(document.getElementById('pandPpe').value||0); const energy_threshold_kwh = +(document.getElementById('pandEnergyThr').value||0); const oxygen_threshold_l = +(document.getElementById('pandOxygenThr').value||0); await apiFetch('/api/pandemic/config',{ method:'POST', body: JSON.stringify({ energy_kwh_per_day, water_m3_per_day, oxygen_l_per_day, waste_kg_per_day, ppe_units_per_day, energy_threshold_kwh, oxygen_threshold_l }) }); qs('#pandCfgMsg').textContent = 'Saved' }catch(e){ qs('#pandCfgMsg').textContent = String(e.message||e) } }
    async function runPandSim(){ try{ const surge_factor = +(document.getElementById('pandSurge').value||1); const duration_hours = +(document.getElementById('pandHours').value||24); const r = await apiFetch('/api/pandemic/simulate',{ method:'POST', body: JSON.stringify({ surge_factor, duration_hours }) }); const t = r.totals||{}; const risks = Array.isArray(r.risks)? r.risks: []; qs('#pandSimBox').innerHTML = `<div class=\"kpi\"><div class=\"label\">Energy</div><div class=\"value\">${t.energy_kwh} kWh</div></div><div class=\"kpi\"><div class=\"label\">Oxygen</div><div class=\"value\">${t.oxygen_l} L</div></div><div class=\"kpi\"><div class=\"label\">Water</div><div class=\"value\">${t.water_m3} m³</div></div><div class=\"kpi\"><div class=\"label\">Waste</div><div class=\"value\">${t.waste_kg} kg</div></div><div class=\"kpi\"><div class=\"label\">PPE</div><div class=\"value\">${t.ppe_units}</div></div><div class=\"muted\" style=\"margin-top:8px\">${risks.length? risks.join(' · '): 'No risks'}</div>` }catch(e){ qs('#pandSimBox').textContent = String(e.message||e) } }
    async function createPandTasks(){ try{ const hospital = document.getElementById('hospSel').value||''; const dept = document.getElementById('deptSel').value||''; const surge_factor = +(document.getElementById('pandSurge').value||1); const duration_hours = +(document.getElementById('pandHours').value||24); const r = await apiFetch('/api/pandemic/create-tasks',{ method:'POST', body: JSON.stringify({ hospital, dept, surge_factor, duration_hours }) }); qs('#pandCfgMsg').textContent = `Created ${r.created||0} task(s)`; showTab('Actions'); listTasks() }catch(e){ qs('#pandCfgMsg').textContent = String(e.message||e) } }
    async function loadTwinCfg(){ try{ const j = await apiFetch('/api/twin/config',{ method:'GET' }); document.getElementById('twinHvacKwh').value = j.hvac_kwh_per_day||0; document.getElementById('twinAirflow').value = j.airflow_m3ph||0; document.getElementById('twinOrRooms').value = j.or_rooms||0; document.getElementById('twinRiskThr').value = j.comfort_risk_threshold||0.2; qs('#twinCfgMsg').textContent = 'Loaded' }catch(e){ qs('#twinCfgMsg').textContent = String(e.message||e) } }
    async function saveTwinCfg(){ try{ const hvac_kwh_per_day = +(document.getElementById('twinHvacKwh').value||0); const airflow_m3ph = +(document.getElementById('twinAirflow').value||0); const or_rooms = +(document.getElementById('twinOrRooms').value||0); const comfort_risk_threshold = +(document.getElementById('twinRiskThr').value||0.2); await apiFetch('/api/twin/config',{ method:'POST', body: JSON.stringify({ hvac_kwh_per_day, airflow_m3ph, or_rooms, comfort_risk_threshold }) }); qs('#twinCfgMsg').textContent = 'Saved' }catch(e){ qs('#twinCfgMsg').textContent = String(e.message||e) } }
    async function runTwinSim(){ try{ const hvac_reduction_pct = +(document.getElementById('twinReductionPct').value||0); const airflow_m3ph = +(document.getElementById('twinAirflow').value||0); const or_rooms = +(document.getElementById('twinOrRooms').value||0); const r = await apiFetch('/api/twin/simulate',{ method:'POST', body: JSON.stringify({ hvac_reduction_pct, airflow_m3ph, or_rooms }) }); const tips = Array.isArray(r.tips)? r.tips: []; qs('#twinSimBox').innerHTML = `<div class=\"kpi\"><div class=\"label\">Energy Saved</div><div class=\"value\">${r.saved_kwh} kWh/day</div><div class=\"delta\">HVAC −${r.hvac_reduction_pct}%</div></div><div class=\"kpi\"><div class=\"label\">CO₂e Saved</div><div class=\"value\">${r.tco2e_saved} t/day</div></div><div class=\"kpi\"><div class=\"label\">Comfort Risk</div><div class=\"value\">${r.comfort_risk}</div></div><div class=\"muted\" style=\"margin-top:8px\">${tips.length? tips.join(' · '): 'No tips'}</div>` }catch(e){ qs('#twinSimBox').textContent = String(e.message||e) } }
    async function createTwinTasks(){ try{ const dept = document.getElementById('deptSel').value||'Facilities'; const hvac_reduction_pct = +(document.getElementById('twinReductionPct').value||0); await apiFetch('/api/twin/create-tasks',{ method:'POST', body: JSON.stringify({ dept, hvac_reduction_pct }) }); qs('#twinCfgMsg').textContent = 'Task created'; showTab('Actions'); listTasks() }catch(e){ qs('#twinCfgMsg').textContent = String(e.message||e) } }
    async function saveCampus(){ try{ const name = String(document.getElementById('campusName').value||'').trim(); const type = String(document.getElementById('campusType').value||'').trim(); const notes = String(document.getElementById('campusNotes').value||'').trim(); if (!name) return; await apiFetch('/api/campus/defs',{ method:'POST', body: JSON.stringify({ name, type, notes }) }); document.getElementById('campusName').value=''; document.getElementById('campusType').value=''; document.getElementById('campusNotes').value=''; listCampuses() }catch(e){ qs('#campusDefsList').textContent = String(e.message||e) } }
    async function listCampuses(){ try{ const j = await apiFetch('/api/campus/defs',{ method:'GET' }); const arr = Array.isArray(j.campuses)? j.campuses: []; qs('#campusDefsList').innerHTML = arr.length ? arr.map(c=> `<div class=\"kpi\"><div class=\"label\">${c.name}</div><div class=\"value\">${c.type||'—'}</div><div class=\"delta\">${c.notes||''}</div><div style=\"margin-top:6px\"><button class=\"btn\" data-delcampus=\"${c.name}\">Delete</button></div></div>`).join('') : '<div class=\"muted\">No campuses</div>'; Array.from(qs('#campusDefsList').querySelectorAll('button[data-delcampus]')).forEach(b=> b.addEventListener('click', async ()=>{ const name = b.getAttribute('data-delcampus'); await apiFetch('/api/campus/defs?name='+encodeURIComponent(name), { method:'DELETE' }); listCampuses() })) }catch(e){ qs('#campusDefsList').textContent = String(e.message||e) } }
    async function saveCampusMetric(){ try{ const campus = String(document.getElementById('metricCampus').value||'').trim(); const date = String(document.getElementById('metricDate').value||'').trim()||new Date().toISOString().slice(0,10); const energy_kwh = +(document.getElementById('metricEnergy').value||0); const water_m3 = +(document.getElementById('metricWater').value||0); const waste_kg = +(document.getElementById('metricWaste').value||0); const medw_kg = +(document.getElementById('metricMedw').value||0); const cytotoxic_kg = +(document.getElementById('metricCyto').value||0); if (!campus) return; await apiFetch('/api/campus/metrics',{ method:'POST', body: JSON.stringify({ campus, date, energy_kwh, water_m3, waste_kg, medw_kg, cytotoxic_kg }) }); document.getElementById('metricDate').value=''; document.getElementById('metricEnergy').value=''; document.getElementById('metricWater').value=''; document.getElementById('metricWaste').value=''; document.getElementById('metricMedw').value=''; document.getElementById('metricCyto').value=''; listCampusMetrics() }catch(e){ qs('#campusMetricsList').textContent = String(e.message||e) } }
    async function listCampusMetrics(){ try{ const campus = String(document.getElementById('metricCampus').value||'').trim(); const j = await apiFetch('/api/campus/metrics'+(campus? ('?campus='+encodeURIComponent(campus)) : ''),{ method:'GET' }); const arr = Array.isArray(j.metrics)? j.metrics: []; qs('#campusMetricsList').innerHTML = arr.length ? arr.map(m=> `<div class=\"kpi\"><div class=\"label\">${m.date}</div><div class=\"value\">${m.energy_kwh} kWh · ${m.water_m3} m³</div><div class=\"delta\">waste ${m.waste_kg} kg · medw ${m.medw_kg} kg · cyto ${m.cytotoxic_kg} kg</div></div>`).join('') : '<div class=\"muted\">No metrics</div>' }catch(e){ qs('#campusMetricsList').textContent = String(e.message||e) } }
    async function aggregateCampus(){ try{ const campus = String(document.getElementById('metricCampus').value||'').trim(); const r = await apiFetch('/api/campus/aggregate?campus='+encodeURIComponent(campus),{ method:'GET' }); const t = r.totals||{}; qs('#campusAggBox').innerHTML = `<div class=\"kpi\"><div class=\"label\">Campus</div><div class=\"value\">${r.campus||'—'}</div></div><div class=\"kpi\"><div class=\"label\">Energy</div><div class=\"value\">${t.energy_kwh} kWh</div></div><div class=\"kpi\"><div class=\"label\">CO₂e</div><div class=\"value\">${t.tCO2e} t</div></div><div class=\"kpi\"><div class=\"label\">Cytotoxic</div><div class=\"value\">${t.cytotoxic_kg} kg</div></div>` }catch(e){ qs('#campusAggBox').textContent = String(e.message||e) } }
    async function loadLeakage(){ try{ const campus = String(document.getElementById('flmCampus').value||'').trim(); const r = await apiFetch('/api/finance/leakage'+(campus? ('?campus='+encodeURIComponent(campus)) : ''),{ method:'GET' }); const t = r.totals||{}; qs('#leakageBox').innerHTML = `<div class=\"kpi\"><div class=\"label\">Total</div><div class=\"value\">€${t.total_eur}</div><div class=\"delta\">energy ${t.energy_kwh} kWh · water ${t.water_m3} m³ · waste ${t.waste_kg} kg · medw ${t.medw_kg} kg</div></div>` }catch(e){ qs('#leakageBox').textContent = String(e.message||e) } }
    async function loadTopLeakage(){ try{ const r = await apiFetch('/api/finance/leakage/top-depts',{ method:'GET' }); const arr = Array.isArray(r.top)? r.top: []; qs('#topLeakageList').innerHTML = arr.length ? arr.map(x=> `<div class=\"kpi\"><div class=\"label\">${x.dept}</div><div class=\"value\">€${x.total_eur}</div></div>`).join('') : '<div class=\"muted\">No data</div>' }catch(e){ qs('#topLeakageList').textContent = String(e.message||e) } }
    async function loadTaxonomy(){ try{ const campus = String(document.getElementById('taxCampus').value||'').trim(); const dept = String(document.getElementById('taxDept').value||'').trim(); const q = new URLSearchParams(); if (campus) q.set('campus', campus); if (dept) q.set('dept', dept); const r = await apiFetch('/api/eu/taxonomy'+(q.toString()? ('?'+q.toString()): ''),{ method:'GET' }); const ren = Math.round(r.inputs?.renAvg||0); const rec = Math.round(r.inputs?.recAvg||0); const medwShare = r.inputs?.medwShare||0; qs('#taxonomyBox').innerHTML = `<div class=\"kpi\"><div class=\"label\">Aligned</div><div class=\"value\">${r.aligned_pct}%</div><div class=\"delta\">campus ${r.campus||'—'} · dept ${r.dept||'—'}</div></div>`; if (window.taxRenRecChart){ window.taxRenRecChart.destroy(); window.taxRenRecChart=null } if (window.taxMedwChart){ window.taxMedwChart.destroy(); window.taxMedwChart=null } window.taxRenRecChart = new Chart(document.getElementById('taxRenRecChart'),{ type:'bar', data:{ labels:['Renewables','Recycling'], datasets:[{ label:'%', data:[ren, rec] }] }, options:{ plugins:{ legend:{position:'top'} }, scales:{ y:{ min:0, max:100 } } } }); window.taxMedwChart = new Chart(document.getElementById('taxMedwChart'),{ type:'doughnut', data:{ labels:['Medical waste share','Other'], datasets:[{ data:[+(medwShare*100).toFixed(1), +(100- medwShare*100).toFixed(1) }] } }, options:{ plugins:{ legend:{position:'right'} } } }); }catch(e){ qs('#taxonomyBox').textContent = String(e.message||e) } }
    async function drawFlmDeptChart(){ try{ const r = await apiFetch('/api/finance/leakage/by-dept',{ method:'GET' }); let arr = Array.isArray(r.depts)? r.depts: []; const dir = String(document.getElementById('flmSortDir').value||'desc'); const topn = +(document.getElementById('flmTopN').value||0); arr.sort((a,b)=> dir==='asc'? (a.total_eur-b.total_eur) : (b.total_eur-a.total_eur)); if (topn>0) arr = arr.slice(0, topn); const labels = arr.map(x=> x.dept); const vals = arr.map(x=> x.total_eur); if (window.flmDeptChart){ window.flmDeptChart.destroy(); window.flmDeptChart=null } window.flmDeptChart = new Chart(document.getElementById('flmDeptChart'),{ type:'bar', data:{ labels, datasets:[{ label:'€ per dept', data: vals }] }, options:{ plugins:{ legend:{ position:'top' } } } }); }catch(e){ qs('#leakageBox').textContent = String(e.message||e) } }
    { const el = document.getElementById('riskHeatmapGrid'); if (el){ el.addEventListener('click', async (ev)=>{ try{ const btn = ev.target.closest('button[data-riskdept]'); const tile = ev.target.closest('.card'); if (btn){ const dept = btn.getAttribute('data-riskdept'); const items = [{ title:'Reduce energy baseline in '+dept },{ title:'Audit waste streams in '+dept },{ title:'Train staff on segregation in '+dept }]; await apiFetch('/api/ops/actions/create',{ method:'POST', body: JSON.stringify({ prefix:'/api/clinical', items }) }); showTab('Actions'); listTasks(); return } const d = (tile && tile.getAttribute('data-dept'))||''; if (!d) return; const r = await apiFetch('/api/clinical/normalized?dept='+encodeURIComponent(d),{ method:'GET' }); qs('#normDeptBox').innerHTML = `<div class=\"kpi\"><div class=\"label\">${d}</div><div class=\"value\">total ${r.co2_total} t</div><div class=\"delta\">per inpatient ${(r.per_inpatient!=null?r.per_inpatient:'—')} · per surgery ${(r.per_surgery!=null?r.per_surgery:'—')} · per DRG ${(r.per_drg!=null?r.per_drg:'—')}</div></div>` }catch(_){ } }) } }
    async function loadConnectors(){ try{ const r = await apiFetch('/api/connectors/marketplace',{ method:'GET' }); const arr = Array.isArray(r.connectors)? r.connectors: []; qs('#connectorsList').innerHTML = arr.length ? arr.map(c=> `<div class=\"kpi\"><div class=\"label\">${c.name}</div><div class=\"value\">${c.status}</div><div class=\"delta\">${c.protocol}</div></div>`).join('') : '<div class=\"muted\">No connectors</div>' }catch(e){ qs('#connectorsList').textContent = String(e.message||e) } }
    async function loadRiskHeatmap(){ try{ const r = await apiFetch('/api/clinical/risk-heatmap',{ method:'GET' }); const arr = Array.isArray(r.heatmap)? r.heatmap: []; const html = arr.map(x=>{ const color = x.risk==='red'? '#f44336' : x.risk==='amber'? '#ff9800' : '#4caf50'; return `<div class=\"card\" data-dept=\"${x.dept}\" style=\"padding:8px;background:${color};color:#fff;border-radius:8px\"><div style=\"font-weight:600\">${x.dept}</div><div style=\"font-size:12px;margin-top:4px\">score ${x.score}</div><div style=\"font-size:12px;margin-top:4px\">energy ${Math.round(x.indicators.energy)} · waste ${Math.round(x.indicators.waste)} · medw ${Math.round(x.indicators.medw)}</div><div style=\"margin-top:6px\"><button class=\"btn\" data-riskdept=\"${x.dept}\">Create Action</button></div></div>` }).join(''); qs('#riskHeatmapGrid').innerHTML = html || '<div class=\"muted\">No data</div>' }catch(e){ qs('#riskHeatmapGrid').textContent = String(e.message||e) } }
    async function loadDoctorPerf(){ try{ const campus = String(document.getElementById('dpCampus').value||'').trim(); const dept = String(document.getElementById('dpDept').value||'').trim(); const r = await apiFetch('/api/clinical/doctor',{ method:'GET' }); let arr = Array.isArray(r.cases)? r.cases: []; if (campus) arr = arr.filter(c=> String(c.campus||'')===campus); if (dept) arr = arr.filter(c=> String(c.dept||'')===dept); const map = new Map(); for (const c of arr){ const k = String(c.doctor||''); const a = map.get(k)||{ total:0, count:0 }; a.total += (+c.co2||0); a.count++; map.set(k,a) } const labels = Array.from(map.keys()); const vals = labels.map(k=> { const a = map.get(k); return a.count? +(a.total/a.count).toFixed(2) : 0 }); if (window.doctorPerfChart){ window.doctorPerfChart.destroy(); window.doctorPerfChart=null } window.doctorPerfChart = new Chart(document.getElementById('doctorPerfChart'),{ type:'bar', data:{ labels, datasets:[{ label:'Avg CO₂ per case (t)', data: vals }] }, options:{ plugins:{ legend:{position:'top'} } } }); }catch(e){ qs('#riskHeatmapGrid').textContent = String(e.message||e) } }
    async function listDrugs(){ try{ const j = await apiFetch('/api/drugs/library',{ method:'GET' }); const arr = Array.isArray(j.drugs)? j.drugs: []; qs('#drugsList').innerHTML = arr.length ? arr.map(d=> `<div class=\"kpi\"><div class=\"label\">${d.name}</div><div class=\"value\">${d.kgco2e_per_unit} kgCO₂e/unit</div><div class=\"delta\">ATC ${d.atc||'—'} · ${d.supplier||'—'} · alts: ${(d.alternatives||[]).join(', ')}</div><div style=\"margin-top:6px\"><button class=\"btn\" data-deldrug=\"${d.name}\">Delete</button></div></div>`).join('') : '<div class=\"muted\">No drugs</div>'; Array.from(qs('#drugsList').querySelectorAll('button[data-deldrug]')).forEach(b=> b.addEventListener('click', async ()=>{ const name = b.getAttribute('data-deldrug'); await apiFetch('/api/drugs/library?name='+encodeURIComponent(name), { method:'DELETE' }); listDrugs() })) }catch(e){ qs('#drugsList').textContent = String(e.message||e) } }
    async function saveDrug(){ try{ const name = String(document.getElementById('drugName').value||'').trim(); const atc = String(document.getElementById('drugAtc').value||'').trim(); const supplier = String(document.getElementById('drugSupplier').value||'').trim(); const kgco2e_per_unit = +(document.getElementById('drugKgUnit').value||0); const alternatives = String(document.getElementById('drugAlts').value||'').trim(); if (!name) return; await apiFetch('/api/drugs/library',{ method:'POST', body: JSON.stringify({ name, atc, supplier, kgco2e_per_unit, alternatives }) }); document.getElementById('drugName').value=''; document.getElementById('drugAtc').value=''; document.getElementById('drugSupplier').value=''; document.getElementById('drugKgUnit').value=''; document.getElementById('drugAlts').value=''; listDrugs() }catch(e){ qs('#drugsList').textContent = String(e.message||e) } }
    async function calcDrugUsage(){ try{ const raw = String(document.getElementById('drugUsageCsv').value||'').trim(); if (!raw) return; const rows = raw.split(/\n|,/).map(s=> s.trim()).filter(Boolean).map(s=>{ const [name,qty] = s.split(':'); return { name:String(name||'').trim(), qty:+(qty||0) } }); const r = await apiFetch('/api/drugs/usage',{ method:'POST', body: JSON.stringify({ rows }) }); qs('#drugUsageBox').innerHTML = `<div class=\"kpi\"><div class=\"label\">Total</div><div class=\"value\">${r.tCO2e} tCO₂e</div><div class=\"delta\">${r.total_kgco2e} kgCO₂e</div></div>` }catch(e){ qs('#drugUsageBox').textContent = String(e.message||e) } }
    async function suggestDrugAlt(){ try{ const atc = String(document.getElementById('drugAtc').value||'').trim(); const name = String(document.getElementById('drugName').value||'').trim(); const r = await apiFetch('/api/drugs/compare',{ method:'POST', body: JSON.stringify({ atc, name }) }); const tips = Array.isArray(r.tips)? r.tips: []; qs('#drugAltBox').innerHTML = tips.length ? tips.map(t=> `<div class=\"kpi\"><div class=\"label\">${t.name}</div><div class=\"value\">${t.kgco2e_per_unit} kgCO₂e/unit</div><div class=\"delta\">ATC ${t.atc||'—'} · ${t.supplier||'—'}</div></div>`).join('') : '<div class=\"muted\">No suggestions</div>' }catch(e){ qs('#drugAltBox').textContent = String(e.message||e) } }
    async function listFiles(){
      try { const data = await apiFetch('/api/files/list', { method:'GET' }); const files = (data.files||[]); qs('#filesList').innerHTML = files.length ? files.map(f=> `<div class="kpi"><div class="label">${f.name}</div><div class="value">${f.type}</div><div class="delta">${fmt(f.size)} bytes</div></div>`).join('') : '<div class="muted">No files</div>' } catch (e) { qs('#filesMsg').textContent = String(e.message||e) }
    }
    function mergeImportedRows(rows){
      const norm = rows.map(r=>({
        year: +r.year || +r.Year || +r.YEAR,
        hospital: String(r.hospital || r.Hospital || r.HOSPITAL || '').trim(),
        country: String(r.country || r.Country || r.COUNTRY || '').trim(),
        dept: String(r.dept || r.Department || r.DEPT || '').trim(),
        energy: +r.energy || +r.kwh || +r.energy_kwh || 0,
        water: +r.water || +r.m3 || +r.water_m3 || 0,
        waste: +r.waste || +r.waste_kg || 0,
        medw: +r.medw || +r.medical_waste_kg || 0,
        co2: +r.co2 || +r.co2e_t || 0,
        ren: +r.ren || +r.renewables_pct || 0,
        rec: +r.rec || +r.recycling_pct || 0,
      })).filter(x=>x.year && x.hospital && x.dept)
      state.data = state.data.concat(norm)
      saveData(); populateFilters(); applyAll();
    }
    async function uploadFile(){
      try {
        const inp = document.getElementById('fileInputData')
        const f = inp.files && inp.files[0]
        if (!f) { qs('#filesMsg').textContent = 'Select a file'; return }
        const key = getApiKey(); if (key) setApiKey(key)
        const reader = new FileReader()
        reader.onload = async () => {
          const b64 = reader.result.split(',')[1]
          try {
            await apiFetch('/api/files/save', { method:'POST', body: JSON.stringify({ name: f.name, mime: f.type || 'application/octet-stream', data: b64 }) })
            qs('#filesMsg').textContent = 'Uploaded'
            listFiles()
          } catch (e) {
            try {
              if (f.name.toLowerCase().endsWith('.xlsx') || f.type==='application/vnd.openxmlformats-officedocument.spreadsheetml.sheet'){
                const wb = XLSX.read(await f.arrayBuffer(), { type:'array' });
                const ws = wb.Sheets[wb.SheetNames[0]]; const rows = XLSX.utils.sheet_to_json(ws);
                mergeImportedRows(rows);
                qs('#filesMsg').textContent = 'Imported locally'
              } else {
                const text = await f.text();
                const wb = XLSX.read(text, { type:'string' });
                const ws = wb.Sheets[wb.SheetNames[0]]; const rows = XLSX.utils.sheet_to_json(ws);
                mergeImportedRows(rows);
                qs('#filesMsg').textContent = 'Imported locally'
              }
            } catch (err) { qs('#filesMsg').textContent = String(err.message||err) }
          }
        }
        reader.readAsDataURL(f)
      } catch (e) { qs('#filesMsg').textContent = String(e.message||e) }
    }

    async function listSessions(){
      try { const data = await apiFetch('/api/session/list?limit=10', { method:'GET' }); const arr = Array.isArray(data) ? data : []; qs('#sessionsList').innerHTML = arr.length ? arr.map(s=> `<div class="kpi"><div class="label">${s.mode}</div><div class="value">${s.title||'—'}</div><div class="delta">${new Date(s.created_at).toLocaleString()}</div></div>`).join('') : '<div class="muted">No sessions</div>' } catch (e) { qs('#sessionsMsg').textContent = String(e.message||e) }
    }
    async function saveDemoSession(){
      try {
        const payload = { message: 'Demo session — Zero@Hospital compliance check', response: 'Initial findings: CSRD on track; energy baseline set.', mode:'hospital' }
        await apiFetch('/api/session/save', { method:'POST', body: JSON.stringify(payload) })
        qs('#sessionsMsg').textContent = 'Saved'
        listSessions()
      } catch (e) { qs('#sessionsMsg').textContent = String(e.message||e) }
    }

    function exportCSV(){
      const rows = filtered();
      const headers = ['year','hospital','dept','energy_kwh','water_m3','waste_kg','medical_waste_kg','co2e_t','renewables_pct','recycling_pct'];
      const lines = [headers.join(',')].concat(rows.map(r=>[r.year, `"${r.hospital}"`, `"${r.dept}"`, r.energy, r.water, r.waste, r.medw, r.co2, r.ren, r.rec].join(',')));
      const blob = new Blob([lines.join('\n')], {type:'text/csv'});
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a'); a.href=url; a.download='hsp_filtered_export.csv'; a.click(); URL.revokeObjectURL(url);
    }

    async function exportPDF(){
      const { jsPDF } = window.jspdf;
      const doc = new jsPDF({unit:'pt', format:'a4'});
      const margin = 36;
      let y = margin;
      doc.setFont('helvetica','bold'); doc.setFontSize(16);
      doc.text(t('hero_title'), margin, y); y+=22;
      doc.setFont('helvetica','normal'); doc.setFontSize(10);
      const now = new Date().toLocaleString();
      doc.text(`${t('badge_demo')} · ${now}`, margin, y); y+=18;
      doc.setDrawColor(200); doc.line(margin, y, 559, y); y+=16;

      // KPIs
      const rows = filtered();
      const kwh = sum(rows, r=>r.energy), m3 = sum(rows, r=>r.water), wkg = sum(rows, r=>r.waste), mw=sum(rows,r=>r.medw), co2=sum(rows,r=>r.co2), ren=mean(rows,r=>r.ren), rec=mean(rows,r=>r.rec);
      const kpis = [
        [t('kpi_total_co2'), fmt(co2)],
        [t('kpi_energy'), fmt(kwh)],
        [t('kpi_water'), fmt(m3)],
        [t('kpi_waste'), fmt(wkg)],
        [t('kpi_medwaste'), fmt(mw)],
        [t('kpi_renrec'), `${fmt(ren,0)}% / ${fmt(rec,0)}%`]
      ];
      doc.setFontSize(12); doc.text(t('kpi_title'), margin, y); y+=14;
      doc.setFontSize(10);
      kpis.forEach(k=>{ doc.text(`${k[0]}: ${k[1]}`, margin, y); y+=14; });

      // Try to embed CO2 chart if available
      try{
        const canvas = qs('#co2Chart');
        if(canvas){
          const img = canvas.toDataURL('image/png');
          const iw = 520, ih = (canvas.height/canvas.width) * iw;
          y+=6; doc.addImage(img, 'PNG', margin, y, iw, ih); y+=ih+6;
        }
      }catch(e){ /* ignore */ }

      doc.save('hsp_report.pdf');
    }

    function exportXLSX(){
      const rows = filtered();
      const ws = XLSX.utils.json_to_sheet(rows);
      const wb = XLSX.utils.book_new();
      XLSX.utils.book_append_sheet(wb, ws, 'HSP');
      XLSX.writeFile(wb, 'hsp_filtered_export.xlsx');
    }

    // Modal helpers for inline HTML
    window.openModal = function(){ document.getElementById('modal').style.display='flex'; }
    window.closeModal = function(){ document.getElementById('modal').style.display='none'; }

    async function saveNew(){
      const v = (id)=>document.getElementById(id).value.trim();
      let rec = { year:+v('fYear'), hospital:v('fHospital'), country:v('fCountry'), dept:v('fDept'), energy:+v('fEnergy'), water:+v('fWater'), waste:+v('fWaste'), medw:+v('fMedWaste'), co2:+v('fCO2'), ren:+v('fRen'), rec:+v('fRec') };
      const elAuto = document.getElementById('autoCalcCo2'); const auto = !!(elAuto && elAuto.checked);
      if (auto || Number.isNaN(rec.co2) || rec.co2===undefined || rec.co2===null || v('fCO2')===''){
        let f = settings.factors
        try{
          const r = await apiFetch(`/api/factors?hospital=${encodeURIComponent(rec.hospital)}&dept=${encodeURIComponent(rec.dept)}`, { method:'GET' })
          const profiles = Array.isArray(r.profiles)? r.profiles : []
          if (profiles[0] && profiles[0].factors){ f = Object.assign({}, f, profiles[0].factors) }
          if (!(profiles[0] && profiles[0].factors)){
            const maps = await apiFetch('/api/eflib/map', { method:'GET' })
            const marr = Array.isArray(maps.maps)? maps.maps : []
            const mp = marr.find(x=> x.hospital===rec.hospital)
            if (mp){ const lib = await apiFetch('/api/eflib', { method:'GET' }); const parr = Array.isArray(lib.profiles)? lib.profiles: []; const prof = parr.find(x=> x.name===mp.profile); if (prof){ f = { energy_kwh_to_tco2e: prof.energy_kwh_to_tco2e, water_m3_to_tco2e: prof.water_m3_to_tco2e, waste_kg_to_tco2e: prof.waste_kg_to_tco2e, medw_kg_to_tco2e: prof.medw_kg_to_tco2e } } }
            if (!mp && rec.country){ const cmaps = await apiFetch('/api/eflib/map-country', { method:'GET' }); const carr = Array.isArray(cmaps.maps)? cmaps.maps: []; const cmp = carr.find(x=> String(x.country).toLowerCase()===String(rec.country||'').toLowerCase()); if (cmp){ const lib = await apiFetch('/api/eflib', { method:'GET' }); const parr = Array.isArray(lib.profiles)? lib.profiles: []; const prof = parr.find(x=> x.name===cmp.profile); if (prof){ f = { energy_kwh_to_tco2e: prof.energy_kwh_to_tco2e, water_m3_to_tco2e: prof.water_m3_to_tco2e, waste_kg_to_tco2e: prof.waste_kg_to_tco2e, medw_kg_to_tco2e: prof.medw_kg_to_tco2e } } }
            }
          }
        }catch(_){ }
        const tFromEnergy = rec.energy * (f.energy_kwh_to_tco2e||0);
        const tFromWater = rec.water * (f.water_m3_to_tco2e||0);
        const tFromWaste = rec.waste * (f.waste_kg_to_tco2e||0);
        const tFromMedw = rec.medw * (f.medw_kg_to_tco2e||0);
        rec.co2 = +(tFromEnergy + tFromWater + tFromWaste + tFromMedw).toFixed(3);
      }
      const okVals = [rec.year, rec.hospital, rec.dept, rec.energy, rec.water, rec.waste, rec.medw, rec.co2, rec.ren, rec.rec];
      const ok = okVals.every(x=>x!=='' && x!==null && !Number.isNaN(x));
      if(!ok){ alert('Please fill all fields with valid values.'); return; }
      state.data.push(rec); saveData(); populateFilters(); applyAll(); window.closeModal();
    }

    function addSample(){ const extra = {year:2025, hospital:"KonyaCare Hospital", dept:"Imaging", energy:99000, water:2100, waste:1200, medw:260, co2:118, ren:26, rec:36}; state.data.push(extra); saveData(); populateFilters(); applyAll(); }

    function exportRoutes(){
      return [
        {name:'London (LHR) ⇄ Istanbul (IST)', km: 2490},
        {name:'Berlin (BER) ⇄ Istanbul (IST)', km: 1770},
        {name:'Paris (CDG) ⇄ Istanbul (IST)', km: 2250},
        {name:'Vienna (VIE) ⇄ Istanbul (IST)', km: 1240},
        {name:'Amsterdam (AMS) ⇄ Istanbul (IST)', km: 2200},
        {name:'Stockholm (ARN) ⇄ Istanbul (IST)', km: 2600}
      ];
    }

    function populateRoutes(){ qs('#routeSel').innerHTML = exportRoutes().map((r,i)=>`<option value="${i}">${r.name}</option>`).join(''); }

    function doCalc(){
      const r = exportRoutes()[+qs('#routeSel').value];
      const pax = Math.max(1, +qs('#patientsInput').value || 1);
      const type = qs('#tripTypeSel').value; // oneway/return
      const rf = +qs('#radiusFactorSel').value; // Radiative Forcing factor
      const km = r.km * (type==='return'? 1 : 0.5); // list return distance; half for one-way
      const ef = 0.115; // kg CO2 per pax*km (economy)
      const tons = (km * ef * pax * rf) / 1000; // to tonnes
      qs('#calcValue').textContent = fmt(tons,3);
      qs('#calcDetails').textContent = `${r.name} · ${pax} pax · ${type} · RF×${rf}`;
      qs('#calcNote').textContent = 'Illustrative only. Use DEFRA/ICAO factors for audited reporting.';
    }

    function backToMain(){ try{ const target = '/dpp-dashboard/index.html'; if (window.location.hostname.endsWith('github.io')){ const base = window.location.pathname.split('/')[1]; window.location.href = `/${base}/index.html`; } else { window.location.href = target; } }catch(e){ window.location.href = 'index.html'; } }

    function resetFilters(){ ['yearSel','hospSel','deptSel'].forEach(id=>{ document.getElementById(id).value=''; }); applyAll(); seedLiveBase(); }

    // ======== LIVE VIEW ENGINE ========
    const live = {
      timer:null,
      intervalMs:5000,
      windowSize:15,
      points:[], // {t, co2, energy, water, waste, medw, ren, rec}
      base: {co2: 800, energy: 700000, water: 12000, waste: 8000, medw: 2200, ren: 30, rec: 38}
    };

    function seedLiveBase(){
      const rows = filtered();
      if(rows.length){
        live.base.co2 = sum(rows,r=>r.co2);
        live.base.energy = sum(rows,r=>r.energy);
        live.base.water = sum(rows,r=>r.water);
        live.base.waste = sum(rows,r=>r.waste);
        live.base.medw = sum(rows,r=>r.medw);
        live.base.ren = Math.round(mean(rows,r=>r.ren));
        live.base.rec = Math.round(mean(rows,r=>r.rec));
      }
    }

    function liveTick(){
      const jitter = (v, pct)=> v * (1 + (Math.random()-0.5) * pct);
      const p = {
        t: new Date(),
        co2: jitter(live.base.co2, 0.02),
        energy: jitter(live.base.energy, 0.015),
        water: jitter(live.base.water, 0.02),
        waste: jitter(live.base.waste, 0.03),
        medw: jitter(live.base.medw, 0.03),
        ren: Math.max(0, Math.min(100, jitter(live.base.ren, 0.05))),
        rec: Math.max(0, Math.min(100, jitter(live.base.rec, 0.05)))
      };
      live.points.push(p);
      if (live.points.length > live.windowSize) live.points.shift();
      updateLiveUI();
    }

    function updateLiveUI(){
      if (!live.points.length) return;
      const last = live.points[live.points.length-1];
      qs('#liveCo2').textContent = fmt(last.co2,1);
      qs('#liveEnergy').textContent = fmt(last.energy,0);
      qs('#liveWater').textContent = fmt(last.water,0);
      qs('#liveWaste').textContent = fmt(last.waste,0);
      qs('#liveMedw').textContent = fmt(last.medw,0);
      qs('#liveRenRec').textContent = `${fmt(last.ren,0)}% / ${fmt(last.rec,0)}%`;
      qs('#liveRecords').textContent = String(live.windowSize);

      const labels = live.points.map(p=> p.t.toLocaleTimeString([], {hour:'2-digit', minute:'2-digit', second:'2-digit'}));
      const dCO2 = live.points.map(p=> p.co2);
      const dEN  = live.points.map(p=> p.energy/1000); // ×10^3 kWh
      const dWA  = live.points.map(p=> p.water);
      const dWS  = live.points.map(p=> p.waste);
      const dMW  = live.points.map(p=> p.medw);

      if(!state.liveChart){
        state.liveChart = new Chart(qs('#liveChart'),{
          type:'line',
          data:{ labels, datasets:[
            {label:'CO₂e (t)', data:dCO2, yAxisID:'y1', tension:.35},
            {label:'Energy (×10³ kWh)', data:dEN, yAxisID:'y2', tension:.35},
            {label:'Water (m³)', data:dWA, yAxisID:'y2', tension:.35},
            {label:'Waste (kg)', data:dWS, yAxisID:'y3', tension:.35},
            {label:'MedWaste (kg)', data:dMW, yAxisID:'y4', tension:.35}
          ]},
          options:{
            animation:false,
            plugins:{ legend:{position:'top'} },
            scales:{
              y1:{ type:'linear', position:'left' },
              y2:{ type:'linear', position:'right', grid:{ drawOnChartArea:false } },
              y3:{ type:'linear', position:'right', grid:{ drawOnChartArea:false }, offset:true },
              y4:{ type:'linear', position:'right', grid:{ drawOnChartArea:false }, offset:true }
            }
          }
        });
      } else {
        state.liveChart.data.labels = labels;
        const ds = state.liveChart.data.datasets;
        ds[0].data = dCO2; ds[1].data = dEN; ds[2].data = dWA; ds[3].data = dWS; ds[4].data = dMW;
        state.liveChart.update();
      }
    }

    function liveStart(){ if (live.timer) return; seedLiveBase(); liveTick(); live.timer = setInterval(liveTick, live.intervalMs); }
    function liveStop(){ if(live.timer){ clearInterval(live.timer); live.timer=null; } }

    // ======== Tabs ========
    function showTab(which){
      qsa('.tabs-large .tab').forEach(b=>b.classList.remove('active'));
      qs('#tab'+which+'Btn').classList.add('active');
      qsa('.view').forEach(v=>v.classList.remove('active'));
      qs('#'+which.toLowerCase()+'View').classList.add('active');
      if (which==='Live'){ liveStart(); } else { liveStop(); }
      if (which==='Scopes'){ renderScopes(); }
      if (which==='Alerts'){ /* no-op */ }
      if (which==='Actions'){ /* no-op */ }
    }

    // ======== Zoom (Accessibility) ========
    let zoomed = false;
    function toggleZoom(){
      const wrap = document.querySelector('.wrap');
      zoomed = !zoomed;
      wrap.style.zoom = zoomed ? '2' : '1';
      qs('#zoomBtn').textContent = zoomed ? (state.lang==='tr' ? '%100 Normal' : '%100 Normal') : t('btn_zoom');
      Chart.defaults.font.size = zoomed ? 14 : 12;
      applyAll();
      if (state.liveChart){ state.liveChart.destroy(); state.liveChart = null; }
      updateLiveUI();
    }

    // ---------- Init ----------
    window.addEventListener('DOMContentLoaded', () =>{
      (async function(){ try{ const resp = await fetch('/logo.png'); if (resp.ok){ const blob = await resp.blob(); const url = URL.createObjectURL(blob); const img = document.getElementById('appLogo'); if (img){ img.src = url } } }catch(_){ } })();
      loadData();
      populateFilters();
      populateRoutes();
      applyAll();

      const storedLang = localStorage.getItem(LS_LANG) || 'en';
      state.lang = storedLang;
      const langSel = qs('#langSel');
      if (langSel) { langSel.value = storedLang; langSel.addEventListener('change', (e)=>{ state.lang = e.target.value; localStorage.setItem(LS_LANG, state.lang); applyLang(); }); }
      applyLang();

      // events
      qs('#resetBtn').addEventListener('click', resetFilters);
      qs('#exportCsvBtn').addEventListener('click', exportCSV);
      qs('#exportPdfBtn').addEventListener('click', exportPDF);
      qs('#exportXlsxBtn').addEventListener('click', exportXLSX);
      qs('#zoomBtn').addEventListener('click', toggleZoom);
      if (qs('#loadPilotBtn')) qs('#loadPilotBtn').addEventListener('click', ()=>{ loadPilotDemo().then(()=> seedLiveBase()) })
      if (qs('#loadHspDemoBtn')) qs('#loadHspDemoBtn').addEventListener('click', ()=>{ loadHspDemo().then(()=> seedLiveBase()) })
      if (qs('#importCsvBtn')) qs('#importCsvBtn').addEventListener('click', async ()=>{ try{ await apiFetch('/api/demo/import-all-csv',{ method:'POST' }); const j = await apiFetch('/api/dataset',{ method:'GET' }); const rows = Array.isArray(j.rows)? j.rows: []; if (rows.length){ state.data=rows; saveData(); populateFilters(); applyAll(); const pm = qs('#pilotMsg'); if (pm) pm.textContent = `CSV import ✔️ (${rows.length} rows)` } }catch(_){ } })
      updateEnvBadge()
      qs('#backBtn').addEventListener('click', backToMain);
      if (qs('#loginBtn')) qs('#loginBtn').addEventListener('click', doLogin);
      if (qs('#logoutBtn')) qs('#logoutBtn').addEventListener('click', doLogout);

      ['yearSel','hospSel','deptSel'].forEach(id=> document.getElementById(id).addEventListener('change', ()=>{ applyAll(); seedLiveBase(); }));
      document.getElementById('hospSel').addEventListener('change', loadSeasonality)
      qs('#downloadDemoJson').addEventListener('click', (e)=>{ e.preventDefault(); const blob = new Blob([JSON.stringify(state.data,null,2)], {type:'application/json'}); const url = URL.createObjectURL(blob); const a = document.createElement('a'); a.href=url; a.download='hsp_demo_data.json'; a.click(); URL.revokeObjectURL(url); });
      qs('#downloadHspCsvPack').addEventListener('click', async (e)=>{ e.preventDefault(); const files = ['hsp_records','departments_energy','departments_waste','monthly_co2_trend','taxonomy_izmir']; for (const f of files){ try{ const r = await fetch(API_BASE+'/api/demo/csv/'+f); const b = await r.blob(); const u = URL.createObjectURL(b); const a = document.createElement('a'); a.href=u; a.download=f+'.csv'; a.click(); URL.revokeObjectURL(u) }catch(_){ } } });
      qs('#downloadHspSql').addEventListener('click', async (e)=>{ e.preventDefault(); try{ const r = await fetch(API_BASE+'/api/demo/sql/hsp'); const b = await r.blob(); const u = URL.createObjectURL(b); const a = document.createElement('a'); a.href=u; a.download='hsp_tables.sql'; a.click(); URL.revokeObjectURL(u) }catch(_){ } });
      qs('#openAddModalBtn').addEventListener('click', window.openModal);
      qs('#addSampleBtn').addEventListener('click', ()=>{ addSample(); seedLiveBase(); });

      qs('#calcBtn').addEventListener('click', doCalc);
      qs('#clearCalcBtn').addEventListener('click', ()=>{ qs('#patientsInput').value = 1; qs('#calcValue').textContent = '0.000'; qs('#calcDetails').textContent = '—'; qs('#calcNote').textContent = ''; });

      // BIG tabs
      qs('#tabMainBtn').addEventListener('click', ()=>showTab('Main'));
      qs('#tabLiveBtn').addEventListener('click', ()=>showTab('Live'));
      qs('#tabScopesBtn').addEventListener('click', ()=>showTab('Scopes'));
      qs('#tabAlertsBtn').addEventListener('click', ()=>{ showTab('Alerts'); });
      qs('#tabActionsBtn').addEventListener('click', ()=>{ showTab('Actions'); });
      qs('#tabDeptsBtn').addEventListener('click', ()=>{ showTab('Departments'); loadTargets(); });
      qs('#tabComplianceBtn').addEventListener('click', ()=>{ showTab('Compliance'); renderCompliance(); listEsrs(); });
      (async ()=>{ try{ const gr = await apiFetch('/api/notify/groups',{ method:'GET' }); const arr = Array.isArray(gr.groups)? gr.groups: []; const el = document.getElementById('esrsGrpSel'); if (el){ el.innerHTML = arr.map(g=> `<option value="${g.name}">${g.name}</option>`).join('') } }catch(_){ } })();
      if (qs('#saveDnshBtn')) qs('#saveDnshBtn').addEventListener('click', saveDnsh);
      if (qs('#listDnshBtn')) qs('#listDnshBtn').addEventListener('click', listDnsh);
      if (qs('#createScheduleBtn')) qs('#createScheduleBtn').addEventListener('click', createSchedule);
      if (qs('#listSchedulesBtn')) qs('#listSchedulesBtn').addEventListener('click', listSchedules);
      if (qs('#runReportNowBtn')) qs('#runReportNowBtn').addEventListener('click', runReportNow);
      listReports();
      (async ()=>{ try{ const gr = await apiFetch('/api/notify/groups',{ method:'GET' }); const arr = Array.isArray(gr.groups)? gr.groups: []; const el = document.getElementById('schedEmailGroup'); if (el){ el.innerHTML = arr.map(g=> `<option value="${g.name}">${g.name}</option>`).join('') } const tr = await apiFetch('/api/notify/templates',{ method:'GET' }); const tarr = Array.isArray(tr.templates)? tr.templates: []; const tl = document.getElementById('schedEmailTemplate'); if (tl){ tl.innerHTML = tarr.map(t=> `<option value="${t.name}">${t.name}</option>`).join('') } }catch(_){ } })();
      qs('#tabDataBtn').addEventListener('click', ()=>{ showTab('Data'); listFiles(); });
      qs('#tabSessionsBtn').addEventListener('click', ()=>{ showTab('Sessions'); listSessions(); });
      qs('#tabDeptDashBtn').addEventListener('click', ()=>{ showTab('DeptDash'); renderDeptDash(); });
      qs('#tabClinicalBtn').addEventListener('click', ()=>{ showTab('Clinical'); loadProcBenchmarks(); listProcProfiles(); });
      qs('#tabJourneyBtn').addEventListener('click', ()=>{ showTab('Journey'); listJourneys(); });
      qs('#tabBenchmarkBtn').addEventListener('click', ()=>{ showTab('Benchmark'); });
      qs('#tabProcBtn').addEventListener('click', ()=>{ showTab('Procurement'); listProcScores(); });
      qs('#tabDrugsBtn').addEventListener('click', ()=>{ showTab('Drugs'); listDrugs(); });
      qs('#tabCarbonBtn').addEventListener('click', ()=>{ showTab('Carbon'); populateCarbonHospitals(); listCarbonGroups(); listQuotas(); listCredits(); listTrades(); });
      qs('#tabInsuranceBtn').addEventListener('click', ()=>{ showTab('Insurance'); loadInsuranceCfg(); });
      qs('#tabWasteBtn').addEventListener('click', ()=>{ showTab('Waste'); loadWasteBaselines(); });
      qs('#tabPandemicBtn').addEventListener('click', ()=>{ showTab('Pandemic'); loadPandCfg(); });
      qs('#tabTwinBtn').addEventListener('click', ()=>{ showTab('Twin'); loadTwinCfg(); });
      qs('#tabCampusBtn').addEventListener('click', ()=>{ showTab('Campus'); listCampuses(); });
      qs('#tabFinanceBtn').addEventListener('click', ()=>{ showTab('Finance'); });
      qs('#tabTaxonomyBtn').addEventListener('click', ()=>{ showTab('Taxonomy'); });
      qs('#tabProjectsBtn').addEventListener('click', ()=>{ showTab('Projects'); loadTaxonomyAlignments(); loadGdProjects() })
      qs('#tabConnectorsBtn').addEventListener('click', ()=>{ showTab('Connectors'); });
      qs('#tabRadarBtn').addEventListener('click', ()=>{ showTab('Radar'); populateRadarCampus(); });
      qs('#tabSettingsBtn').addEventListener('click', ()=>{ showTab('Settings'); loadSettings(); });
      qs('#tabOpsBtn').addEventListener('click', ()=>{ showTab('Ops'); loadHealth(); loadOpsSummary(); listOpsAlerts(); listOpsTickets(); listBackups(); loadOpsPrefixes(); });
      if (qs('#loadAlertsBtn')) qs('#loadAlertsBtn').addEventListener('click', loadAlerts);
      if (qs('#evaluateAlertsBtn')) qs('#evaluateAlertsBtn').addEventListener('click', evaluateAlerts);
      if (qs('#alertsCreateTasksBtn')) qs('#alertsCreateTasksBtn').addEventListener('click', createTasksFromAlerts);
      if (qs('#addRuleBtn')) qs('#addRuleBtn').addEventListener('click', addRule);
      if (qs('#logActionBtn')) qs('#logActionBtn').addEventListener('click', logAction);
      loadActions();
      if (qs('#createTaskBtn')) qs('#createTaskBtn').addEventListener('click', createTask);
      listTasks();
      if (qs('#applyTargetsBtn')) qs('#applyTargetsBtn').addEventListener('click', applyTargetsAsAlerts);
      if (qs('#viewDeptTasksBtn')) qs('#viewDeptTasksBtn').addEventListener('click', ()=>{ const d = document.getElementById('deptSel').value||''; taskDeptFilter = d; showTab('Actions'); listTasks(); });
      if (qs('#exportCompliancePdfBtn')) qs('#exportCompliancePdfBtn').addEventListener('click', exportCompliancePdf);
      if (qs('#exportCsrdPdfBtn')) qs('#exportCsrdPdfBtn').addEventListener('click', exportCsrdPdf);
      if (qs('#exportIsoPdfBtn')) qs('#exportIsoPdfBtn').addEventListener('click', exportIsoPdf);
      if (qs('#exportJciPdfBtn')) qs('#exportJciPdfBtn').addEventListener('click', exportJciPdf);
      if (qs('#exportEsrsGapPdfBtn')) qs('#exportEsrsGapPdfBtn').addEventListener('click', exportEsrsGapPdf);
      if (qs('#emailEsrsGapBtn')) qs('#emailEsrsGapBtn').addEventListener('click', emailEsrsGap);
      if (qs('#serverEsrsPdfBtn')) qs('#serverEsrsPdfBtn').addEventListener('click', async ()=>{ try{ const r = await fetch(API_BASE+'/api/pdf/esrs-gap'); const b = await r.blob(); const u = URL.createObjectURL(b); const a = document.createElement('a'); a.href=u; a.download='esrs_gap_server.pdf'; a.click(); URL.revokeObjectURL(u) }catch(_){ } });
      if (qs('#serverDnshPdfBtn')) qs('#serverDnshPdfBtn').addEventListener('click', async ()=>{ try{ const r = await fetch(API_BASE+'/api/pdf/dnsh'); const b = await r.blob(); const u = URL.createObjectURL(b); const a = document.createElement('a'); a.href=u; a.download='dnsh_server.pdf'; a.click(); URL.revokeObjectURL(u) }catch(_){ } });
      if (qs('#serverCeoPdfBtn')) qs('#serverCeoPdfBtn').addEventListener('click', async ()=>{ try{ const r = await fetch(API_BASE+'/api/pdf/ceo-view'); const b = await r.blob(); const u = URL.createObjectURL(b); const a = document.createElement('a'); a.href=u; a.download='ceo_view.pdf'; a.click(); URL.revokeObjectURL(u) }catch(_){ } });
      if (qs('#serverCfoPdfBtn')) qs('#serverCfoPdfBtn').addEventListener('click', async ()=>{ try{ const r = await fetch(API_BASE+'/api/pdf/cfo-view'); const b = await r.blob(); const u = URL.createObjectURL(b); const a = document.createElement('a'); a.href=u; a.download='cfo_view.pdf'; a.click(); URL.revokeObjectURL(u) }catch(_){ } });
      if (qs('#calcSbtiBtn')) qs('#calcSbtiBtn').addEventListener('click', calcSbti);
      if (qs('#calcRoiBtn')) qs('#calcRoiBtn').addEventListener('click', calcRoi);
      if (qs('#saveEsrsBtn')) qs('#saveEsrsBtn').addEventListener('click', saveEsrs);
      if (qs('#listEsrsBtn')) qs('#listEsrsBtn').addEventListener('click', listEsrs);
      if (qs('#uploadFileBtn')) qs('#uploadFileBtn').addEventListener('click', uploadFile);
      if (qs('#listFilesBtn')) qs('#listFilesBtn').addEventListener('click', listFiles);
      if (qs('#syncDatasetBtn')) qs('#syncDatasetBtn').addEventListener('click', syncDataset);
      if (qs('#saveReadingBtn')) qs('#saveReadingBtn').addEventListener('click', saveReading);
      if (qs('#listReadingsBtn')) qs('#listReadingsBtn').addEventListener('click', listReadings);
      if (qs('#startStreamBtn')) qs('#startStreamBtn').addEventListener('click', startStream);
      if (qs('#stopStreamBtn')) qs('#stopStreamBtn').addEventListener('click', stopStream);
      if (qs('#calcTravelBtn')) qs('#calcTravelBtn').addEventListener('click', calcTravel);
      if (qs('#addTravelBtn')) qs('#addTravelBtn').addEventListener('click', addTravel);
      if (qs('#runPredictBtn')) qs('#runPredictBtn').addEventListener('click', runPredictFailure);
      if (qs('#listSessionsBtn')) qs('#listSessionsBtn').addEventListener('click', listSessions);
      if (qs('#saveDemoSessionBtn')) qs('#saveDemoSessionBtn').addEventListener('click', saveDemoSession);
      if (qs('#chatToggle')) qs('#chatToggle').addEventListener('click', toggleChat);
      if (qs('#providerSelect')) qs('#providerSelect').addEventListener('change', loadModels);
      if (qs('#modelSelect')) qs('#modelSelect').addEventListener('change', (e)=>{ chat.model = e.target.value; });
      if (qs('#attachFileBtn')) qs('#attachFileBtn').addEventListener('click', attachFile);
      if (qs('#sendChatBtn')) qs('#sendChatBtn').addEventListener('click', sendChat);
      if (qs('#saveChatBtn')) qs('#saveChatBtn').addEventListener('click', saveChat);
      loadModels();

      updateAuthUI();

      if (qs('#loadSettingsBtn')) qs('#loadSettingsBtn').addEventListener('click', loadSettings);
      if (qs('#saveSettingsBtn')) qs('#saveSettingsBtn').addEventListener('click', saveSettings);
      if (qs('#saveFactorProfileBtn')) qs('#saveFactorProfileBtn').addEventListener('click', saveFactorProfile);
      if (qs('#listFactorProfilesBtn')) qs('#listFactorProfilesBtn').addEventListener('click', listFactorProfiles);
      (async ()=>{ try{ const lib = await apiFetch('/api/eflib', { method:'GET' }); const arr = Array.isArray(lib.profiles)? lib.profiles: []; const el = document.getElementById('efActiveSel'); if (el){ el.innerHTML = arr.map(p=> `<option value=\"${p.name}\">${p.name}</option>`).join(''); const act = await apiFetch('/api/eflib/active', { method:'GET' }); el.value = act.name || (arr.length? arr[0].name : '') } }catch(_){ } })();
      if (qs('#saveEfActiveBtn')) qs('#saveEfActiveBtn').addEventListener('click', async ()=>{ try{ const name = document.getElementById('efActiveSel').value; await apiFetch('/api/eflib/active', { method:'POST', body: JSON.stringify({ name }) }); const lib = await apiFetch('/api/eflib', { method:'GET' }); const p = (lib.profiles||[]).find(x=> x.name===name); if (p){ settings.factors = { energy_kwh_to_tco2e: p.energy_kwh_to_tco2e, water_m3_to_tco2e: p.water_m3_to_tco2e, waste_kg_to_tco2e: p.waste_kg_to_tco2e, medw_kg_to_tco2e: p.medw_kg_to_tco2e }; qs('#settingsMsg').textContent = 'Active factors applied'; applyAll() } }catch(e){ qs('#settingsMsg').textContent = String(e.message||e) } })
      if (qs('#importEfCsvBtn')) qs('#importEfCsvBtn').addEventListener('click', async ()=>{ try{ const f = document.getElementById('efCsvFile').files[0]; if (!f) return; const text = await f.text(); const wb = XLSX.read(text, { type:'string' }); const ws = wb.Sheets[wb.SheetNames[0]]; const rows = XLSX.utils.sheet_to_json(ws); const profiles = rows.map(r=> ({ name: String(r.name||r.Name||r.PROFILE||'').trim(), energy_kwh_to_tco2e: +r.energy||+r.energy_kwh_to_tco2e||0, water_m3_to_tco2e: +r.water||+r.water_m3_to_tco2e||0, waste_kg_to_tco2e: +r.waste||+r.waste_kg_to_tco2e||0, medw_kg_to_tco2e: +r.medw||+r.medw_kg_to_tco2e||0 })).filter(p=> p.name); await apiFetch('/api/eflib/import',{ method:'POST', body: JSON.stringify({ profiles }) }); qs('#settingsMsg').textContent = 'Imported factors CSV'; }catch(e){ qs('#settingsMsg').textContent = String(e.message||e) } })
      if (qs('#validateEfCsvBtn')) qs('#validateEfCsvBtn').addEventListener('click', async ()=>{ try{ const f = document.getElementById('efCsvFile').files[0]; if (!f) return; const text = await f.text(); const wb = XLSX.read(text, { type:'string' }); const ws = wb.Sheets[wb.SheetNames[0]]; const rows = XLSX.utils.sheet_to_json(ws); const r = await apiFetch('/api/eflib/validate',{ method:'POST', body: JSON.stringify({ rows }) }); const issues = Array.isArray(r.issues)? r.issues: []; qs('#efValidateList').innerHTML = issues.length ? issues.slice(0,100).map(it=> `<div class="kpi"><div class="label">Row ${it.row}</div><div class="value">${it.col}</div><div class="delta">${it.msg}</div></div>`).join('') : '<div class="kpi"><div class="label">CSV OK</div><div class="value">No issues</div></div>' }catch(e){ qs('#efValidateList').textContent = String(e.message||e) } })
      if (qs('#downloadDefraCsvBtn')) qs('#downloadDefraCsvBtn').addEventListener('click', async ()=>{ try{ const r = await fetch(API_BASE+'/api/eflib/template?name=DEFRA'); const b = await r.blob(); const u = URL.createObjectURL(b); const a = document.createElement('a'); a.href=u; a.download='defra_factors.csv'; a.click(); URL.revokeObjectURL(u) }catch(_){ } })
      if (qs('#downloadEeaCsvBtn')) qs('#downloadEeaCsvBtn').addEventListener('click', async ()=>{ try{ const r = await fetch(API_BASE+'/api/eflib/template?name=EEA'); const b = await r.blob(); const u = URL.createObjectURL(b); const a = document.createElement('a'); a.href=u; a.download='eea_factors.csv'; a.click(); URL.revokeObjectURL(u) }catch(_){ } })
      (async ()=>{ try{ const lib = await apiFetch('/api/eflib', { method:'GET' }); const arr = Array.isArray(lib.profiles)? lib.profiles: []; const el = document.getElementById('mapProfile'); if (el){ el.innerHTML = arr.map(p=> `<option value="${p.name}">${p.name}</option>`).join('') } }catch(_){ } })();
      (async ()=>{ try{ const lib = await apiFetch('/api/eflib', { method:'GET' }); const arr = Array.isArray(lib.profiles)? lib.profiles: []; const el = document.getElementById('mapCountryProfile'); if (el){ el.innerHTML = arr.map(p=> `<option value="${p.name}">${p.name}</option>`).join('') } }catch(_){ } })();
      if (qs('#saveMapBtn')) qs('#saveMapBtn').addEventListener('click', async ()=>{ try{ const hospital = String(document.getElementById('mapHospital').value||'').trim(); const profile = document.getElementById('mapProfile').value; if (!hospital||!profile) return; await apiFetch('/api/eflib/map',{ method:'POST', body: JSON.stringify({ hospital, profile }) }); document.getElementById('mapHospital').value=''; listMaps() }catch(e){ qs('#settingsMsg').textContent = String(e.message||e) } })
      async function listMaps(){ try{ const j = await apiFetch('/api/eflib/map',{ method:'GET' }); const arr = Array.isArray(j.maps)? j.maps: []; qs('#mapsList').innerHTML = arr.length ? arr.map(m=> `<div class="kpi"><div class="label">${m.hospital}</div><div class="value">${m.profile}</div><div style="margin-top:6px"><button class="btn" data-delmap="${m.hospital}">Delete</button></div></div>`).join('') : '<div class="muted">No mappings'; Array.from(qs('#mapsList').querySelectorAll('button[data-delmap]')).forEach(b=> b.addEventListener('click', async ()=>{ const h = b.getAttribute('data-delmap'); await apiFetch('/api/eflib/map?hospital='+encodeURIComponent(h), { method:'DELETE' }); listMaps() })) }catch(e){ qs('#settingsMsg').textContent = String(e.message||e) }
      if (qs('#listMapsBtn')) qs('#listMapsBtn').addEventListener('click', listMaps)
      if (qs('#saveCountryMapBtn')) qs('#saveCountryMapBtn').addEventListener('click', async ()=>{ try{ const country = String(document.getElementById('mapCountry').value||'').trim(); const profile = document.getElementById('mapCountryProfile').value; if (!country||!profile) return; await apiFetch('/api/eflib/map-country',{ method:'POST', body: JSON.stringify({ country, profile }) }); document.getElementById('mapCountry').value=''; listCountryMaps() }catch(e){ qs('#settingsMsg').textContent = String(e.message||e) } })
      async function listCountryMaps(){ try{ const j = await apiFetch('/api/eflib/map-country',{ method:'GET' }); const arr = Array.isArray(j.maps)? j.maps: []; qs('#countryMapsList').innerHTML = arr.length ? arr.map(m=> `<div class="kpi"><div class="label">${m.country}</div><div class="value">${m.profile}</div><div style="margin-top:6px"><button class="btn" data-delcmap="${m.country}">Delete</button></div></div>`).join('') : '<div class="muted">No country mappings'; Array.from(qs('#countryMapsList').querySelectorAll('button[data-delcmap]')).forEach(b=> b.addEventListener('click', async ()=>{ const c = b.getAttribute('data-delcmap'); await apiFetch('/api/eflib/map-country?country='+encodeURIComponent(c), { method:'DELETE' }); listCountryMaps() })) }catch(e){ qs('#settingsMsg').textContent = String(e.message||e) }
      if (qs('#listCountryMapsBtn')) qs('#listCountryMapsBtn').addEventListener('click', listCountryMaps)
      if (qs('#saveGroupBtn')) qs('#saveGroupBtn').addEventListener('click', saveGroup);
      if (qs('#listGroupsBtn')) qs('#listGroupsBtn').addEventListener('click', listGroups);
      if (qs('#saveTemplateBtn')) qs('#saveTemplateBtn').addEventListener('click', saveTemplate);
      if (qs('#listTemplatesBtn')) qs('#listTemplatesBtn').addEventListener('click', listTemplates);
      if (qs('#saveEscRuleBtn')) qs('#saveEscRuleBtn').addEventListener('click', saveEscRule);
      if (qs('#listEscRulesBtn')) qs('#listEscRulesBtn').addEventListener('click', listEscRules);
      if (qs('#runEscNowBtn')) qs('#runEscNowBtn').addEventListener('click', runEscalationNow);
      if (qs('#listOutboxBtn')) qs('#listOutboxBtn').addEventListener('click', listOutbox);
      if (qs('#sendOutboxBtn')) qs('#sendOutboxBtn').addEventListener('click', sendOutbox);
      if (qs('#listSentBtn')) qs('#listSentBtn').addEventListener('click', listSent);
      if (qs('#saveSmtpBtn')) qs('#saveSmtpBtn').addEventListener('click', saveSmtp);
      if (qs('#loadSmtpBtn')) qs('#loadSmtpBtn').addEventListener('click', loadSmtp);
      if (qs('#loadHealthBtn')) qs('#loadHealthBtn').addEventListener('click', loadHealth);
      if (qs('#loadOpsSummaryBtn')) qs('#loadOpsSummaryBtn').addEventListener('click', loadOpsSummary);
      if (qs('#listOpsAlertsBtn')) qs('#listOpsAlertsBtn').addEventListener('click', listOpsAlerts);
      if (qs('#listOpsTicketsBtn')) qs('#listOpsTicketsBtn').addEventListener('click', listOpsTickets);
      if (qs('#genOpsTicketsBtn')) qs('#genOpsTicketsBtn').addEventListener('click', genOpsTickets);
      if (qs('#listBackupsBtn')) qs('#listBackupsBtn').addEventListener('click', listBackups);
      if (qs('#listBackupLogsBtn')) qs('#listBackupLogsBtn').addEventListener('click', listBackupLogs);
      if (qs('#runAdvisorBtn')) qs('#runAdvisorBtn').addEventListener('click', runAdvisor);
      if (qs('#runLLMAdvisorBtn')) qs('#runLLMAdvisorBtn').addEventListener('click', runLLMAdvisor);
      if (qs('#advisorPrefixPreset')) qs('#advisorPrefixPreset').addEventListener('change', ()=>{ const v = document.getElementById('advisorPrefixPreset').value||''; document.getElementById('advisorPrefix').value = v })
      if (qs('#loadOpsChartsBtn')) qs('#loadOpsChartsBtn').addEventListener('click', loadOpsCharts);
      if (qs('#genAdvisorPlanBtn')) qs('#genAdvisorPlanBtn').addEventListener('click', genAdvisorPlan);
      if (qs('#createOpsActionsBtn')) qs('#createOpsActionsBtn').addEventListener('click', createOpsActions);
      if (qs('#genRollbackCmdBtn')) qs('#genRollbackCmdBtn').addEventListener('click', genRollbackCmd);
      if (qs('#saveCarbonGroupBtn')) qs('#saveCarbonGroupBtn').addEventListener('click', saveCarbonGroup);
      if (qs('#listCarbonGroupsBtn')) qs('#listCarbonGroupsBtn').addEventListener('click', listCarbonGroups);
      if (qs('#saveQuotaBtn')) qs('#saveQuotaBtn').addEventListener('click', saveQuota);
      if (qs('#listQuotasBtn')) qs('#listQuotasBtn').addEventListener('click', listQuotas);
      if (qs('#saveCreditBtn')) qs('#saveCreditBtn').addEventListener('click', saveCredit);
      if (qs('#listCreditsBtn')) qs('#listCreditsBtn').addEventListener('click', listCredits);
      if (qs('#proposeTradeBtn')) qs('#proposeTradeBtn').addEventListener('click', proposeTrade);
      if (qs('#listTradesBtn')) qs('#listTradesBtn').addEventListener('click', listTrades);
      if (qs('#loadBalanceBtn')) qs('#loadBalanceBtn').addEventListener('click', loadBalance);
      if (qs('#saveInsuranceCfgBtn')) qs('#saveInsuranceCfgBtn').addEventListener('click', saveInsuranceCfg);
      if (qs('#loadInsuranceCfgBtn')) qs('#loadInsuranceCfgBtn').addEventListener('click', loadInsuranceCfg);
      if (qs('#calcInsuranceBtn')) qs('#calcInsuranceBtn').addEventListener('click', calcInsuranceImpact);
      if (qs('#saveWasteBaselineBtn')) qs('#saveWasteBaselineBtn').addEventListener('click', saveWasteBaseline);
      if (qs('#loadWasteBaselinesBtn')) qs('#loadWasteBaselinesBtn').addEventListener('click', loadWasteBaselines);
      if (qs('#runWasteAIBtn')) qs('#runWasteAIBtn').addEventListener('click', runWasteAIDept);
      if (qs('#wasteCreateTasksBtn')) qs('#wasteCreateTasksBtn').addEventListener('click', createWasteTasks);
      if (qs('#quickWasteAnalyzeBtn')) qs('#quickWasteAnalyzeBtn').addEventListener('click', quickWasteAnalyze);
      if (qs('#savePandCfgBtn')) qs('#savePandCfgBtn').addEventListener('click', savePandCfg);
      if (qs('#loadPandCfgBtn')) qs('#loadPandCfgBtn').addEventListener('click', loadPandCfg);
      if (qs('#runPandSimBtn')) qs('#runPandSimBtn').addEventListener('click', runPandSim);
      if (qs('#pandCreateTasksBtn')) qs('#pandCreateTasksBtn').addEventListener('click', createPandTasks);
      if (qs('#saveTwinCfgBtn')) qs('#saveTwinCfgBtn').addEventListener('click', saveTwinCfg);
      if (qs('#loadTwinCfgBtn')) qs('#loadTwinCfgBtn').addEventListener('click', loadTwinCfg);
      if (qs('#runTwinSimBtn')) qs('#runTwinSimBtn').addEventListener('click', runTwinSim);
      if (qs('#twinCreateTasksBtn')) qs('#twinCreateTasksBtn').addEventListener('click', createTwinTasks);
      if (qs('#saveCampusBtn')) qs('#saveCampusBtn').addEventListener('click', saveCampus);
      if (qs('#listCampusesBtn')) qs('#listCampusesBtn').addEventListener('click', listCampuses);
      if (qs('#saveCampusMetricBtn')) qs('#saveCampusMetricBtn').addEventListener('click', saveCampusMetric);
      if (qs('#listCampusMetricsBtn')) qs('#listCampusMetricsBtn').addEventListener('click', listCampusMetrics);
      if (qs('#aggCampusBtn')) qs('#aggCampusBtn').addEventListener('click', aggregateCampus);
      if (qs('#loadLeakageBtn')) qs('#loadLeakageBtn').addEventListener('click', loadLeakage);
      if (qs('#drawFlmDeptBtn')) qs('#drawFlmDeptBtn').addEventListener('click', drawFlmDeptChart);
      if (qs('#flmTopN')) qs('#flmTopN').addEventListener('change', drawFlmDeptChart);
      if (qs('#flmSortDir')) qs('#flmSortDir').addEventListener('change', drawFlmDeptChart);
      if (qs('#loadTopLeakageBtn')) qs('#loadTopLeakageBtn').addEventListener('click', loadTopLeakage);
      if (qs('#loadTaxonomyBtn')) qs('#loadTaxonomyBtn').addEventListener('click', loadTaxonomy);
      if (qs('#loadAlignmentsBtn')) qs('#loadAlignmentsBtn').addEventListener('click', loadTaxonomyAlignments)
      if (qs('#loadProjectsBtn')) qs('#loadProjectsBtn').addEventListener('click', loadGdProjects)
      if (qs('#loadConnectorsBtn')) qs('#loadConnectorsBtn').addEventListener('click', loadConnectors);
      if (qs('#loadRiskHeatmapBtn')) qs('#loadRiskHeatmapBtn').addEventListener('click', loadRiskHeatmap);
      if (qs('#loadDoctorPerfBtn')) qs('#loadDoctorPerfBtn').addEventListener('click', loadDoctorPerf);
      if (qs('#saveDrugBtn')) qs('#saveDrugBtn').addEventListener('click', saveDrug);
      if (qs('#listDrugsBtn')) qs('#listDrugsBtn').addEventListener('click', listDrugs);
      if (qs('#calcUsageBtn')) qs('#calcUsageBtn').addEventListener('click', calcDrugUsage);
      if (qs('#suggestAltBtn')) qs('#suggestAltBtn').addEventListener('click', suggestDrugAlt);
      if (qs('#setRoleBtn')) qs('#setRoleBtn').addEventListener('click', setRole);
      if (qs('#listUsersBtn')) qs('#listUsersBtn').addEventListener('click', listUsers);
      if (qs('#saveSecBtn')) qs('#saveSecBtn').addEventListener('click', saveSec);
      if (qs('#loadSecBtn')) qs('#loadSecBtn').addEventListener('click', loadSec);
      if (qs('#saveSourceBtn')) qs('#saveSourceBtn').addEventListener('click', saveSource);
      if (qs('#listSourcesBtn')) qs('#listSourcesBtn').addEventListener('click', listSources);
      if (qs('#downloadFeatureMatrixBtn')) qs('#downloadFeatureMatrixBtn').addEventListener('click', async ()=>{ try{ const r = await fetch(API_BASE+'/api/feature-matrix.csv'); const b = await r.blob(); const u = URL.createObjectURL(b); const a = document.createElement('a'); a.href=u; a.download='ZeroAtHospital_Enterprise_Feature_Matrix_v1.csv'; a.click(); URL.revokeObjectURL(u) }catch(_){ } });
      if (qs('#downloadFeatureMatrixV2Btn')) qs('#downloadFeatureMatrixV2Btn').addEventListener('click', async ()=>{ try{ const r = await fetch(API_BASE+'/api/feature-matrix-v2.csv'); const b = await r.blob(); const u = URL.createObjectURL(b); const a = document.createElement('a'); a.href=u; a.download='ZeroAtHospital_Ultra_Enterprise_Feature_Matrix_v2.csv'; a.click(); URL.revokeObjectURL(u) }catch(_){ } });

      // live controls
      qs('#liveStartBtn').addEventListener('click', liveStart);
      qs('#liveStopBtn').addEventListener('click', liveStop);
      qs('#liveIntervalSel').addEventListener('change', (e)=>{ live.intervalMs = +e.target.value; if (live.timer){ liveStop(); liveStart(); } });
      qs('#liveWindowInput').addEventListener('change', (e)=>{ live.windowSize = Math.max(5, Math.min(120, +e.target.value||15)); while(live.points.length > live.windowSize) live.points.shift(); updateLiveUI(); });

      seedLiveBase();
      loadPilotDemo().then(()=>{ populateFilters(); applyAll(); }).catch(()=>{})
      if (qs('#taxonomyRefreshBtn')) qs('#taxonomyRefreshBtn').addEventListener('click', ()=>{ loadTaxonomyData(); updateEnvTagForTaxonomy(); })
      const tc = document.getElementById('taxonomy-campus-select'); if (tc) tc.addEventListener('change', renderTaxonomyView)
      loadTaxonomyData(); updateEnvTagForTaxonomy();

      // ---------------- Self-tests ----------------
      const results = [];
      const ok = (name, cond)=>{ results.push({test:name, pass:!!cond}); if(!cond) console.error('❌ Test failed:', name); };
      try {
        ok('data loaded', Array.isArray(state.data) && state.data.length >= 1);
        ok('filtered returns array', Array.isArray(filtered()));
        ok('i18n applies', typeof t('kpi_title')==='string');
        showTab('Live');
        ok('live started', !!live.timer);
        ok('live chart exists after tick', !!state.liveChart || (liveTick(), !!state.liveChart));
        showTab('Main');
        ok('live stopped on Main', !live.timer);
        console.table(results);
      } catch (err) { console.error('Self-tests error:', err); }
    });

    // expose saveNew for inline button
    window.saveNew = saveNew;
    let TAXONOMY_DATA = null;
    async function loadTaxonomyData(){ try{ const r = await apiFetch('/api/eu/taxonomy',{ method:'GET' }); TAXONOMY_DATA = Array.isArray(r.campuses)? r.campuses : []; populateTaxonomyCampusSelect(); renderTaxonomyView(); }catch(_){ } }
    function populateTaxonomyCampusSelect(){ const sel = document.getElementById('taxonomy-campus-select'); if (!sel || !Array.isArray(TAXONOMY_DATA)) return; sel.innerHTML=''; TAXONOMY_DATA.forEach(c=>{ const opt = document.createElement('option'); opt.value = c.campus_id; opt.textContent = c.legal_entity || c.campus_id; sel.appendChild(opt); }); }
    function setText(id, value){ const el = document.getElementById(id); if (el) el.textContent = (value===undefined||value===null)? '–' : value }
    function pct(v){ if (v===undefined||v===null) return '–'; const n = Number(v); const val = n<=1? n*100 : n; return val.toFixed(0)+' %' }
    async function updateEnvTagForTaxonomy(){ const tag = document.getElementById('taxonomy-env-tag'); if (!tag) return; try{ const h = await apiFetch('/api/health',{ method:'GET' }); const env = (h.app&&h.app.env)||'prod'; tag.textContent = 'ENV: '+env; tag.className = env==='staging'? 'pill warn' : 'pill ok'; }catch(_){ tag.textContent = 'ENV: n/a'; tag.className = 'pill bad'; } }
    function renderTaxonomyView(){ if (!Array.isArray(TAXONOMY_DATA)||!TAXONOMY_DATA.length) return; const sel = document.getElementById('taxonomy-campus-select'); if (!sel) return; const id = sel.value || TAXONOMY_DATA[0].campus_id; const campus = TAXONOMY_DATA.find(c=> c.campus_id===id) || TAXONOMY_DATA[0]; setText('kpi-eligible-revenue', pct(campus.taxonomy_eligible_revenue_pct)); setText('kpi-aligned-revenue', pct(campus.taxonomy_aligned_revenue_pct)); setText('kpi-aligned-capex', pct(campus.taxonomy_aligned_capex_pct)); setText('kpi-esrs-gap', campus.esrs_gap_score!=null? String(campus.esrs_gap_score): '–'); const pill = document.getElementById('taxonomy-dnsh-pill'); if (pill){ const status = String(campus.dns_h_status||'n/a'); pill.textContent = 'DNSH: '+status.toUpperCase(); pill.className = 'pill '+(status==='green'?'ok':status==='amber'?'warn':status==='red'?'bad':''); } const dnshList = document.getElementById('taxonomy-dnsh-notes'); if (dnshList){ dnshList.innerHTML=''; (campus.dns_h_notes||[]).forEach(n=>{ const li=document.createElement('li'); li.textContent=n; dnshList.appendChild(li); }); } setText('taxonomy-cbam-share', pct(campus.cbam_exposed_share_pct)); const cbamList = document.getElementById('taxonomy-cbam-channels'); if (cbamList){ cbamList.innerHTML=''; (campus.cbam_channels||[]).forEach(ch=>{ const li=document.createElement('li'); li.textContent=ch; cbamList.appendChild(li); }); } const actions = document.getElementById('taxonomy-priority-actions'); if (actions){ actions.innerHTML=''; (campus.priority_actions_12m||[]).forEach(a=>{ const li=document.createElement('li'); li.textContent=a; actions.appendChild(li); }); } }

    async function loadTaxonomyAlignments(){ try{ const r = await apiFetch('/api/eu/taxonomy/alignments',{ method:'GET' }); const arr = Array.isArray(r.campuses)? r.campuses: []; const box = qs('#alignmentsList'); if (box){ box.innerHTML = arr.map(a=> `<div class="kpi"><div class="label">${a.campus_id}</div><div class="value">Aligned Rev ${Math.round((a.taxonomy_aligned_revenue_pct||0)*100)}% · Capex ${Math.round((a.taxonomy_aligned_capex_pct||0)*100)}%</div><div class="delta">DNSH ${String(a.dns_h_status||'—')} · ESRS gap ${a.esrs_gap_score||'—'}</div></div>`).join('') } }catch(e){ const box = qs('#alignmentsList'); if (box) box.textContent = String(e.message||e) } }
    async function loadGdProjects(){ try{ const r = await apiFetch('/api/gd/projects',{ method:'GET' }); const arr = Array.isArray(r.projects)? r.projects: []; const box = qs('#projectsList'); if (box){ box.innerHTML = arr.map(p=> `<div class="kpi"><div class="label">${p.campus_id}</div><div class="value">${p.name}</div><div class="delta">Capex ₺${p.capex_million_try}m · CO₂e ↓ ${p.expected_annual_co2e_reduction_t||p.expected_annual_mwh||'—'}</div></div>`).join('') } }catch(e){ const box = qs('#projectsList'); if (box) box.textContent = String(e.message||e) } }
    async function loadCfoSavings(){ try{ const h = document.getElementById('hospSel').value||''; const r = await apiFetch('/api/finance/savings',{ method:'POST', body: JSON.stringify({ hospital: h }) }); const box = qs('#leakageBox'); if (box){ box.innerHTML = `<div class="kpi"><div class="label">Current Cost</div><div class="value">${r.currency} ${r.current_cost}</div></div><div class="kpi"><div class="label">Potential Savings</div><div class="value">${r.currency} ${r.potential_savings}</div></div>` } }catch(_){ } }
    async function loadRiskMatrix(){ try{ const r = await apiFetch('/api/risk/matrix',{ method:'GET' }); const arr = Array.isArray(r.campuses)? r.campuses: []; const box = qs('#alertsTriggers'); if (box){ box.innerHTML = arr.map(c=> `<div class="kpi"><div class="label">${c.campus_id}</div><div class="value">JCI ${c.jci}</div><div class="delta">ESRS ${c.esrs} · DNSH ${c.dnsh}</div></div>`).join('') } }catch(_){ } }
    async function loadSeasonality(){ try{ const h = document.getElementById('hospSel').value||''; const r = await apiFetch('/api/seasonality'+(h? ('?hospital='+encodeURIComponent(h)) : ''),{ method:'GET' }); window.__seasonWeights = (r && r.weights && Array.isArray(r.weights)) ? r.weights : null; renderCharts() }catch(_){ } }

  })();
  </script>
</body>
</html>
